var NO_JQUERY={};
(function(a,c,m){if(!("console"in a)){var p=a.console={};p.log=p.warn=p.error=p.debug=function(){}}c===NO_JQUERY&&(c={fn:{},extend:function(){for(var b=arguments[0],e=1,d=arguments.length;e<d;e++){var g=arguments[e],f;for(f in g)b[f]=g[f]}return b}});c.fn.pm=function(){console.log("usage: \nto send: $.pm(options)\nto receive: $.pm.bind(type, fn, [origin])");return this};c.pm=a.pm=function(b){h.send(b)};c.pm.bind=a.pm.bind=function(b,e,d,g,f){h.bind(b,e,d,g,!0===f)};c.pm.unbind=a.pm.unbind=function(b,
e){h.unbind(b,e)};c.pm.origin=a.pm.origin=null;c.pm.poll=a.pm.poll=200;var h={send:function(b){b=c.extend({},h.defaults,b);var e=b.target;if(b.target)if(b.type){var d={data:b.data,type:b.type};b.success&&(d.callback=h._callback(b.success));b.error&&(d.errback=h._callback(b.error));"postMessage"in e&&!b.hash?(h._bind(),e.postMessage(JSON.stringify(d),b.origin||"*")):(h.hash._bind(),h.hash.send(b,d))}else console.warn("postmessage type required");else console.warn("postmessage target window required")},
bind:function(b,e,d,g,f){h._replyBind(b,e,d,g,f)},_replyBind:function(b,e,d,g,f){"postMessage"in a&&!g?h._bind():h.hash._bind();g=h.data("listeners.postmessage");g||(g={},h.data("listeners.postmessage",g));var l=g[b];l||(l=[],g[b]=l);l.push({fn:e,callback:f,origin:d||c.pm.origin})},unbind:function(b,e){var d=h.data("listeners.postmessage");if(d)if(b)if(e){var g=d[b];if(g){for(var f=[],l=0,t=g.length;l<t;l++){var q=g[l];q.fn!==e&&f.push(q)}d[b]=f}}else delete d[b];else for(l in d)delete d[l]},data:function(b,
e){return e===m?h._data[b]:h._data[b]=e},_data:{},_CHARS:"0123456789ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz".split(""),_random:function(){for(var b=[],e=0;32>e;e++)b[e]=h._CHARS[0|32*Math.random()];return b.join("")},_callback:function(b){var e=h.data("callbacks.postmessage");e||(e={},h.data("callbacks.postmessage",e));var d=h._random();e[d]=b;return d},_bind:function(){h.data("listening.postmessage")||(a.addEventListener?a.addEventListener("message",h._dispatch,!1):a.attachEvent&&a.attachEvent("onmessage",
h._dispatch),h.data("listening.postmessage",1))},_dispatch:function(b){try{var e=JSON.parse(b.data)}catch(t){console.warn("postmessage data invalid json: ",t);return}if(e.type){var d=(h.data("callbacks.postmessage")||{})[e.type];if(d)d(e.data);else{d=(h.data("listeners.postmessage")||{})[e.type]||[];for(var g=0,f=d.length;g<f;g++){var l=d[g];if(l.origin&&"*"!==l.origin&&b.origin!==l.origin)console.warn("postmessage message origin mismatch",b.origin,l.origin),e.errback&&h.send({target:b.source,data:{message:"postmessage origin mismatch",
origin:[b.origin,l.origin]},type:e.errback});else{function t(q){e.callback&&h.send({target:b.source,data:q,type:e.callback})}try{l.callback?l.fn(e.data,t,b):t(l.fn(e.data,b))}catch(q){if(e.errback)h.send({target:b.source,data:q,type:e.errback});else throw q;}}}}}else console.warn("postmessage message type required")},hash:{send:function(b,e){var d=b.target;if(b=b.url){b=h.hash._url(b);var g=h.hash._url(a.location.href);if(a==d.parent)var f="parent";else try{for(var l=0,t=parent.frames.length;l<t;l++)if(parent.frames[l]==
a){f=l;break}}catch(q){f=a.name}null==f?console.warn("postmessage windows must be direct parent/child windows and the child must be available through the parent window.frames list"):(e={"x-requested-with":"postmessage",source:{name:f,url:g},postmessage:e},f="#x-postmessage-id="+h._random(),d.location=b+f+encodeURIComponent(JSON.stringify(e)))}else console.warn("postmessage target window url is required")},_regex:/^#x\-postmessage\-id=(\w{32})/,_regex_len:50,_bind:function(){h.data("polling.postmessage")||
(setInterval(function(){var b=""+a.location.hash,e=h.hash._regex.exec(b);e&&(e=e[1],h.hash._last!==e&&(h.hash._last=e,h.hash._dispatch(b.substring(h.hash._regex_len))))},c.pm.poll||200),h.data("polling.postmessage",1))},_dispatch:function(b){if(b){try{if(b=JSON.parse(decodeURIComponent(b)),!("postmessage"===b["x-requested-with"]&&b.source&&null!=b.source.name&&b.source.url&&b.postmessage))return}catch(x){return}var e=b.postmessage,d=(h.data("callbacks.postmessage")||{})[e.type];if(d)d(e.data);else{var g=
"parent"===b.source.name?a.parent:a.frames[b.source.name];d=(h.data("listeners.postmessage")||{})[e.type]||[];for(var f=0,l=d.length;f<l;f++){var t=d[f];if(t.origin){var q=/https?:\/\/[^\/]*/.exec(b.source.url)[0];if("*"!==t.origin&&q!==t.origin){console.warn("postmessage message origin mismatch",q,t.origin);e.errback&&h.send({target:g,data:{message:"postmessage origin mismatch",origin:[q,t.origin]},type:e.errback,hash:!0,url:b.source.url});continue}}function x(u){e.callback&&h.send({target:g,data:u,
type:e.callback,hash:!0,url:b.source.url})}try{t.callback?t.fn(e.data,x):x(t.fn(e.data))}catch(u){if(e.errback)h.send({target:g,data:u,type:e.errback,hash:!0,url:b.source.url});else throw u;}}}}},_url:function(b){return(""+b).replace(/#.*$/,"")}}};c.extend(h,{defaults:{target:null,url:null,type:null,data:null,success:null,error:null,origin:"*",hash:!1}})})(this,"undefined"===typeof jQuery?NO_JQUERY:jQuery);"JSON"in window&&window.JSON||(JSON={});
(function(){function a(f){return 10>f?"0"+f:f}function c(f){h.lastIndex=0;return h.test(f)?'"'+f.replace(h,function(l){var t=d[l];return"string"===typeof t?t:"\\u"+("0000"+l.charCodeAt(0).toString(16)).slice(-4)})+'"':'"'+f+'"'}function m(f,l){var t=b,q=l[f];q&&"object"===typeof q&&"function"===typeof q.toJSON&&(q=q.toJSON(f));"function"===typeof g&&(q=g.call(l,f,q));switch(typeof q){case "string":return c(q);case "number":return isFinite(q)?String(q):"null";case "boolean":case "null":return String(q);
case "object":if(!q)return"null";b+=e;var x=[];if("[object Array]"===Object.prototype.toString.apply(q)){var u=q.length;for(f=0;f<u;f+=1)x[f]=m(f,q)||"null";l=0===x.length?"[]":b?"[\n"+b+x.join(",\n"+b)+"\n"+t+"]":"["+x.join(",")+"]";b=t;return l}if(g&&"object"===typeof g)for(u=g.length,f=0;f<u;f+=1){var r=g[f];"string"===typeof r&&(l=m(r,q))&&x.push(c(r)+(b?": ":":")+l)}else for(r in q)Object.hasOwnProperty.call(q,r)&&(l=m(r,q))&&x.push(c(r)+(b?": ":":")+l);l=0===x.length?"{}":b?"{\n"+b+x.join(",\n"+
b)+"\n"+t+"}":"{"+x.join(",")+"}";b=t;return l}}"function"!==typeof Date.prototype.toJSON&&(Date.prototype.toJSON=function(f){return this.getUTCFullYear()+"-"+a(this.getUTCMonth()+1)+"-"+a(this.getUTCDate())+"T"+a(this.getUTCHours())+":"+a(this.getUTCMinutes())+":"+a(this.getUTCSeconds())+"Z"},String.prototype.toJSON=Number.prototype.toJSON=Boolean.prototype.toJSON=function(f){return this.valueOf()});var p=/[\u0000\u00ad\u0600-\u0604\u070f\u17b4\u17b5\u200c-\u200f\u2028-\u202f\u2060-\u206f\ufeff\ufff0-\uffff]/g,
h=/[\\"\x00-\x1f\x7f-\x9f\u00ad\u0600-\u0604\u070f\u17b4\u17b5\u200c-\u200f\u2028-\u202f\u2060-\u206f\ufeff\ufff0-\uffff]/g,b,e,d={"\b":"\\b","\t":"\\t","\n":"\\n","\f":"\\f","\r":"\\r",'"':'\\"',"\\":"\\\\"},g;"function"!==typeof JSON.stringify&&(JSON.stringify=function(f,l,t){var q;e=b="";if("number"===typeof t)for(q=0;q<t;q+=1)e+=" ";else"string"===typeof t&&(e=t);if((g=l)&&"function"!==typeof l&&("object"!==typeof l||"number"!==typeof l.length))throw Error("JSON.stringify");return m("",{"":f})});
"function"!==typeof JSON.parse&&(JSON.parse=function(f,l){function t(q,x){var u,r=q[x];if(r&&"object"===typeof r)for(u in r)if(Object.hasOwnProperty.call(r,u)){var n=t(r,u);void 0!==n?r[u]=n:delete r[u]}return l.call(q,x,r)}p.lastIndex=0;p.test(f)&&(f=f.replace(p,function(q){return"\\u"+("0000"+q.charCodeAt(0).toString(16)).slice(-4)}));if(/^[\],:{}\s]*$/.test(f.replace(/\\(?:["\\\/bfnrt]|u[0-9a-fA-F]{4})/g,"@").replace(/"[^"\\\n\r]*"|true|false|null|-?\d+(?:\.\d*)?(?:[eE][+\-]?\d+)?/g,"]").replace(/(?:^|:|,)(?:\s*\[)+/g,
"")))return f=eval("("+f+")"),"function"===typeof l?t({"":f},""):f;throw new SyntaxError("JSON.parse");})})();(function(a){a.wa_blog.editor={options:{blogs:{},content_id:"post_text",current_blog_id:null,dateMonthCount:2,dateShowWeek:!1,cut_link_label_default:"",version:"1.0"},transliterated:!1,blog_statuses:{"private":"private","public":"public"},reInit(){this.init(this.options)},init:function(c){function m(d){var g=d.siblings(".hint:first");0>=g.length&&(g=d.parent().siblings(".hint:first"));return g}function p(d){d.parent().find("input[type=text]").removeClass("error");m(d).removeClass("errormsg")}function h(d){d.parent().find("input[type=text]").addClass("error");
m(d).addClass("errormsg")}function b(){return a.datepicker._defaults.dateFormat.toUpperCase().replace("YY","YYYY")}var e=this;e.options=a.extend(e.options,c);e.postUrlWidget=function(){function d(n,v,y,z){var A=null,D={post_title:y,post_id:v,blog_id:n},E=[n,v].join("&");!x[E]||!q&&y?(q&&(D.slug=q),a.ajax({url:"?module=post&action=getPostUrl",data:D,dataType:"json",type:"post",async:!1,success:function(B){A=B.data;x[E]=A;a.wa_blog.editor.transliterated=!0;z(A)}})):z(x[E])}function g(n){a("#pure-url").text(n.link);
a("#preview-url").data("preview-url",n.preview_link);n.slug&&!q?(a("#post-url").val(n.slug),q=n.slug):a("#post-url").val(q);var v=n.is_adding?"small":n.is_published?"small":"hint",y=a("#post-url-field span:first").contents().filter(function(){return 3==this.nodeType}).get(0).nodeValue;if(n.other_links&&n.other_links instanceof Array){var z=[];for(k in n.other_links)z.push({previewText:y,className:v,slug:q,link:n.other_links[k],preview_link:n.other_preview_links[k],href:n.preview_hash?n.other_links[k]+
q+"/?preview="+n.preview_hash:n.other_links[k]+q+"/"});n=n.is_adding?'<span class="${className}">${previewText}${link}<span class="slug">{{if slug}}${slug}/{{/if}}</span></span><br>':'<span class="${className}">${previewText}<a target="_blank" href="${href}" data-preview-url="${preview_link}">${link}<span class="slug">{{if slug}}${slug}/{{/if}}</span></a></span><br>';v=a("#post-url-field").children(":first");if(v.is(".fas")||v.is("[data-icon]"))n=v.get(0).outerHTML+n;a("#other-urls").html(a.tmpl(n,
z))}}function f(n){n=n||"hidden";"empty"==n?a("#post-url-field-no-settlements").show("fast"):a("#post-url-field-no-settlements").hide("fast");q=null;a("#post-url").val("");a("#post-url-field").hide("fast").trigger(a.Event("change",{status:n}))}function l(n,v){n&&(q=n);a(".slug").each(function(){if(q){var y=a(this).text(q+"/").parents("a:first");y.attr("href",y.text()+(v?"?preview="+v:""))}else a(this).text("")})}function t(){a("#url-editable").hide();a("#url-edit").show();a("#post-url").focus()}var q=
null,x={},u=function(){},r={};(function(){var n=u=function(){if(a("#post-url-field").length){var v=a("#post-title").val(),y=a("input[name=blog_id]").val();if(r[y]&&r[y].no_frontend)v?f("empty"):f("hidden_empty");else{v||f("hidden");var z=a("input[name=post_id]").val();d(y,z,v,function(A){A&&(r[y]||(r[y]={id:y,no_frontend:A.is_private_blog||!A.link}),r[y].no_frontend?v?f("empty"):f("hidden_empty"):v?(a("#post-url-field-no-settlements").hide("fast"),A&&g(A),a("#post-url-field").show("fast").trigger(a.Event("change",
{status:"visible"}))):(g(A),f("hidden")))})}}else f("empty")};a("#post-title").blur(n);a("#post-form").find("input[name=post_id]").val()&&n();a("#url-edit-link").click(t);a("#post-url").keyup(function(v){9!=v.keyCode&&this.value!=q&&l(this.value)})})();return{setEditReady:t,resetEditReady:function(){a("#url-editable").show();a("#url-edit").hide()},updateSlugs:l,changeBlog:u}}();e.inlineSaveController=function(d){function g(){!1!==x()&&f(u)}function f(r){var n=a.wa_blog.editor.wysiwygToHtml(a("#post_text",
"#post-form").val());a("#post_text","#post-form").val(n);n=a("#post-form").serialize()+"&"+t+"=1";n+=q?"&inline=1":"";n+=a.wa_blog.editor.transliterated?"":"&transliterate=1";a.wa_blog.editor.currentDialog&&"b-post-edit-custom-params-dialog"===a.wa_blog.editor.currentDialog.$wrapper.attr("id")&&(n+="&"+a.wa_blog.editor.currentDialog.$wrapper.find("[name]").serialize());r=r||function(){};l("loading");a.ajax({url:"?module=post&action=save",data:n,dataType:"json",type:"post",success:function(v){if("fail"==
v.status){v.errors.datetime||a.wa_blog.editor.closeCurrentDialog();var y=v.errors;if(y.url){a("#post-url-field").show();var z=a("#post-url"),A=y.url,D="#message-"+z.attr("id");z.addClass("error");a(D).addClass("errormsg").text(A)}y.datetime&&(y=a(".datepicker:not(:disabled)"),y.length&&h(y));v.errors.datetime||"deadline"!=t||((v=a("#deadline-dialog .datepicker").val())?a("#publication-deadline-changable-part").html(a.tmpl("publication-deadline-setted",{date:v})):a("#publication-deadline-changable-part").html(a.tmpl("publication-deadline-setted")),
a("#b-post-save-draft-button").attr("name","deadline"))}else v.data.redirect?location.href=v.data.redirect+"&is_created=1":(r(v.data),v.data.id&&a("#post-id").val(v.data.id),l("saved"));q=!1;l("")},error:function(v,y,z){}})}function l(r,n){r?(a("#form-status span").hide(),a("#form-status #"+r+"-status").show(),a("#form-status").show()):a("#form-status").fadeOut(n&&"function"==typeof n?n:function(){})}d=d||{};var t="",q=!1,x=d.beforeSave||function(){},u=d.afterSave||function(){};(function(){a(document).on("click",
"[type=submit], input[type=button], a.js-submit",function(){function r(){!a("#post-id").val()||"b-post-save-button"!=this.id&&"b-post-save-draft-button"!=this.id&&"b-post-save-custom-params"!=this.id||(q=!0);t=this.name;"deadline"!=t&&"schedule"!=t||a("#"+this.name+"-dialog").find("input[name^=datetime]").attr("disabled",!1);g()}if(a(this).hasClass("dialog-edit"))return!1;if(a(this).hasClass("js-submit")){const n=this,v=a(n).attr("title")||a(n).text()||"Are you sure?";a.waDialog.confirm({text:v,success_button_title:a.wa.locale.Confirm,
success_button_class:"danger",cancel_button_title:a.wa.locale.Cancel,cancel_button_class:"light-gray",onSuccess(){r&&r.apply(n)}});return!1}r.apply(this)});a("#post-url").focus(function(){})})();return{save:g,setAction:function(r){t=r},getAction:function(){return t}}}({beforeSave:function(){var d=a(".datepicker:not(:disabled)"),g=!0;if(0<d.length){var f=d.parent(".datetime").find(".time");if(0<f.length){var l;if(l=f.get(0))l=f.eq(0).val(),l=!(0<=l&&24>=l);l&&(g=!1);if(l=f.get(1))f=f.eq(1).val(),l=
!(0<=f&&60>=f);l&&(g=!1)}g||h(d)}if(!g)return!1;a.wa_blog.editor.onSubmit()},afterSave:function(d){a("#b-post-save-button").removeClass("yellow").addClass("blue");a("#postpublish-edit").removeClass("yellow").addClass("blue");e.postUrlWidget.resetEditReady();e.postUrlWidget.updateSlugs(d.url,d.preview_hash||!1);var g=a("#inline-edit-datetime").get(0),f=d.formatted_datetime;a(g).show();a(g).parent().find(".datetime").hide();f&&a("#current-time").text(f);a("#current-time").show();"draft"==e.inlineSaveController.getAction()&&
a("#post-url-field .small").removeClass("small").addClass("hint");g=d?.meta?.title;f=d?.meta?.keywords;const l=d?.meta?.description;d=d?.params;const t=a("#b-post-edit-custom-params-dialog");t.find(":input[name=meta_description]").val(l);t.find(":input[name=params]").val(d);g?(a("#b-post-edit-meta-title").show().find(".val").text(g),t.find(":input[name=meta_title]").val(g)):a("#b-post-edit-meta-title").hide();f?(a("#b-post-edit-meta-keywords").show().find(".val").text(f),t.find(":input[name=meta_keywords]").val(f)):
a("#b-post-edit-meta-keywords").hide();l?(a("#b-post-edit-meta-description").show().find(".val").text(l),t.find(":input[name=meta_description]").val(l)):a("#b-post-edit-meta-description").hide();d?(a("#b-post-edit-custom-params").show().html(d.trim().split("\n").join("<br>")+"<br>"),t.find(":input[name=params]").val(d)):a("#b-post-edit-custom-params").hide();g||f||l||d?a("#b-post-edit-no-meta").hide():a("#b-post-edit-no-meta").show()}});(function(d){d={changeMonth:!0,changeYear:!0,shortYearCutoff:2,
showOtherMonths:2>d.dateMonthCount,selectOtherMonths:2>d.dateMonthCount,stepMonths:d.dateMonthCount,numberOfMonths:d.dateMonthCount,showWeek:d.dateShowWeek,gotoCurrent:!0,constrainInput:!1,beforeShow:function(){setTimeout(function(){10>a("#ui-datepicker-div").css("z-index")&&a("#ui-datepicker-div").css("z-index",10)},0)}};a(".datepicker").datepicker(d).filter("input[name^=schedule_datetime]").datepicker("option","minDate",new Date);a("#ui-datepicker-div").hide();a(".datepicker").on("focus",function(){p(a(this))})})(e.options);
(function(){function d(){var f=a(this).attr("id").replace(/-.*$/,"");g[f]?.length||(g[f]=a("#"+f+"-dialog").detach());a.wa_blog.editor.currentDialog=a.waDialog({$wrapper:g[f],append_to:a(this).closest("form"),onOpen:function(l){l.find("input,select").removeAttr("disabled");a(".user-date-format").text(b())},onClose:function(l){a(this).find("input:text,select").each(function(t){a(this).value=a(this).defaultValue;a(this).attr("disabled","disabled")});if("schedule"===f)return l.hide(),!1}});return!1}
const g={};a(".dialog-edit").each(function(){a(this).on("click",function(f){f.preventDefault();return d.call(f.target)})})})();c=null;try{c=localStorage.getItem("blog/editor")||"redactor",c=c.replaceAll('"',"")}catch(d){this.log("Exception: "+d.message+"\nline: "+d.fileName+":"+d.lineNumber)}if(!c||!this.editors[c])for(c in this.editors)break;if(!this.selectEditor(c,!0))for(c in this.editors)if(this.selectEditor(c,!0))break;a("#post-form").find("input[name=post_id]").val()||a("#post-title").focus();
a(".change-blog").click(a.wa_blog.editor.changeBlogHandler);a(document).on("change",'#postpublish-dialog input[name="publish_blog_id"]',a.wa_blog.editor.changePublishBlogHandler);a("#post-title").keyup(function(){var d=a(this),g=d.next(".maxlength"),f=parseInt(d.attr("maxlength"));f&&d.val().length>=f&&!g.length?d.after('<em class="hint maxlength">'+$_("input_maxlength").replace(/%d/,f)+"</em>"):(!f||d.val().length<f)&&g.length&&g.remove()});a("#inline-edit-datetime").click(function(){a(this).hide();
a(this).parent().find(".datetime").show();a("#current-time").hide();a(".user-date-format").text(b())});a(".b-post-editor-toggle li a").click(this.handleToggleEditor);a(document).keydown(function(d){if(d.ctrlKey&&83==d.keyCode)e.onSaveHotkey(d)});a(".time").focus(function(){p(a(this).parent().find(".datepicker"))});a("#post-form").submit(function(){return!1});a("#b-post-edit-custom-params-link").on("click",function(){a.waDialog({$wrapper:a("#b-post-edit-custom-params-dialog").clone(),append_to:"#post-form",
onOpen(d,g){a.wa_blog.editor.currentDialog=g;d.find('[type="button"]').on("click",function(){g.close();a.wa_blog.editor.currentDialog=null})}});return!1});(function(){function d(w){u[0]?.contentWindow&&a.pm({target:u[0].contentWindow,type:"update_title",data:w})}function g(){var w=l();w&&w!=u.attr("src")&&(u.attr("src",w),u.one("load",function(){}))}function f(w){return w.data("preview-url")||""}function l(){var w=null;a("#post-url-field a").each(function(){var C=f(a(this));if(C&&"javascript:"!=C.substr(0,
11)){if(u.attr("src")==C)return w=null,!1;w=C}});w||(w=u.attr("src"),"about:blank"==w&&(w=null));w&&(w+=0<=w.indexOf("?")?"&":"?",w+="parent_url="+encodeURIComponent(location.origin));return w}function t(){!a("#post-url-field-no-settlements").is(":visible")&&l()?(u.show(),z.hide(),B=!0,g()):(u.hide(),z.show(),B=!1);E.val("1");n=!0;var w=a.storage.get("blog/editor/preview_sidebar_width")||600;a(".sidebar").hide().first().width();x.closest(".content").animate({marginLeft:0},400);x.find(".content").animate({marginRight:w+
"px"},400);r.css("width",0).show().animate({width:w+"px"},400);A.slideUp(400);setTimeout(function(){n=!1;a(window).resize().scroll()},410)}function q(){E.val("");var w=a(".sidebar"),C=w.first().width()-0;n=!0;var G=x.closest(".content").animate({marginLeft:C+"px"},400),H=x.find(".content").animate({marginRight:C+"px"},400);r.hide();A.slideDown(400);setTimeout(function(){w.show();r.hide();n=!1;G.css("marginLeft","");H.css("marginRight","");a(window).resize().scroll()},410)}var x=a("#post-form"),u=
a("#realtime-preview-iframe"),r=u.closest(".sidebar"),n=!1,v=a("<textarea>").hide().appendTo(r),y=a("#post-title"),z=a("#not-available-message"),A=a("#wa-header"),D=a('#blog-photo_bridge-editor [name="album_id"]'),E=r.find('[name="realtime_on"]'),B=!1,F=!1;u.one("load",function(){F=!0});a.pm.bind("updater_loaded",function(w){F=!0});a.widget("ui.blog_draghandler",a.ui.mouse,{_init:function(){this._mouseInit();this.$content=x.find(".content")},_mouseStart:function(w){this.xStart=w.pageX;this.sidebar_width=
r.width();this.window_width=a(window).width();B&&u.hide()},_mouseDrag:function(w){this.sidebar_width+=this.xStart-w.pageX;this.xStart=w.pageX;320>this.sidebar_width?this.sidebar_width=320:380>this.window_width-this.sidebar_width&&(this.sidebar_width=this.window_width-380);r.width(this.sidebar_width);this.$content.css({marginRight:this.sidebar_width+"px"});a(window).resize()},_mouseStop:function(){B&&u.show();a.storage.set("blog/editor/preview_sidebar_width",this.sidebar_width)}});r.find(".column-resize-handler:first").blog_draghandler();
a("#realtime-preview-toggle").click(function(){n||(x.hasClass("realtime-edit-mode")?(x.removeClass("realtime-edit-mode"),a(this).removeClass("b-close-live-editor"),q()):(x.addClass("realtime-edit-mode"),a(this).addClass("b-close-live-editor"),t()))});y.keyup(function(){d(y.val())});setInterval(function(){if(F&&x.hasClass("realtime-edit-mode")){var w;(w=a("#post-form .b-post-editor-toggle li.selected a").attr("id"))&&a.wa_blog.editor.editors[w]&&a.wa_blog.editor.editors[w].update(v);d(y.val());w=v.val();
D.val()&&(w=w+'<p class="attached-album-description"><em>'+$_("Photos from the attached album will be displayed here."),w+="</em></p>");a.pm({target:u[0].contentWindow,type:"update_text",data:w})}},500);a("#post-url-field").on("click","a",function(){if(x.hasClass("realtime-edit-mode")){var w=f(a(this));w!=u.attr("src")&&(u.attr("src",w),u.one("load",function(){}));return!1}});a("#post-url-field").change(function(w){x.hasClass("realtime-edit-mode")&&("empty"!=w.status&&"hidden_empty"!=w.status?(u.show(),
z.hide(),B=!0,g()):(u.hide(),z.show(),B=!1))});a(window).resize(function(){u.height(a(window).height()-30);u.width(r.width()-10)})})();a.wa_blog.editor.initAiFeatures()},cloneTextarea:function(c,m,p){var h="editor_container_"+p;a(m).append(c.clone(!0).attr({id:h,name:"text_"+p,disabled:!0}));c.hide();return h},cut_hr:'<span class="b-elrte-wa-split-vertical elrte-wa_post_cut">%text%</span>',cut_str:"\x3c!-- more %text%--\x3e",htmlToWysiwyg:function(c){return c.replace(/\x3c!--[\s]*?more[\s]*?(text[\s]*?=[\s]*?['"]([\s\S]*?)['"])*[\s]*?--\x3e/g,
function(m,p,h){return h?a.wa_blog.editor.cut_hr.replace("%text%",h):a.wa_blog.editor.cut_hr.replace("%text%",a.wa_blog.editor.options.cut_link_label_default)})},wysiwygToHtml:function(c){var m=a("<p></p>").html(c),p=m.find(".elrte-wa_post_cut");return p.length?((c=p.html())&&"<br>"!==c&&c!==a.wa_blog.editor.options.cut_link_label_default?p.replaceWith(a.wa_blog.editor.cut_str.replace("%text%",'text="'+c+'" ')):p.replaceWith(a.wa_blog.editor.cut_str.replace("%text%","")),m.html().replace("<span></span>",
"")):c},highlightSaveButton:function(){var c=a("#b-post-save-button"),m=a("#postpublish-edit");m.is(":visible")&&m.removeClass("green").addClass("yellow");c.is(":visible")&&c.removeClass("green").addClass("yellow")},editors:{ace:{editor:null,container:null,inited:!1,init:function(c){if(!this.inited){var m=this;this.inited=!0;this.container=a('<div id="blog-ace-editor"></div>').appendTo("#post_text_wrapper");this.container.wrap('<div class="ace"></div>');this.editor=ace.edit("blog-ace-editor");ace.config.set("basePath",
wa_url+"wa-content/js/ace/");e();document.documentElement.addEventListener("wa-theme-change",e);var p=this.editor.getSession();p.setMode("ace/mode/javascript");p.setMode("ace/mode/css");p.setMode("ace/mode/html");p.setMode("ace/mode/smarty");p.setUseWrapMode(!0);this.editor.$blockScrolling=Infinity;this.editor.renderer.setShowGutter(!1);this.editor.setShowPrintMargin(!1);this.editor.setFontSize(13);a(".ace_editor").css("fontFamily","");p.setValue(c.hide().val());this.editor.moveCursorTo(p.getLength(),
Infinity);-1!=navigator.appVersion.indexOf("Mac")?this.editor.setFontSize(13):-1!=navigator.appVersion.indexOf("Linux")?this.editor.setFontSize(16):this.editor.setFontSize(14);this.editor.commands.addCommand({name:"unfind",bindKey:{win:"Ctrl-F",mac:"Command-F"},exec:function(d,g){return!1},readOnly:!0});var h=a("#post-form .sidebar .b-edit-options:first").height(),b=function(d,g){var f=d.getSession().getScreenLength()*d.renderer.lineHeight+d.renderer.scrollBar.getWidth();f*=1.02;var l=h-163;f<l&&
(f=l);a("#"+g).height(f.toString()+"px");d.resize()};p.on("change",function(){b(m.editor,"blog-ace-editor")});setTimeout(function(){b(m.editor,"blog-ace-editor")},50);a(window).resize(function(){m.editor.resize();b(m.editor,"blog-ace-editor")});this.container.on("keydown",a.wa_blog.editor.editorKeyCallback());this.container.on("keypress",a.wa_blog.editor.editorKeyCallback(!0));function e(){"dark"===document.documentElement.dataset.theme?m.editor.setTheme("ace/theme/monokai"):m.editor.setTheme("ace/theme/eclipse")}
}return!0},show:function(c){this.container.show();this.container.parent().show();if(this.editor){c=c.val();c=a.wa_blog.editor.wysiwygToHtml(c);var m=this.editor.getCursorPosition();this.editor.setValue(c);""!=a("#post-title").val()&&this.editor.focus();this.editor.navigateTo(m.row,m.column)}else"object"==typeof console&&console.log("wait for ace editor init"),this.show(c)},hide:function(){this.container.hide();this.container.parent().hide()},update:function(c){this.inited&&c.val(this.editor.getValue())},
correctEditorHeight:function(c){return Math.max(c,a.wa_blog.editor.getMinEditorHeight())+a.wa_blog.editor.getExtHeightShift()}},redactor:{options:{},inited:!1,callback:!1,editor:null,focusedNode:null,init:function(c){if(!this.inited){a("#post-form .sidebar .b-edit-options:first").height();let p=!0;""==a("#post-title").val()&&(p=!1);var m=a.extend({focus:p,deniedTags:!1,minHeight:300,linkify:!1,source:!1,paragraphy:!1,replaceDivs:!1,toolbarFixed:!0,toolbarFixedTopOffset:a("#wa-nav").outerHeight()+
a(".b-post-editor-toggle").outerHeight(),replaceTags:{b:"strong",i:"em",strike:"del"},removeNewlines:!1,removeComments:!1,imagePosition:!0,imageResizable:!0,imageFloatMargin:"1.5em",imageTypes:["image/png","image/jpeg","image/gif","image/webp"],buttons:"format bold italic underline deleted lists image video file table link alignment fontcolor fontsize fontfamily".split(" "),plugins:"fontcolor fontfamily alignment fontsize table video cut".split(" "),lang:wa_lang,imageUpload:"?action=upload&r=2&absolute=1",
imageUploadFields:c.data("uploadFields"),callbacks:{change:function(){a.wa_blog.editor.highlightSaveButton()},keyup:function(){a.wa_blog.editor.editors.redactor.focusedNode=this.selection.current()},click:function(){a.wa_blog.editor.editors.redactor.focusedNode=this.selection.current()}}},m||{});m.callbacks=a.extend({imageUploadError:function(h){console.log("imageUploadError",h);alert(h.error)},syncClean:function(h){return h.replace(/\{[a-z\$'"_\(!+\-][^\}]*\}/gi,function(b){return b.replace(/-&gt;/g,
"->")})},syncBefore:function(h){return h=h.replace(/{[a-z$][^}]*}/gi,function(b,e,d){var g=d.indexOf("\x3c/script",e+b.length);e=d.indexOf("<script",e+b.length);if(-1==g||-1!=e&&e<g)b=b.replace(/&gt;/g,">"),b=b.replace(/&lt;/g,"<"),b=b.replace(/&amp;/g,"&"),b=b.replace(/&quot;/g,'"');return b})}},m.callbacks||{});a.wa_blog_options.photos_bridge_available&&(m.callbacks.modalOpened=function(h,b){if("image"==h){var e=this;this.modal.width=1100;h=this.modal.getModal();var d=a('<div id="photos-image-selector-wrapper">'),
g=a('<div class="redactor-modal-tab redactor-tab1" data-title="'+$_("Select from Photos app")+'">').hide().append(d).append('<div class="clear-both">'),f=g.find(".total-photos-selected");h.append(g);this.modal.buildTabber();(function(){function l(){d.find("input:checkbox").each(function(){q[this.value]&&a(this).prop("checked",!0).change()});a(window).resize()}var t=0,q={},x=a('<button id="redactor-modal-button-action" style="margin-top: 16px;">'+e.lang.get("insert")+"</button>").hide();g.append(x);
var u=a('<button id="redactor-modal-button-cancel" style="margin-top: 16px;">'+e.lang.get("cancel")+"</button>").hide();g.append(u);a('#redactor-modal-tabber a[rel="1"]').on("click",function(){x.is(":visible")||(x.show(),u.show(),d.html('<div class="block"><i class="icon16 loading"></i></div>'),a.post("../photos/?module=photo&action=embedSelector",{app_id:"blog"},function(r){d.html(r);l()}))});u.off("click").on("click",function(){e.modal.close()});x.on("click",function(){if(0<t){var r=[];a.each(q,
function(n,v){r.push('<figure><img src="'+v+'"></figure>')});e.insert.html(r.join("\n"))}e.modal.close()});a('#redactor-modal-tabber a[rel="0"]').on("click",function(){x.hide();u.hide()});d.on("change","input:checkbox",function(){var r=a(this),n=r.val();this.checked?q[n]||(q[n]=r.data("photoUrl"),t++):q[n]&&(delete q[n],t--);0<t?f.text(t).closest(".hidden").show():f.text(t).closest(".hidden").hide()});d.on("reloaded",function(r){l()})})()}});c.redactor(m);c.redactor("core.box").css("z-index",0);c.redactor("core.toolbar").css("z-index",
1);this.editor=c.data("redactor");this.inited=!0}return!0},show:function(c){var m=a.wa_blog.editor.htmlToWysiwyg(c.val());c.val(m);a(".redactor-box").show();c.redactor("core.editor").find('img[src*="$wa_url"]').each(function(){var p=decodeURIComponent(a(this).attr("src"));a(this).attr("data-src",p);a(this).attr("src",p.replace(/\{\$wa_url\}/,wa_url))});this.editor.code.set(c.val());this.editor.observe.load();this.editor.focus.start()},hide:function(c){a(".redactor-box").hide()},update:function(c){if(this.inited){var m=
this.editor.code.get();m=this.editor.clean.onSync(this.editor.clean.onSet(m));m=a.wa_blog.editor.wysiwygToHtml(m);c.val(m)}}},photo_bridge:{container:null,inited:!1,init:function(c){if(!this.inited){this.inited=!0;c.hide();this.container=a("#blog-photo_bridge-editor");if(!this.container.length)return;var m=a("#album-frontend-link"),p=this.container.find('select[name="album_id"]'),h=this.container.find(".js-post-url"),b=0;p.change(function(){if(p.val()){var e=p.children(":selected").data("frontend-link");
e?(h.slideDown(b),m.text(e)):(h.slideUp(b),h.find('[name="album_link_type"]:checkbox').prop("checked",!1));a("#post-editor .show-when-album-selected").show()}else h.slideUp(b),a("#post-editor .show-when-album-selected").hide()}).change();b=300;c=a("#post-form .sidebar .b-edit-options:first").height();this.container.css("min-height",c-100)}return!0},show:function(c){this.container.show()},hide:function(){this.container.hide()},update:function(c){}}},getMinEditorHeight:function(){return 200},getExtHeightShift:function(){return-70},
handleToggleEditor:function(c){c.preventDefault();c=a.wa_blog.editor.toggleEditor.bind(this);const {options:m}=a.wa_blog.editor;m.can_use_smarty&&"redactor"===this.id?a.waDialog.confirm({title:$_("Message"),text:m.locale.switch_to_WYSIWYG,success_button_title:$_("Continue"),success_button_class:"yellow",cancel_button_title:$_("Cancel"),cancel_button_class:"light-gray",onSuccess:c}):c()},toggleEditor:function(){const c=window.scrollY,m=a(this);!m.parent().hasClass("selected")&&a.wa_blog.editor.selectEditor(m.attr("id"))&&
(a(".b-post-editor-toggle li.selected").removeClass("selected"),m.parent().addClass("selected"),window.scrollTo(0,c+1))},selectEditor:function(c,m){if(this.editors[c]){var p=a("#"+this.options.content_id);if(p.length){try{if(this.editors[c].init(p)){var h=null;if(!m)try{a.storage.set("blog/editor",c)}catch(e){this.log("Exception: "+e.message+"\nline: "+e.fileName+":"+e.lineNumber)}var b=a(".b-post-editor-toggle li.selected a");b.length&&(b.parent().removeClass("selected"),h=b.attr("id"))&&(this.editors[h].update(p),
this.editors[h].hide());a("#"+c).parent().addClass("selected");this.editors[c].show(p)}}catch(e){return this.log("Exception: "+e.message+"\nline: "+e.fileName+":"+e.lineNumber,e.stack),!1}return!0}this.log('Text container for "'+c+'" not found');return!1}this.log('Blog editor "'+c+'" not found');return!1},editor_key:!1,editorKeyCallback:function(c){var m=this;return c?function(p){if(p.ctrlKey&&115==p.which&&!a.wa_blog.editor.editor_key)m.onSaveHotkey(p)}:function(p){a.wa_blog.editor.editor_key=!1;
p.ctrlKey&&83==p.which&&(a.wa_blog.editor.editor_key=!0,m.onSaveHotkey(p));p.metaKey||!((33>p.which||40<p.which)&&(27<p.which||8==p.which||13==p.which)&&(112>p.which||124<p.which))||p.ctrlKey&&67==p.which||(a("#b-post-save-button").removeClass("green").addClass("yellow"),a("#postpublish-edit").removeClass("green").addClass("yellow"))}},onSubmit:function(){var c=a.wa_blog;for(m in c)if("editor"!=m&&c[m].onSubmit&&"function"==typeof c[m].onSubmit)try{c[m].onSubmit()}catch(h){"object"==typeof console&&
console.log(h)}c=a("#"+this.options.content_id);if(c.length){var m=null;var p=a(".b-post-editor-toggle li.selected a");p.length&&(m=p.attr("id"))&&this.editors[m].update(c)}c=a("#b-post-save-button");"draft"!=c.attr("name")&&"deadline"!=c.attr("name")&&(c.removeClass("yellow").addClass("blue"),a("#postpublish-edit").removeClass("yellow").addClass("blue"))},onSaveHotkey:function(c){c.preventDefault();c=a("#b-post-save-draft-button");var m=a("#b-post-save-button");c.length?c.click():m.length&&m.click()},
currentDialog:null,closeCurrentDialog:function(){this.currentDialog&&this.currentDialog.close()},registerEditor:function(c,m){if(this.editors[c])return this.log('Editor "'+c+'" already registered'),!1;this.editors[c]=m;return!0},log:function(c,m){"object"==typeof console&&(console.log(c),m&&console.log(m))},changeBlogHandler:function(){const c=parseInt(a(this).find("[data-id]").data("id"));a.wa_blog.editor.selectCurrentBlog(c)&&(a(".dialog :input:checked").attr("checked",!1),a(".dialog #b-post-publish-blog-"+
c).attr("checked",!0))},changePublishBlogHandler:function(){if(this.checked){var c=parseInt(a(this).val());a.wa_blog.editor.selectCurrentBlog(c)}},selectCurrentBlog:function(c){const m=a.wa_blog.editor.options.blogs[c];var p=a.wa_blog.editor.options.current_blog_id;if(m&&p!=c){var h=a.tmpl("selected-blog",{blog:m});a(".current-blog").html(h);a("#blog-selector-"+p).removeClass("selected");h=a("#blog-selector-"+c).addClass("selected");p=a.wa_blog.editor.options.blogs[p];a.wa_blog.editor.options.current_blog_id=
parseInt(c);c=a(".b-post");p&&c.removeClass(p.color);c.addClass(m.color);a.wa_blog.editor.postUrlWidget.changeBlog(h.attr("data-blog-status"));return!0}},currentEditor:function(){let c=b=>{},m=(b,e)=>{},p="";const h=a("#post-form .b-post-editor-toggle li.selected a").attr("id");if("redactor"===h&&this.editors.redactor.inited){const b=this.editors.redactor.editor;p=b.code.get();c=e=>b.code.set(e);m=(e,d=!1)=>{d?b.focus.end():b.selection.isRedactor()||(a.wa_blog.editor.editors.redactor.focusedNode&&
b.caret.end(a.wa_blog.editor.editors.redactor.focusedNode),b.selection.isRedactor()||b.focus.end());/^<([a-zA-Z][a-zA-Z0-9]*)\s*([^>]*)>.+<\/([a-zA-Z][a-zA-Z0-9]*)\s*([^>]*)>$/m.test(e)||(e=`<p>${e}</p>`);b.utils.isEmpty()&&b.selection.current()?.remove();a(e).each(function(){a.wa_blog.editor.editors.redactor.focusedNode=b.insert.node(this)});b.code.sync()}}else if("ace"===h&&this.editors.ace.inited){const b=this.editors.ace.editor;p=b.getValue();c=e=>b.setValue(e);m=(e,d=!1)=>{let g=b.getCursorPosition();
d&&(g.row=b.getSession().getLength()-1,g.column=b.getSession().doc.$lines[g.row].length);0<g.column&&g.column===b.getSession().doc.$lines[g.row].length&&(g=b.getSession().insert(g,"\n"));b.getSession().insert(g,e);a.wa_blog.editor.highlightSaveButton()}}else if("markdown"===h&&this.editors.markdown.inited&&"function"===typeof window.toMarkdown){const b=this.editors.markdown.editor;p=b.getValue();c=e=>b.setValue(e);m=(e,d=!1)=>{let g=b.getCursorPosition();d&&(g.row=b.getSession().getLength()-1,g.column=
b.getSession().doc.$lines[g.row].length);0<g.column&&g.column===b.getSession().doc.$lines[g.row].length&&(g=b.getSession().insert(g,"\n"));b.getSession().insert(g,toMarkdown(e));a.wa_blog.editor.highlightSaveButton()}}return{content:p,setContent:c,insert:m}},onUpdateContent:function(c){if("function"===typeof c){var m=this,p=a(`#${a.wa_blog.editor.options.content_id}`),h=()=>{const b=m.currentEditor().content||p.val();c(b)};h();setInterval(h,1E3)}},initAiFeatures:function(){function c(u,r,n){const v=
a(this);if(v.prop("disabled"))return!1;m();v.prop("disabled",!0);return a.post("?module=post&action=ai",u,y=>{if(y?.data?.content)"function"===typeof r&&r(y.data.content);else if(y?.errors){const z="payment_required"===y.errors.error;d.toggleClass("warning",z);d.toggleClass("danger",!z);m(y.errors.error_description||y.errors.error)}}).always(()=>{v.prop("disabled",!1);"function"===typeof n&&n()})}function m(u=!1){!1===u?(d.hide(),g.empty()):(d.show(),g.html(u))}function p(u){const r=f.find(".js-content");
r.html(u).show();r.off("click").on("click","> *",function(n){n.preventDefault();n.stopPropagation();n=this.outerHTML;h.currentEditor().insert(n)});f.find(".js-insert-to-editor-post").show().off("click").on("click",function(n){n.preventDefault();h.currentEditor().insert(u,!0)})}const h=this,b=a("#js-show-ai-drawer"),e=a("#js-ai-drawer").clone(),d=a("#js-ai-error-alert"),g=d.find(".js-text"),f=e.find(".js-ai-wrapper"),l=e.find(".js-premium-wrapper"),t=a("#post-title");let q=!0;const x=()=>{if(!e.hasClass("hidden"))return!1;
a.waDrawer({$wrapper:e,direction:"right",append_to:".js-main-content",staticPosition:!0,onOpen:()=>{e.removeClass("hidden");const u=f.find(".js-prompt"),r=t.val().trim();r&&!u.val()?.trim()&&(u.prop("placeholder",r),u.data("default-prompt",r));q=!l.length;q||(f.hide(),l.show())},onClose:()=>{e.addClass("hidden");return!1}})};(()=>{b.on("click",x);const u=a("#js-ai-spellcheck");h.onUpdateContent(r=>{u.toggle(10<=r.replace(/<[^>]*>/g,"").trim().length)});u.on("click",function(){const {content:r}=h.currentEditor();
if(10<=r.replace(/<[^>]*>/g,"").trim().length){var n=a(this).find(".webasyst-magic-wand-ai").addClass("shimmer");c.call(this,{action:"spellcheck",text:r},v=>{h.currentEditor().setContent(v)},()=>{n.removeClass("shimmer")})}});f.find(".js-write-post").on("click",function(){if(!q)return!1;const r=f.find(".js-prompt");let n=r.val();n.trim()||(n=r.data("default-prompt"));const v=a('<span class="custom-mr-4"><i class="fas fa-spinner fa-spin"></i></span>').prependTo(this);c.call(this,{action:"blogPost",
text:n},y=>{p(y)},()=>{v.remove()})});l.find(".js-try-free-ai").on("click",function(){const r=a(this);a.post("?module=post&action=ai",{action:"tryFree"},n=>{"ok"===n.status&&(n.data.is_max_count&&(l.find(".js-after-try-free-ai").show(),r.remove()),l.hide(),f.show(),q=!0)})})})()}}})(jQuery);
//# sourceMappingURL=blog-post-edit.min.js.map