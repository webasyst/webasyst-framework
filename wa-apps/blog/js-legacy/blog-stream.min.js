(function(a){a.wa_blog.stream={management:!1,options:{pageless:{}},init:function(f){this.options=a.extend(this.options,f);var b=this;a("a[href=\\#manage]").click(function(a){return b.manageHandler.apply(b,[this,a])});a(".js-manage-done").click(function(a){return b.manageCompleteHandler.apply(b,[this,a])});b.initShiftClickCheckboxes();a("input.search").keydown(function(c){if(13==c.keyCode){var c=a(this).val(),b=location.search.match(/[&\\?](text=.*?&|text=.*)/);b?(b=b[1],c?(c="&"==b.substr(-1)?"text="+
encodeURIComponent(c)+"&":"text="+encodeURIComponent(c),location.search=location.search.replace(b,c)):("&"!=b.substr(-1)&&(b="[&\\?]"+b),location.search=location.search.replace(RegExp(b),""))):c&&(location.search+=(location.search?"&":"?")+"text="+encodeURIComponent(c));return!1}});a("input.blog-post-checkbox").live("change",function(){this.checked?a(this).parent().addClass("bold"):a(this).parent().removeClass("bold");return b.counterHandler()});a("#postdelete-dialog input[type=button]").click(function(a){return b.deleteHandler.apply(b,
[this,a])});a('#postmove-dialog input[type="button"]').click(function(a){return b.moveHandler.apply(b,[this,a])});var e={scroll:function(){a.wa_blog.common.onContentUpdate()},afterLoad:f=function(){a(".b-stream .b-post-body").each(function(){var b=a(this);if(!b.data("ensureEverythingInside")){b.data("ensureEverythingInside",!0);var k=b.offset().top,g=0;b.find("*").each(function(){var d=a(this);({left:1,right:1})[d.css("float")]&&(d=d.offset().top+d.height()-k,d>g&&(b.css("min-height",d+"px"),g=d))})}})}};
f();e=a.extend(!0,e,b.options.pageless);a.pageless(e)},initShiftClickCheckboxes:function(){function f(b,c,d){if(b&&c&&b[0]&&c[0]&&!b.is(c[0])){var e=!1;c.parent().children(".b-post").each(function(f,h){if(e){if(b.is(h)||c.is(h))return!1;var j=a(h).find(".blog-post-checkbox");j.prop("checked")!=d&&j.prop("checked",d).change()}else if(b.is(h)||c.is(h))e=!0})}}var b=a(".b-stream"),e=null,c=null;b.on("click",".b-post .b-post-title-bulk-mode",function(b){var g=a(this).find(".blog-post-checkbox"),d=g.closest(".b-post"),
i;g.is(b.target)?i=g.prop("checked"):(i=!g.prop("checked"),g.prop("checked",i).change());i?(b.shiftKey&&e&&f(e,d,!0),e=d,c=null):(b.shiftKey&&c&&f(c,d,!1),e=null,c=d)});b.find(".b-post .b-post-title-bulk-mode").attr("unselectable","on").css("user-select","none").on("selectstart",!1)},manageHandler:function(){a("#blog-stream-primary-menu").hide();a("#blog-stream-manage-menu").show();this.management=!0;this.onContentUpdate();return!1},manageCompleteHandler:function(){this.management=!1;a("#blog-stream-manage-menu").hide();
a("#blog-stream-primary-menu").show();a(".b-post.js-managed").each(function(){a(this).removeClass("js-managed");a(this).find("h3:hidden").show();a(this).find("h3:first").hide();a(this).find(".b-post-body:hidden, .profile.image20px:hidden").fadeIn()});return!1},counterHandler:function(){a(".js-blog-selected-posts-counter").text(a("input.blog-post-checkbox:checked").length)},moveHandler:function(f){var b=[];a("input.blog-post-checkbox:checked").each(function(){b.push(a(this).val())});var e=a("#postmove-dialog :input[name=blog_id]").val();
b.length?(a(f).attr("disabled",!0).after('<i class="icon16 loading"></i>'),a.ajax({url:"?module=post&action=move",data:{id:b,blog:e},type:"post",dataType:"json",success:function(b){var e=!1;if("ok"==b.status)for(var f in b.data.moved){var d=a("#b-post-"+b.data.moved[f]);d.length&&(e=!0,d.animate({opacity:0.1,height:0},200,function(){d.remove()}))}a.wa_blog.stream.counterHandler();e?window.location.reload():(a("#postmove-dialog .icon16.loading").remove(),a("#postmove-dialog input[type=button]:disabled").removeAttr("disabled"),
a.wa_blog.dialogs.close("postmove"))},error:function(){a("#postmove-dialog .icon16.loading").remove();a("#postmove-dialog input[type=button]:disabled").removeAttr("disabled");a.wa_blog.dialogs.close("postmove")}})):a.wa_blog.dialogs.close("postmove")},deleteHandler:function(f){var b=[];a("input.blog-post-checkbox:checked").each(function(){b.push(a(this).val())});b.length?(a(f).attr("disabled",!0).after('<i class="icon16 loading"></i>'),a.ajax({url:"?module=post&action=delete",data:{id:b},type:"post",
dataType:"json",success:function(b){"ok"==b.status&&b.data.deleted?window.location.reload():(a("#postdelete-dialog .icon16.loading").remove(),a("#postdelete-dialog input[type=button]:disabled").removeAttr("disabled"),a.wa_blog.dialogs.close("postdelete"),a.wa_blog.stream.counterHandler())},error:function(){a("#postdelete-dialog .icon16.loading").remove();a("#postdelete-dialog input[type=button]:disabled").removeAttr("disabled");a.wa_blog.dialogs.close("postdelete");a.wa_blog.stream.counterHandler()}})):
a.wa_blog.dialogs.close("postdelete")},onContentUpdate:function(){if(this.management){var f=this,b=!1;a(".b-post-body:visible, .profile.image20px:visible").hide();a(".b-post").each(function(){a(this).hasClass("js-managed")||(a(this).find("h3:visible").hide(),a(this).find("h3:first").show(),b=!0,a(this).addClass("js-managed"))});b&&setTimeout(function(){a(f.options.pageless.target).trigger("scroll.pageless")},100)}}}})(jQuery);
