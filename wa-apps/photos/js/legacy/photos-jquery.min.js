var $jscomp=$jscomp||{};$jscomp.scope={};$jscomp.findInternal=function(a,c,d){a instanceof String&&(a=String(a));for(var g=a.length,f=0;f<g;f++){var b=a[f];if(c.call(d,b,f,a))return{i:f,v:b}}return{i:-1,v:void 0}};$jscomp.ASSUME_ES5=!1;$jscomp.ASSUME_NO_NATIVE_MAP=!1;$jscomp.ASSUME_NO_NATIVE_SET=!1;$jscomp.SIMPLE_FROUND_POLYFILL=!1;$jscomp.ISOLATE_POLYFILLS=!1;$jscomp.FORCE_POLYFILL_PROMISE=!1;$jscomp.FORCE_POLYFILL_PROMISE_WHEN_NO_UNHANDLED_REJECTION=!1;
$jscomp.defineProperty=$jscomp.ASSUME_ES5||"function"==typeof Object.defineProperties?Object.defineProperty:function(a,c,d){if(a==Array.prototype||a==Object.prototype)return a;a[c]=d.value;return a};$jscomp.getGlobal=function(a){a=["object"==typeof globalThis&&globalThis,a,"object"==typeof window&&window,"object"==typeof self&&self,"object"==typeof global&&global];for(var c=0;c<a.length;++c){var d=a[c];if(d&&d.Math==Math)return d}throw Error("Cannot find global object");};$jscomp.global=$jscomp.getGlobal(this);
$jscomp.IS_SYMBOL_NATIVE="function"===typeof Symbol&&"symbol"===typeof Symbol("x");$jscomp.TRUST_ES6_POLYFILLS=!$jscomp.ISOLATE_POLYFILLS||$jscomp.IS_SYMBOL_NATIVE;$jscomp.polyfills={};$jscomp.propertyToPolyfillSymbol={};$jscomp.POLYFILL_PREFIX="$jscp$";var $jscomp$lookupPolyfilledValue=function(a,c){var d=$jscomp.propertyToPolyfillSymbol[c];if(null==d)return a[c];d=a[d];return void 0!==d?d:a[c]};
$jscomp.polyfill=function(a,c,d,g){c&&($jscomp.ISOLATE_POLYFILLS?$jscomp.polyfillIsolated(a,c,d,g):$jscomp.polyfillUnisolated(a,c,d,g))};$jscomp.polyfillUnisolated=function(a,c,d,g){d=$jscomp.global;a=a.split(".");for(g=0;g<a.length-1;g++){var f=a[g];if(!(f in d))return;d=d[f]}a=a[a.length-1];g=d[a];c=c(g);c!=g&&null!=c&&$jscomp.defineProperty(d,a,{configurable:!0,writable:!0,value:c})};
$jscomp.polyfillIsolated=function(a,c,d,g){var f=a.split(".");a=1===f.length;g=f[0];g=!a&&g in $jscomp.polyfills?$jscomp.polyfills:$jscomp.global;for(var b=0;b<f.length-1;b++){var e=f[b];if(!(e in g))return;g=g[e]}f=f[f.length-1];d=$jscomp.IS_SYMBOL_NATIVE&&"es6"===d?g[f]:null;c=c(d);null!=c&&(a?$jscomp.defineProperty($jscomp.polyfills,f,{configurable:!0,writable:!0,value:c}):c!==d&&(void 0===$jscomp.propertyToPolyfillSymbol[f]&&(d=1E9*Math.random()>>>0,$jscomp.propertyToPolyfillSymbol[f]=$jscomp.IS_SYMBOL_NATIVE?
$jscomp.global.Symbol(f):$jscomp.POLYFILL_PREFIX+d+"$"+f),$jscomp.defineProperty(g,$jscomp.propertyToPolyfillSymbol[f],{configurable:!0,writable:!0,value:c})))};$jscomp.polyfill("Array.prototype.find",function(a){return a?a:function(c,d){return $jscomp.findInternal(this,c,d).v}},"es6","es3");$.wa=$.ui?$.extend(!0,$.wa,$.ui):{};
$.wa=$.extend(!0,$.wa,{data:{},content:!1,get:function(a,c){return void 0==a?this.data:this.data[name]||c||null},set:function(a,c){if(void 0==a)return this.data;"object"==typeof a?$.extend(this.data,a):this.data[a]=value;return this.data},encodeHTML:function(a){return a&&(""+a).replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;")},decodeHTML:function(a){return a.replace(/&amp;/g,"&").replace(/&lt;/g,"<").replace(/&gt;/g,">")},setHash:function(a){a instanceof String||!a.toString||(a=a.toString());
a=a.replace(/\/\//g,"/");a=a.replace(/^.*#/,"");$.browser&&$.browser.safari?parent?parent.window.location=parent.window.location.href.replace(/#.*/,"")+"#"+a:window.location=location.href.replace(/#.*/,"")+"#"+a:!parent||$.browser&&$.browser.msie?location.hash=a:parent.window.location.hash=a;return!0},back:function(a){2<history.length?"number"==typeof a&&parseInt(a)==a?history.go(-a):history.go(-1):$.browser.msie&&0<history.length?history.back():a&&this.setHash(a);return!1},toggleHashParam:function(a){-1==
location.hash.search(a)?this.addToHash(a):this.removeFromHash(a)},addToHash:function(a){var c=location.hash;-1==c.search(a)&&(c+="/"+a+"/");this.setHash(c)},removeFromHash:function(a){var c=location.hash;-1<c.search(a)&&(c=c.replace(a,""));this.setHash(c)},setTitle:function(a){document.title=a},array_search:function(a,c,d){d=!!d;for(var g in c)if(d&&c[g]===a||!d&&c[g]==a)return g;return!1},dialogCreate:function(a,c){c=$.extend({content:'<h1>Loading... <i class="icon16 loading"></i></h1>',buttons:null,
url:null,post:null,small:!1,onload:null,oncancel:null},c);c.content=$(c.content);c.buttons=c.buttons?$(c.buttons):$('<input type="submit" class="button gray" value="'+$_("Cancel")+'">').click(function(){c.oncancel&&c.oncancel.call(d[0]);$.wa.dialogHide()});var d=$("#"+a);0>=d.size()&&(d=$('<div class="dialog" id="'+a+'" style="display: none"><div class="dialog-background"></div><div class="dialog-window"><div class="dialog-content"><div class="dialog-content-indent"></div></div><div class="dialog-buttons"><div class="dialog-buttons-gradient"></div></div></div></div>').appendTo("body"));
d.find(".dialog-buttons-gradient").empty().append(c.buttons);d.find(".dialog-content-indent").empty().append(c.content);d.show();c.small?d.addClass("small"):d.removeClass("small");c.url&&(a=function(f){d.find(".dialog-content-indent").html(f);$.wa.waCenterDialog(d);c.onload&&c.onload.call(d[0])},c.post?$.post(c.url,c.post,a):$.get(c.url,a));this.waCenterDialog(d);var g=function(f){if(d.is(":visible"))if(f&&27==f.keyCode)c.oncancel&&"function"==typeof c.oncancel&&c.oncancel.call(d[0]),$.wa.dialogHide();
else $(document).one("keyup",g)};g();$(document).one("hashchange",$.wa.dialogHide);return d},waCenterDialog:function(a){a=$(a);a=a.find(".dialog-window");var c=a.outerWidth(!0),d=a.outerHeight(!0),g=$(window).width(),f=$(window).height();a.css({left:Math.round((g-c)/2/g*100)+"%",top:Math.round((f-d)/2/f*100)+"%"})},dialogHide:function(){$(".dialog").hide();return!1},dropdownsClose:function(){var a=$(".dropdown:not(.disabled)");a.addClass("disabled");setTimeout(function(){a.removeClass("disabled")},
600)},dropdownsCloseEnable:function(){$(document).on("click",".dropdown:not(.disabled)",this.dropdownsClickHandler)},dropdownsCloseDisable:function(){$(document).off("click",".dropdown:not(.disabled)",this.dropdownsClickHandler)},dropdownsClickHandler:function(a){var c=$(this);c.hasClass("no-click-close")||(c.addClass("disabled"),setTimeout(function(){c.removeClass("disabled")},600))},defaultInputValue:function(a,c,d){a instanceof jQuery||(a=$(a));var g=function(){var f=a.val();f&&f!=c||(a.val(c),
a.addClass(d))};g();a.blur(g);a.focus(function(){a.hasClass(d)&&(a.removeClass(d),a.val(""))})},loadFiles:function(a){$.isArray(a)||(a="object"!==typeof a||$.isArray(a)?[].slice.apply(arguments):$.map(a,function(d,g){return d?g:null}));var c=a.map(function(d){return d?"string"!=typeof d?"object"===typeof d&&"function"===typeof d.then?d:null:d.match(/\.css(\?.*)?$/)?($("<link>").appendTo("head").attr({type:"text/css",rel:"stylesheet",href:d}),null):$.ajax({cache:!0,dataType:"script",url:d}):null}).filter(function(d){return!!d});
return $.when.apply($,c)},determineTimezone:function(a,c){var d=!1;$.each(document.cookie.split(/;\s*/g),function(f,b){b=b.split("=",2);if("tz"==b[0])return d=!0,c&&c(b[1]),!1});if(!d){var g={};g[a+"wa-content/js/jstz/jstz.min.js"]=!window.jstz;$.wa.loadFiles(g).then(function(){var f=window.jstz.determine().name();document.cookie="tz="+jstz.determine().name()+"; sameSite=LAX";var b=new Date;b.setTime(b.getTime()+12096E5);document.cookie="oldtz="+f+"; expires="+b.toUTCString()+"; sameSite=LAX";c&&
c(f)})}},util:{formatFileSize:function(a){var c=-1;do a/=1024,c++;while(99<a);return Math.max(a,.01).toFixed(2)+(0<=c?" "+$_("kB MB GB TB PB EB".split(" ")[c]):"")}}});
window.wa_skip_ajax_setup||($.ajaxSetup({cache:!1}),$(document).ajaxError(function(a,c,d,g){if(502===c.status&&"abort"==g||d.url&&0<=d.url.indexOf("background_process")||d.data&&0<=d.data.indexOf("background_process"))console&&console.log&&console.log("Notice: XHR failed on load: "+d.url);else if(200!==c.status&&c.responseText){if(!$.wa.errorHandler||$.wa.errorHandler(c))-1!=c.responseText.indexOf("Exception")?$.wa.dialogCreate("ajax-error",{content:"<div>"+c.responseText+"</div>"}):(document.open("text/html"),
document.write(c.responseText),document.close(),$(window).one("hashchange",function(){window.location.reload()}))}else c.getResponseHeader("wa-session-expired")?window.location.reload():"undefined"!==typeof c.responseText&&-1!=c.responseText.indexOf("Exception")&&$.wa.dialogCreate("ajax-error",{content:"<div>"+c.responseText+"</div>"})}));
window.wa_skip_csrf_prefilter||$.ajaxPrefilter(function(a,c,d){a.crossDomain||"POST"!==(a.type||"").toUpperCase()||(c=document.cookie.match(/(?:^|; )_csrf=([^;]*)/))&&c[1]&&(c=decodeURIComponent(c[1]),a.data||0===a.data||(a.data=""),"string"==typeof a.data?-1==a.data.indexOf("_csrf=")&&(a.data+=(0<a.data.length?"&":"")+"_csrf="+c,d.setRequestHeader("Content-type","application/x-www-form-urlencoded")):"object"==typeof a.data&&(window.FormData&&a.data instanceof window.FormData?"function"==typeof a.data.set?
a.data.set("_csrf",c):a.data.append("_csrf",c):a.data._csrf=c))});Array.prototype.indexOf||(Array.prototype.indexOf=function(a,c){var d=this.length;c=Number(c)||0;c=0>c?Math.ceil(c):Math.floor(c);for(0>c&&(c+=d);c<d;c++)if(c in this&&this[c]===a)return c;return-1});$.wa.locale=$.wa.locale||{};
$_=function(a,c){if(!$||!$.wa||!$.wa.locale)return console.log("JS localization failed: empty $.wa.locale"),"string"===typeof c?c:a;if(c){if(!$.wa.locale[c])return console&&console.log("JS localization failed: "+c),c;if("string"==typeof $.wa.locale[c])return $.wa.locale[c];var d=a%10;return 1==Math.floor(a/10)%10||4<d||0==d?$.wa.locale[c][2]:1==d?$.wa.locale[c][0]:$.wa.locale[c][1]}if($.wa.locale[a])return"string"==typeof $.wa.locale[a]?$.wa.locale[a]:$.wa.locale[a][0];console&&console.log("JS localization failed: "+
a);return a};jQuery.fn.waDialog=function(a){a=jQuery.extend({loading_header:"",title:"",esc:!0,buttons:null,url:null,url_reload:!0,"class":null,content:null,width:0,height:0,"min-width":0,"min-height":0,offsetTop:null,offsetLeft:null,disableButtonsOnSubmit:!1,onLoad:null,onCancel:null,onSubmit:null},a||{});var c=$(this),d=c.attr("id");d&&!c.hasClass("dialog")&&(c.removeAttr("id"),$("#"+d).length&&(a.url?(c=$("#"+d),a.url_reload||(a.url=null)):$("#"+d).remove()));var g=a["class"]||a.className?a["class"]||a.className:
c.attr("class")||"";if(c.hasClass("dialog"))a.content&&(c.find(".dialog-content-indent").html(a.content),a.title&&c.find(".dialog-content-indent").prepend("<h1>"+a.title+"</h1>")),a.buttons&&c.find(".dialog-buttons-gradient").empty().append(a.buttons);else{var f=$(this),b=c.parent();b.length&&b.is(":visible")||(b=$("body"));c=$("<div "+(d?'id = "'+d+'"':"")+' class="dialog '+g+'" style="display: none"><div class="dialog-background"></div><div class="dialog-window"></div></div>').appendTo(b);f.find(".dialog-content").length||
f.find(".dialog-buttons").length?($(".dialog-window",c).append(f.show()),d=f.find(".dialog-content"),d.length&&(g=$('<div class="dialog-content-indent"></div>'),d.contents().appendTo(g),d.append(g)),d=f.find(".dialog-buttons"),d.length&&(g=$('<div class="dialog-buttons-gradient"></div>'),d.contents().appendTo(g),d.append(g))):($(".dialog-window",c).append((a.onSubmit?'<form method="post" action="">':"")+'<div class="dialog-content"><div class="dialog-content-indent"></div></div><div class="dialog-buttons"><div class="dialog-buttons-gradient"></div></div>'+
(a.onSubmit?"</form>":"")),c.find(".dialog-content-indent").append(f.show()));a.buttons&&c.find(".dialog-buttons-gradient").empty().append(a.buttons);a.url?c.find(".dialog-content-indent").append("<h1>"+(a.loading_header||"")+'<i class="icon16 loading"></i></h1>'):a.content&&c.find(".dialog-content-indent").append(a.content);a.title&&c.find(".dialog-content-indent").prepend("<h1>"+a.title+"</h1>")}c.find(".dialog-background").length||c.prepend('<div class="dialog-background"> </div>');c.unbind("close").bind("close",
function(){a.onClose&&a.onClose.call($(this));$(this).hide()});f=["width","height","min-width","min-height"];for(d=0;d<f.length;d++)a[f[d]]&&(("height"==f[d]&&"300px">a[f[d]]||"width"==f[d]&&"400px">a[f[d]])&&c.find("div.dialog-window").css("min-"+f[d],a[f[d]]),c.find("div.dialog-window").css(f[d],a[f[d]]));a.disableButtonsOnSubmit&&c.find("input[type=submit]").removeAttr("disabled");c.parent().length||c.appendTo("body");c.show();a.url?jQuery.get(a.url,function(e){var h=$(e);h.find(".dialog-content").length||
h.find(".dialog-buttons").length?(h.find(".dialog-content").length&&c.find(".dialog-content-indent").empty().append(h.find(".dialog-content").contents()),h.find(".dialog-buttons").length&&c.find(".dialog-buttons-gradient").empty().append(h.find(".dialog-buttons").contents())):c.find(".dialog-content-indent").html(e);c.trigger("wa-resize");a.onLoad&&a.onLoad.call(c.get(0))}):a.onLoad&&a.onLoad.call(c.get(0));c.find(".dialog-buttons").delegate(".cancel","click",function(e){e.stopPropagation();e.preventDefault();
a.onCancel&&a.onCancel.call(c.get(0));c.trigger("close");return!1});a.onSubmit&&c.find("form").unbind("submit").submit(function(e){a.disableButtonsOnSubmit&&c.find("input[type=submit]").attr("disabled","disabled");try{return a.onSubmit.apply(this,[c,e])}catch(h){throw e.preventDefault(),h;}});c.unbind("wa-resize").bind("wa-resize",function(){var e=jQuery(this).find(".dialog-window"),h=e.width(),k=e.height();jQuery("body").css("min-height",k+"px");var l=jQuery(window).width(),m=jQuery(window).height()-
60;h=(l-h)/2/l;k=(m-k-60)/2/m;0>k&&(k=0);0>h&&(h=0);e.css({left:a.offsetLeft||Math.round(100*h)+"%",top:a.offsetTop||Math.round(100*k)+"%"})}).trigger("wa-resize");a.esc&&c.unbind("esc").bind("esc",function(){c.trigger("close")});return c};jQuery(window).resize(function(){jQuery(".dialog:visible").trigger("wa-resize")});jQuery(document).keyup(function(a){27==a.keyCode&&jQuery(".dialog:visible").trigger("esc")});/*
 (c) 2008-2009 Benjamin Arthur Lupton {@link http://www.balupton.com}
 @license GNU Affero General Public License - {@link http://www.gnu.org/licenses/agpl.html}
 @example Visit {@link http://jquery.com/plugins/project/jquery_history_bal} for more information.


 I would like to take this space to thank the following projects, blogs, articles and people:
 - jQuery {@link http://jquery.com/}
 - jQuery UI History - Klaus Hartl {@link http://www.stilbuero.de/jquery/ui_history/}
 - Really Simple History - Brian Dillard and Brad Neuberg {@link http://code.google.com/p/reallysimplehistory/}
 - jQuery History Plugin - Taku Sano (Mikage Sawatari) {@link http://www.mikage.to/jquery/jquery_history.html}
 - jQuery History Remote Plugin - Klaus Hartl {@link http://stilbuero.de/jquery/history/}
 - Content With Style: Fixing the back button and enabling bookmarking for ajax apps - Mike Stenhouse {@link http://www.contentwithstyle.co.uk/Articles/38/fixing-the-back-button-and-enabling-bookmarking-for-ajax-apps}
 - Bookmarks and Back Buttons {@link http://ajax.howtosetup.info/options-and-efficiencies/bookmarks-and-back-buttons/}
 - Ajax: How to handle bookmarks and back buttons - Brad Neuberg {@link http://dev.aol.com/ajax-handling-bookmarks-and-back-button}

*
**
 CHANGELOG
*
 v1.0.1-final, July 11, 2009
 - Restructured a little bit
 - Documented
 - Cleaned go/request

 v1.0.0-final, June 19, 2009
 - Been stable for over a year now, pushing live.

 v0.1.0-dev, July 24, 2008
 - Initial Release

*/
(function(a){"undefined"===typeof console&&(console="undefined"!==typeof window.console?window.console:{});console.log=console.log||function(){};console.debug=console.debug||console.log;console.warn=console.warn||console.log;console.error=console.error||function(){for(var c=[],d=0;d<arguments.length;d++)c.push(arguments[d]);alert(c.join("\n"))};console.trace=console.trace||console.log;console.group=console.group||console.log;console.groupEnd=console.groupEnd||console.log;console.profile=console.profile||
console.log;console.profileEnd=console.profileEnd||console.log;a.History={options:{debug:!1},state:"",$window:null,$iframe:null,handlers:{generic:[],specific:{}},format:function(c){return c=c.replace(/^.+?#/g,"").replace(/^#?\/?|\/?$/g,"")},getState:function(){return a.History.state},setState:function(c){var d=a.History;c=d.format(c);d.state=c;return d.state},getHash:function(){var c=parent&&!a.browser.msie?parent.window.location.hash:window.location.hash||location.hash;return c=a.History.format(c)},
setHash:function(c){c=a.History.format(c);c=c.replace(/^\/?|\/?(\?)|\/?$/g,"/$1");"undefined"===typeof window.location.hash&&(location.hash=c);a.browser.msie&&8>parseInt(a.browser.version,10)&&(a.History.$iframe.contentWindow.document.open(),a.History.$iframe.contentWindow.document.close())},go:function(c){var d=a.History;c=d.format(c);d.getHash()!==c?d.setHash(c):(d.setState(c),d.trigger());return!0},hashchange:function(c){var d=a.History;d.options.debug&&console.debug("History.hashchange",this,
arguments);var g=d.getHash(),f=d.getState();if(!d.$iframe&&f===g||d.$iframe&&d.hash===d.$iframe.contentWindow.document.location.hash||f===g)return!1;d.setState(g);d.trigger();return!0},bind:function(c,d){var g=a.History;d?("undefined"===typeof g.handlers.specific[c]&&(g.handlers.specific[c]=[]),g.handlers.specific[c].push(d)):g.handlers.generic.push(c);return!0},trigger:function(c){var d=a.History;"undefined"===typeof c&&(c=d.getState());var g;if("undefined"!==typeof d.handlers.specific[c]){var f=
d.handlers.specific[c];var b=0;for(g=f.length;b<g;++b){var e=f[b];e(c)}}f=d.handlers.generic;b=0;for(g=f.length;b<g;++b)e=f[b],e(c);return!0},construct:function(){var c=a.History;a(document).ready(function(){c.domReady()});return!0},configure:function(c){var d=a.History;d.options=a.extend(d.options,c);return!0},domReadied:!1,domReady:function(){var c=a.History;if(!c.domRedied)return c.domRedied=!0,c.$window=a(window),c.$window.bind("hashchange",this.hashchange),setTimeout(c.hashchangeLoader,200),
!0},hashchangeLoader:function(){var c=a.History;if(a.browser.msie&&8<=parseInt(a.browser.version))(d=c.getHash())&&c.$window.trigger("hashchange");else{if(a.browser.msie){c.$iframe=a('<iframe id="jquery-history-iframe" style="display: none;"></$iframe>').prependTo(document.body)[0];c.$iframe.contentWindow.document.open();c.$iframe.contentWindow.document.close();var d=c.getHash();d&&(c.$iframe.contentWindow.document.location.hash=d);d=function(){var g=c.format(c.$iframe.contentWindow.document.location.hash);
c.getState()!==g&&c.setHash(c.$iframe.contentWindow.document.location.hash);g=c.getHash();c.getState()!==g&&c.go(g)}}else d=function(){var g=c.getHash();c.getState()!==g&&c.go(g)};a.browser.msie&&8>parseInt(a.browser.version)?setInterval(d,1500):setInterval(d,200)}return!0}};a.History.construct()})(jQuery);jQuery.JSON={useHasOwn:{}.hasOwnProperty?!0:!1,pad:function(a){return 10>a?"0"+a:a},m:{"\b":"\\b","\t":"\\t","\n":"\\n","\f":"\\f","\r":"\\r",'"':'\\"',"\\":"\\\\"},encodeString:function(a){return/["\\\x00-\x1f]/.test(a)?'"'+a.replace(/([\x00-\x1f\\"])/g,function(c,d){if(c=jQuery.JSON.m[d])return c;c=d.charCodeAt();return"\\u00"+Math.floor(c/16).toString(16)+(c%16).toString(16)})+'"':'"'+a+'"'},encodeArray:function(a){var c=["["],d,g=a.length;for(d=0;d<g;d+=1){var f=a[d];switch(typeof f){case "undefined":case "function":case "unknown":break;
default:b&&c.push(",");c.push(null===f?"null":this.encode(f));var b=!0}}c.push("]");return c.join("")},encodeDate:function(a){return'"'+a.getFullYear()+"-"+pad(a.getMonth()+1)+"-"+pad(a.getDate())+"T"+pad(a.getHours())+":"+pad(a.getMinutes())+":"+pad(a.getSeconds())+'"'},encode:function(a){if("undefined"==typeof a||null===a)return"null";if(a instanceof Array)return this.encodeArray(a);if(a instanceof Date)return this.encodeDate(a);if("string"==typeof a)return this.encodeString(a);if("number"==typeof a)return isFinite(a)?
String(a):"null";if("boolean"==typeof a)return String(a);var c=["{"],d;for(d in a)if(!this.useHasOwn||a.hasOwnProperty(d)){var g=a[d];switch(typeof g){case "undefined":case "function":case "unknown":break;default:f&&c.push(",");c.push(this.encode(d),":",null===g?"null":this.encode(g));var f=!0}}c.push("}");return c.join("")},decode:function(a){return eval("("+a+")")}};(function(a,c){a.store=function(d,g){var f=this;if("string"==typeof d)if(a.store.drivers[d])this.driver=a.store.drivers[d];else throw Error("Unknown driver "+d);else if("object"==typeof d){if(!(a.isFunction(d.init)&&a.isFunction(d.get)&&a.isFunction(d.set)&&a.isFunction(d.del)&&a.isFunction(d.flush)))throw Error("The specified driver does not fulfill the API requirements");this.driver=d}else a.each(a.store.drivers,function(){if(!a.isFunction(this.available)||!this.available())return!0;f.driver=this;
return!1===f.driver.init()?(f.driver=null,!0):!1});g||(g=a.store.serializers);this.serializers={};a.each(g,function(b,e){if(!a.isFunction(this.init))return!0;f.serializers[b]=this;f.serializers[b].init(f.encoders,f.decoders)})};a.extend(a.store.prototype,{get:function(d){d=this.driver.get(d);return this.driver.encodes?d:this.unserialize(d)},set:function(d,g){this.driver.set(d,this.driver.encodes?g:this.serialize(g))},del:function(d){this.driver.del(d)},flush:function(){this.driver.flush()},driver:c,
encoders:[],decoders:[],serialize:function(d){var g=this;a.each(this.encoders,function(){var f=g.serializers[this+""];if(!f||!f.encode)return!0;try{d=f.encode(d)}catch(b){}});return d},unserialize:function(d){var g=this;if(!d)return d;a.each(this.decoders,function(){var f=g.serializers[this+""];if(!f||!f.decode)return!0;d=f.decode(d)});return d}});a.store.drivers={localStorage:{ident:"$.store.drivers.localStorage",scope:"browser",available:function(){try{return!!window.localStorage}catch(d){return!1}},
init:a.noop,get:function(d){return window.localStorage.getItem(d)},set:function(d,g){window.localStorage.setItem(d,g)},del:function(d){window.localStorage.removeItem(d)},flush:function(){window.localStorage.clear()}},userData:{ident:"$.store.drivers.userData",element:null,nodeName:"userdatadriver",scope:"browser",initialized:!1,available:function(){try{return!(!document.documentElement||!document.documentElement.addBehavior)}catch(d){return!1}},init:function(){if(!this.initialized)try{this.element=
document.createElement(this.nodeName),document.documentElement.insertBefore(this.element,document.getElementsByTagName("title")[0]),this.element.addBehavior("#default#userData"),this.initialized=!0}catch(d){return!1}},get:function(d){this.element.load(this.nodeName);return this.element.getAttribute(d)},set:function(d,g){this.element.setAttribute(d,g);this.element.save(this.nodeName)},del:function(d){this.element.removeAttribute(d);this.element.save(this.nodeName)},flush:function(){this.element.expires=
(new Date).toUTCString();this.element.save(this.nodeName)}},windowName:{ident:"$.store.drivers.windowName",scope:"window",cache:{},encodes:!0,available:function(){return!0},init:function(){this.load()},save:function(){window.name=a.store.serializers.json.encode(this.cache)},load:function(){try{this.cache=a.store.serializers.json.decode(window.name+""),"object"!=typeof this.cache&&(this.cache={})}catch(d){this.cache={},window.name="{}"}},get:function(d){return this.cache[d]},set:function(d,g){this.cache[d]=
g;this.save()},del:function(d){try{delete this.cache[d]}catch(g){this.cache[d]=c}this.save()},flush:function(){window.name="{}"}}};a.store.serializers={json:{ident:"$.store.serializers.json",init:function(d,g){d.push("json");g.push("json")},encode:"object"==typeof JSON?JSON.stringify:a.JSON.stringify,decode:"object"==typeof JSON?JSON.parse:a.JSON.parse},xml:{ident:"$.store.serializers.xml",init:function(d,g){d.unshift("xml");g.push("xml")},isXML:function(d){return(d=(d?d.ownerDocument||d:0).documentElement)?
"html"!==d.nodeName.toLowerCase():!1},encode:function(d){if(!d||d._serialized||!this.isXML(d))return d;var g={_serialized:this.ident,value:d};try{return g.value=(new XMLSerializer).serializeToString(d),g}catch(f){try{return g.value=d.xml,g}catch(b){}}return d},decode:function(d){if(!d||!d._serialized||d._serialized!=this.ident)return d;var g="DOMParser"in window&&(new DOMParser).parseFromString;!g&&window.ActiveXObject&&(g=function(f){var b=new ActiveXObject("Microsoft.XMLDOM");b.async="false";b.loadXML(f);
return b});if(!g)return c;d.value=g.call("DOMParser"in window&&new DOMParser||window,d.value,"text/xml");return this.isXML(d.value)?d.value:c}}}})(jQuery);(function(a){function c(g,f){this.path=g;"undefined"!==typeof f&&null!==f?(this.at_2x_path=f,this.perform_check=!1):(this.at_2x_path=g.replace(/\.\w+$/,function(b){return"@2x"+b}),this.perform_check=!0)}function d(g){if(!/@2x\.\w+$/.test(a(g).attr("src"))){this.el=g;this.path=new c(a(g).attr("src"),a(g).attr("data-at2x"));var f=this;this.path.check_2x_variant(function(b){b&&f.swap()})}}a.fn.retina=function(g){if(a.Retina.isRetina())return a.Retina.opts=a.extend(a.Retina.opts,g),this.each(function(){a(this).is("img")&&
new d(this)})};a.Retina=function(){};a.Retina.opts={check_mime_type:!0,force_original_dimensions:!0};a.Retina.isRetina=function(){return 1<window.devicePixelRatio||window.matchMedia&&window.matchMedia("(-webkit-min-device-pixel-ratio: 1.5),(min--moz-device-pixel-ratio: 1.5),(-o-min-device-pixel-ratio: 3/2),(min-resolution: 1.5dppx)").matches?!0:!1};c.confirmed_paths=[];c.prototype.is_external=function(){return!(!this.path.match(/^(https?:|\/\/)/i)||this.path.match("//"+document.domain+"/"))};c.prototype.check_2x_variant=
function(g){var f=this;if(this.is_external()||!this.perform_check&&"undefined"!==typeof this.at_2x_path&&null!==this.at_2x_path||this.at_2x_path in c.confirmed_paths)return g(!0);var b=new XMLHttpRequest;b.open("HEAD",this.at_2x_path);b.onreadystatechange=function(){if(4==b.readyState&&200<=b.status&&399>=b.status){if(a.Retina.opts.check_mime_type){var e=b.getResponseHeader("Content-Type");if(null===e||!e.match(/^image/i))return g(!1)}c.confirmed_paths.push(f.at_2x_path);return g(!0)}return g(!1)};
b.send()};a.RetinaImage=d;d.prototype.swap=function(g){function f(){if(b.el.complete){a.Retina.opts.force_original_dimensions&&(b.el.setAttribute("width",b.el.offsetWidth),b.el.setAttribute("height",b.el.offsetHeight));var e=b.el.src;b.el.setAttribute("src",g);a(b.el).one("error",function(){b.el.setAttribute("src",e)})}else setTimeout(f,5)}"undefined"==typeof g&&(g=this.path.at_2x_path);var b=this;f()}})(jQuery);(function(a){a.fn.extend({autocomplete:function(c,d){var g="string"==typeof c;d=a.extend({},a.Autocompleter.defaults,{url:g?c:null,data:g?null:c,delay:g?a.Autocompleter.defaults.delay:10,max:d&&!d.scroll?10:150},d);d.highlight=d.highlight||function(f){return f};d.formatMatch=d.formatMatch||d.formatItem;return this.each(function(){new a.Autocompleter(this,d)})},result:function(c){return this.bind("result",c)},search:function(c){return this.trigger("search",[c])},flushCache:function(){return this.trigger("flushCache")},
setOptions:function(c){return this.trigger("setOptions",[c])},unautocomplete:function(){return this.trigger("unautocomplete")}});a.Autocompleter=function(c,d){function g(){var w=x.selected();if(!w)return!1;var y=w.result;q=y;if(d.multiple){var B=b(p.val());if(1<B.length){var z=d.multipleSeparator.length,E=a(c).selection().start,C,D=0;a.each(B,function(G,F){D+=F.length;if(E<=D)return C=G,!1;D+=z});B[C]=y;y=B.join(d.multipleSeparator)}y+=d.multipleSeparator}p.val(y);h();p.trigger("result",[w.data,w.value]);
return!0}function f(w,y){if(r==m.DEL)x.hide();else if(w=p.val(),y||w!=q)q=w,w=e(w),w.length>=d.minChars?(p.addClass(d.loadingClass),d.matchCase||(w=w.toLowerCase()),l(w,k,h)):(p.removeClass(d.loadingClass),x.hide())}function b(w){return w?d.multiple?a.map(w.split(d.multipleSeparator),function(y){return a.trim(w).length?a.trim(y):null}):[a.trim(w)]:[""]}function e(w){if(!d.multiple)return w;var y=b(w);if(1==y.length)return y[0];y=a(c).selection().start;y=y==w.length?b(w):b(w.replace(w.substring(y),
""));return y[y.length-1]}function h(){x.visible();x.hide();clearTimeout(n);p.removeClass(d.loadingClass);d.mustMatch&&p.search(function(w){w||(d.multiple?(w=b(p.val()).slice(0,-1),p.val(w.join(d.multipleSeparator)+(w.length?d.multipleSeparator:""))):(p.val(""),p.trigger("result",null)))})}function k(w,y){y&&y.length&&u?(p.removeClass(d.loadingClass),x.display(y,w),y=y[0].value,d.autoFill&&e(p.val()).toLowerCase()==w.toLowerCase()&&r!=m.BACKSPACE&&(p.val(p.val()+y.substring(e(q).length)),a(c).selection(q.length,
q.length+y.length)),x.show()):h()}function l(w,y,B){d.matchCase||(w=w.toLowerCase());var z=t.load(w);if(z&&z.length)y(w,z);else if("string"==typeof d.url&&0<d.url.length){var E={timestamp:+new Date};a.each(d.extraParams,function(C,D){E[C]="function"==typeof D?D():D});a.ajax({mode:"abort",port:"autocomplete"+c.name,dataType:d.dataType,url:d.url,data:a.extend({q:e(w),limit:d.max},E),success:function(C){var D;if(!(D=d.parse&&d.parse(C))){D=[];C=C.split("\n");for(var G=0;G<C.length;G++){var F=a.trim(C[G]);
F&&(F=F.split("|"),D[D.length]={data:F,value:F[0],result:d.formatResult&&d.formatResult(F,F[0])||F[0]})}}t.add(w,D);y(w,D)}})}else x.emptyList(),B(w)}var m={UP:38,DOWN:40,DEL:46,TAB:9,RETURN:13,ESC:27,COMMA:188,PAGEUP:33,PAGEDOWN:34,BACKSPACE:8},p=a(c).attr("autocomplete","off").addClass(d.inputClass),n,q="",t=a.Autocompleter.Cache(d),u=0,r,v={mouseDownOnSelect:!1},x=a.Autocompleter.Select(d,c,g,v),A;a.browser.opera&&a(c.form).bind("submit.autocomplete",function(){if(A)return A=!1});p.bind((a.browser.opera?
"keypress":"keydown")+".autocomplete",function(w){u=1;r=w.keyCode;switch(w.keyCode){case m.UP:w.preventDefault();x.visible()?x.prev():f(0,!0);break;case m.DOWN:w.preventDefault();x.visible()?x.next():f(0,!0);break;case m.PAGEUP:w.preventDefault();x.visible()?x.pageUp():f(0,!0);break;case m.PAGEDOWN:w.preventDefault();x.visible()?x.pageDown():f(0,!0);break;case d.multiple&&","==a.trim(d.multipleSeparator)&&m.COMMA:case m.TAB:case m.RETURN:if(g())return w.preventDefault(),A=!0,!1;break;case m.ESC:x.hide();
break;default:clearTimeout(n),n=setTimeout(f,d.delay)}}).focus(function(){u++}).blur(function(){u=0;v.mouseDownOnSelect||(clearTimeout(n),n=setTimeout(h,200))}).click(function(){1<u++&&!x.visible()&&f(0,!0)}).bind("search",function(){function w(B,z){if(z&&z.length)for(var E=0;E<z.length;E++)if(z[E].result.toLowerCase()==B.toLowerCase()){var C=z[E];break}"function"==typeof y?y(C):p.trigger("result",C&&[C.data,C.value])}var y=1<arguments.length?arguments[1]:null;a.each(b(p.val()),function(B,z){l(z,
w,w)})}).bind("flushCache",function(){t.flush()}).bind("setOptions",function(w,y){a.extend(d,y);"data"in y&&t.populate()}).bind("unautocomplete",function(){x.unbind();p.unbind();a(c.form).unbind(".autocomplete")})};a.Autocompleter.defaults={inputClass:"ac_input",resultsClass:"ac_results",loadingClass:"ac_loading",minChars:1,delay:400,matchCase:!1,matchSubset:!0,matchContains:!1,cacheLength:10,max:100,mustMatch:!1,extraParams:{},selectFirst:!0,formatItem:function(c){return c[0]},formatMatch:null,autoFill:!1,
width:0,multiple:!1,multipleSeparator:", ",highlight:function(c,d){return c.replace(new RegExp("(?![^&;]+;)(?!<[^<>]*)("+d.replace(/([\^\$\(\)\[\]\{\}\*\.\+\?\|\\])/gi,"\\$1")+")(?![^<>]*>)(?![^&;]+;)","gi"),"<strong>$1</strong>")},scroll:!0,scrollHeight:180};a.Autocompleter.Cache=function(c){function d(k,l){c.matchCase||(k=k.toLowerCase());var m=k.indexOf(l);"word"==c.matchContains&&(m=k.toLowerCase().search("\\b"+l.toLowerCase()));return-1==m?!1:0==m||c.matchContains}function g(k,l){h>c.cacheLength&&
b();e[k]||h++;e[k]=l}function f(){if(!c.data)return!1;var k={},l=0;c.url||(c.cacheLength=1);k[""]=[];for(var m=0,p=c.data.length;m<p;m++){var n=c.data[m];n="string"==typeof n?[n]:n;var q=c.formatMatch(n,m+1,c.data.length);if(!1!==q){var t=q.charAt(0).toLowerCase();k[t]||(k[t]=[]);n={value:q,data:n,result:c.formatResult&&c.formatResult(n)||q};k[t].push(n);l++<c.max&&k[""].push(n)}}a.each(k,function(u,r){c.cacheLength++;g(u,r)})}function b(){e={};h=0}var e={},h=0;setTimeout(f,25);return{flush:b,add:g,
populate:f,load:function(k){if(!c.cacheLength||!h)return null;if(!c.url&&c.matchContains){var l=[],m;for(m in e)if(0<m.length){var p=e[m];a.each(p,function(n,q){d(q.value,k)&&l.push(q)})}return l}if(e[k])return e[k];if(c.matchSubset)for(m=k.length-1;m>=c.minChars;m--)if(p=e[k.substr(0,m)])return l=[],a.each(p,function(n,q){d(q.value,k)&&(l[l.length]=q)}),l;return null}}};a.Autocompleter.Select=function(c,d,g,f){function b(){q&&(t=a("<div/>").hide().addClass(c.resultsClass).css("position","absolute").appendTo(document.body),
u=a("<ul/>").appendTo(t).mouseover(function(r){e(r).nodeName&&"LI"==e(r).nodeName.toUpperCase()&&(m=a("li",u).removeClass(k.ACTIVE).index(e(r)),a(e(r)).addClass(k.ACTIVE))}).click(function(r){a(e(r)).addClass(k.ACTIVE);g();d.focus();return!1}).mousedown(function(){f.mouseDownOnSelect=!0}).mouseup(function(){f.mouseDownOnSelect=!1}),0<c.width&&t.css("width",c.width),q=!1)}function e(r){for(r=r.target;r&&"LI"!=r.tagName;)r=r.parentNode;return r?r:[]}function h(r){l.slice(m,m+1).removeClass(k.ACTIVE);
m+=r;0>m?m=l.size()-1:m>=l.size()&&(m=0);r=l.slice(m,m+1).addClass(k.ACTIVE);if(c.scroll){var v=0;l.slice(0,m).each(function(){v+=this.offsetHeight});v+r[0].offsetHeight-u.scrollTop()>u[0].clientHeight?u.scrollTop(v+r[0].offsetHeight-u.innerHeight()):v<u.scrollTop()&&u.scrollTop(v)}}var k={ACTIVE:"ac_over"},l,m=-1,p,n="",q=!0,t,u;return{display:function(r,v){b();p=r;n=v;u.empty();r=p.length;r=c.max&&c.max<r?c.max:r;for(v=0;v<r;v++)if(p[v]){var x=c.formatItem(p[v].data,v+1,r,p[v].value,n);!1!==x&&
(x=a("<li/>").html(c.highlight(x,n)).addClass(0==v%2?"ac_even":"ac_odd").appendTo(u)[0],a.data(x,"ac_data",p[v]))}l=u.find("li");c.selectFirst&&(l.slice(0,1).addClass(k.ACTIVE),m=0);a.fn.bgiframe&&u.bgiframe()},next:function(){h(1)},prev:function(){h(-1)},pageUp:function(){0!=m&&0>m-8?h(-m):h(-8)},pageDown:function(){m!=l.size()-1&&m+8>l.size()?h(l.size()-1-m):h(8)},hide:function(){t&&t.hide();l&&l.removeClass(k.ACTIVE);m=-1},visible:function(){return t&&t.is(":visible")},current:function(){return this.visible()&&
(l.filter("."+k.ACTIVE)[0]||c.selectFirst&&l[0])},show:function(){var r=a(d).offset();t.css({width:"string"==typeof c.width||0<c.width?c.width:a(d).width(),top:r.top+d.offsetHeight,left:r.left}).show();if(c.scroll&&(u.scrollTop(0),u.css({maxHeight:c.scrollHeight,overflow:"auto"}),a.browser.msie&&"undefined"===typeof document.body.style.maxHeight)){var v=0;l.each(function(){v+=this.offsetHeight});r=v>c.scrollHeight;u.css("height",r?c.scrollHeight:v);r||l.width(u.width()-parseInt(l.css("padding-left"))-
parseInt(l.css("padding-right")))}},selected:function(){var r=l&&l.filter("."+k.ACTIVE).removeClass(k.ACTIVE);return r&&r.length&&a.data(r[0],"ac_data")},emptyList:function(){u&&u.empty()},unbind:function(){t&&t.remove()}}};a.fn.selection=function(c,d){if(void 0!==c)return this.each(function(){if(this.createTextRange){var h=this.createTextRange();void 0===d||c==d?h.move("character",c):(h.collapse(!0),h.moveStart("character",c),h.moveEnd("character",d));h.select()}else this.setSelectionRange?this.setSelectionRange(c,
d):this.selectionStart&&(this.selectionStart=c,this.selectionEnd=d)});var g=this[0];if(g.createTextRange){var f=document.selection.createRange(),b=g.value,e=f.text.length;f.text="<->";f=g.value.indexOf("<->");g.value=b;this.selection(f,f+e);return{start:f,end:f+e}}if(void 0!==g.selectionStart)return{start:g.selectionStart,end:g.selectionEnd}}})(jQuery);(function(a){a.photos_sidebar={width:200,options:{},init:function(c){var d=this;this.options=c||{};c.width&&(this.width=c.width);this.initCollapsible();this.initHandlers();this.initView();setTimeout(function(){d.initFixedSidebar()},1E3)},initFixedSidebar:function(){var c=a(window),d=a("#wa-app"),g=d.find(".p-sidebar-wrapper"),f=g.find(".p-sidebar-block"),b=c.height(),e=f.offset().top,h=!1,k=!1,l=!1,m=0;c.on("scroll",function(){var p=c.scrollTop(),n=f.outerHeight(),q=d.height(),t=f.offset().top,u=
m>p?1:-1,r=p-e,v=f.width(),x=n+parseInt(g.css("padding-top"))+parseInt(g.css("padding-bottom"))>=q;if(q>b&&!x)if(n<b)0<r?((h||!k||l)&&f.removeAttr("style").width(v).addClass("fixed-to-top"),l=!0):f.removeAttr("style").removeClass("fixed-to-bottom").removeClass("fixed-to-top");else if(p<=e){if(h||k||l)f.removeAttr("style").removeClass("fixed-to-bottom").removeClass("fixed-to-top"),h=k=l=!1}else if(p<=t&&t>=e)if(0<u){if(h||!l||k)f.removeAttr("style").width(v).removeClass("fixed-to-bottom").addClass("fixed-to-top"),
h=k=!1,l=!0}else{if(!h||l||k)f.css("top",t-e).removeClass("fixed-to-top").removeClass("fixed-to-bottom"),h=!0,l=k=!1}else if(p+b>=t+n)if(0<u){if(!h||l||k)f.css("top",t-e).removeClass("fixed-to-top").removeClass("fixed-to-bottom"),h=!0,l=k=!1}else{if(h||l||!k)f.removeAttr("style").width(v).removeClass("fixed-to-top").addClass("fixed-to-bottom"),h=l=!1,k=!0}else{if(!h||l||k)f.css("top",t-e).removeClass("fixed-to-top").removeClass("fixed-to-bottom"),h=!0,l=k=!1}else if(h||l||k)f.removeAttr("style").removeClass("fixed-to-bottom").removeClass("fixed-to-top"),
h=l=k=!1;m=p})},initView:function(){var c=a("#p-sidebar"),d=a("#p-sidebar-width-control");d.find("a.arrow").unbind("click").bind("click",function(){var g=c.attr("class"),f=0,b=g.match(/left([\d]{2,3})px/);if(b&&b[1]&&(f=parseInt(b[1]))&&(b=f+(a(this).is(".right")?50:-50),b=Math.max(Math.min(b,400),200),b!=f)){d.css({width:b.toString()+"px"});f=["left"+f+"px","left"+b+"px"];c.attr("class",g.replace(f[0],f[1]));c.css("width","");var e=a("#p-content");e.length&&(g=e.attr("class"),e.attr("class",g.replace(f[0],
f[1])),e.css("margin-left",""));a.photos_sidebar.width=b;a.post("?action=sidebarSaveWidth",{width:b},"json")}return!1})},initCollapsible:function(){a("#p-sidebar").off("click",".collapse-handler").on("click",".collapse-handler",function(){a.photos_sidebar._collapseSidebarSection(this,"toggle")});a("#p-sidebar .collapse-handler").each(function(){a.photos_sidebar._collapseSidebarSection(this,"restore")});a("#album-list-container").die("uncollapse_section").live("uncollapse_section",function(c,d){d=
a(d);c=a(this).find(">.collapse-handler");var g=d.find(">i.collapse-handler");a.photos_sidebar._collapseSidebarSection(g,"uncollapse");for(d=d.parent().parent();d.length&&d.get(0)!=this;){g=d.find(">i.collapse-handler");if(!g.length)break;a.photos_sidebar._collapseSidebarSection(g,"uncollapse");d=d.parent().parent()}a.photos_sidebar._collapseSidebarSection(c,"uncollapse")})},initHandlers:function(){a("#p-upload-link").click(function(){a.photos.uploadDialog();return!1});a("#album-list-container").off("click",
".p-new-album").on("click",".p-new-album",function(){var c=a(this),d=0;c.is("#p-new-album")||(d=parseInt(c.parents("li:first").attr("rel"),10)||0);c=a("#album-create-dialog-acceptor");c.length||(c=a("<div id='album-create-dialog-acceptor'></div>"),a("body").append(c));c.load("?module=dialog&action=createAlbum&parent_id="+d,function(){a("#album-create-dialog").waDialog({onLoad:function(g){a(this).find("input[type=text]").val("")},onSubmit:function(g){var f=a(this);a.post(f.attr("action"),f.serialize(),
function(b){"ok"==b.status&&(a.photos.onCreateAlbum(b.data,d),g.trigger("close"),b.data.id&&a.photos.goToHash("/album/"+b.data.id))},"json");return!1}})});return!1})},countSubtree:function(c){var d=c.find(">.count:not(.subtree)"),g=c.find(">.subtree");g.length||(g=d.clone().addClass("subtree").hide(),d.after(g));var f=parseInt(d.text(),10)||0;c.find("li.static>.count:not(.subtree)").each(function(){var b=parseInt(a(this).text(),10)||0;f+=b});g.hasClass("never-recount")||g.text(f);g.show();d.hide();
return f},countItem:function(c){var d=c.find(">.count:not(.subtree)").show();c.find(">.subtree").hide();return parseInt(d.text(),10)||0},_collapseSidebarSection:function(c,d){d||(d="coollapse");c=a(c);if(c.length){var g=c.hasClass("darr")||c.hasClass("rarr")?c:c.find(".darr, .rarr");if(g.length){var f=c.parent(),b=f.find(".hierarchical:first");b.length||(b=f.find(".collapsible-content:first"));b.length||(b=f.find("ul:first"));var e;c=c.attr("id")||c.parent().attr("id");var h=g.hasClass("darr")?"shown":
"hidden",k=function(){b.hide();g.removeClass("darr").addClass("rarr");a.photos_sidebar.countSubtree(f);e="hidden"},l=function(){b.show();g.removeClass("rarr").addClass("darr");a.photos_sidebar.countItem(f);e="shown"};switch(d){case "toggle":"shown"==h?k():l();break;case "restore":c&&("hidden"==a.storage.get("photos/collapsible/"+c)?k():l());break;case "uncollapse":l();break;default:k()}c&&e&&a.storage.set("photos/collapsible/"+c,e)}}}}})(jQuery);(function(a){function c(){var g=a.photos.getAlbum();return g&&g.type===Album.TYPE_STATIC&&!1!==g.edit_rights?!0:!1}function d(){a("#hint-menu-block").hide().children().hide()}a.photos_dragndrop={helper_shift:20,init:function(){this._extendJqueryUIDragAndDrop();this._initDragPhotos();this._initDropPhotos();this._initDragAlbums();this._initDropAlbums()},_initDragPhotos:function(){var g={opacity:.75,zIndex:9999,distance:5,appendTo:"body",cursor:"move",refreshPositions:!0,start:function(e,h){document.ondragstart=
function(){return!1};h.helper.data("scrollTop",a(document).scrollTop());a(document).bind("scroll",a.photos_dragndrop._scrolHelper);a("#album-list-container").addClass("p-drag-active")},stop:function(e,h){document.ondragstart=null;a(document).unbind("scroll",a.photos_dragndrop._scrolHelper);a("#album-list-container").removeClass("p-drag-active");d()},drag:function(e,h){e=e.originalEvent;h.position.left=e.pageX-a.photos_dragndrop.helper_shift;h.position.top=e.pageY}},f=g.start,b=g.stop;a("img",a("#photo-list")).liveDraggable(a.extend({},
g,{containment:[0,0,a(window).width(),{toString:function(){return a(document).height()}}],helper:function(e){e=a(this).parents("li:first");var h=a("#photo-list li.selected"),k=h.length?h.length:1,l=[e.attr("data-photo-id")],m=!1,p=e.get(0);h.each(function(){this!=p?l.push(a(this).attr("data-photo-id")):m=!0});!m&&h.length&&(e.addClass("selected").find("input:first").trigger("select",!0),++k);e.data("photo_ids",l);return'<div id="helper"><span class="indicator red">'+k+'</span><i class="icon10 no-bw" style="display:none;"></i></div>'},
handle:".p-image",start:function(e,h){f.apply(this,[e,h]);e=a(this).parents("li:first");1==e.data("photo_ids").length&&e.addClass("selected")},stop:function(e,h){b.apply(this,[e,h]);e=a(this).parents("li:first");1==e.data("photo_ids").length&&e.removeClass("selected")}}));a("#photo").liveDraggable(a.extend({},g,{containment:"body",start:function(e,h){if(!a(e.target).hasClass("ui-draggable"))return!1},helper:function(){return'<div id="helper"><span class="indicator red">1</span><i class="icon10 no-bw" style="display:none;"></i></div>'}}))},
_initDropPhotos:function(){a("li",a("#photo-list")).liveDroppable({disabled:!1,greedy:!0,tolerance:"pointer",over:function(g,f){if(f.draggable.hasClass("dr"))return!1;if(c())d();else if(g=a.photos.getOption("sort_method"))f=a("#hint-menu-block").show(),f.children().hide(),f.find("."+g).show();a.photos_dragndrop._activatePhotoListItem.call(this)},out:function(g,f){a.photos_dragndrop._unactivatePhotoListItem.call(this)},drop:function(g,f){g=c();var b=a.photos.getAlbum();f=f.draggable.parents("li:first");
var e=a(this);if(f.get(0)==this||e.hasClass("selected"))return a.photos_dragndrop._unactivatePhotoListItem.call(this),!1;var h=a("#photo-list li.selected");h.length||(h=f);a.photos_dragndrop._unactivatePhotoListItem.call(this);a.photos_dragndrop._unactivatePhotoListItem.call(f);if(!g)return!1;var k=parseInt(e.attr("data-photo-id"));e.hasClass("last")?(k=null,e.after(h),e.removeClass("last"),a("#photo-list li:last").addClass("last")):(e.before(h),f.hasClass("last")&&(f.removeClass("last"),a("#photo-list li:last").addClass("last")));
h.trigger("select",!1);var l=[];h.each(function(){l.push(parseInt(a(this).attr("data-photo-id")))});a.post("?module=album&action=photoMove",{photo_id:l,album_id:b.id,before_id:k},function(m){"ok"==m.status&&a.photos.photo_stream_cache.move(l,k)},"json")}})},_initDragAlbums:function(){var g=a("#wa-app > .sidebar"),f=g.position(),b=g.width();g=g.height();a("li.dr",a("#album-list")).liveDraggable({containment:[f.left,f.top,f.left+b+.25*b,f.top+g],refreshPositions:!0,revert:"invalid",helper:function(){var e=
a(this).clone().addClass("ui-draggable").css({position:"absolute"}).prependTo("#album-list > ul");e.find("a:first").append('<i class="icon10 no-bw" style="margin-left: 0; margin-right: 0; display:none;"></i>');return e},cursor:"move",cursorAt:{left:5},opacity:.75,zIndex:9999,distance:5,start:function(e,h){document.ondragstart=function(){return!1}},stop:function(){document.ondragstart=null}})},_initDropAlbums:function(){this._initDropBetweenAlbums();this._initDropInsideAlbums()},_initDropBetweenAlbums:function(){a("li.drag-newposition",
a("#album-list")).liveDroppable({accept:"li.dr",greedy:!0,tolerance:"pointer",over:function(g,f){if("IMG"==f.draggable.get(0).tagName)return!1;a(this).addClass("active").parent().parent().addClass("drag-active")},out:function(g,f){a(this).removeClass("active").parent().parent().removeClass("drag-active")},deactivate:function(g,f){var b=a(this);(b.is(":animated")||b.hasClass("dragging"))&&b.stop().animate({height:"0px"},300,null,function(){b.removeClass("dragging")});a(this).removeClass("active").parent().parent().removeClass("drag-active")},
drop:function(g,f){if("IMG"==f.draggable.get(0).tagName)return!1;var b=a(this).parent("ul");f=a(f.draggable);g=f.attr("rel");var e=a(this).prev("li");if(e.length&&e.attr("rel")==g&&!e.hasClass("ui-draggable")||this==f.next().get(0))return!1;b=b.parent("li").length?b.parent("li").attr("rel"):0;e=a(this).next();var h=null;e.length&&(h=e.attr("rel"));a.post("?module=album&action=move",{id:g,before_id:h,parent_id:b},function(k){var l=a.photos.getAlbum(),m=k.data.album,p=k.data.counters;0>=m.status&&a.photos_dragndrop.privateDescendants(m.id)&&
a.photos.dispatch("album/"+m.id+"/");l&&l.id==m.id&&((k=k.data.frontend_link)&&a("#photo-list-frontend-link").attr("href",k).text(k),m.type==Album.TYPE_DYNAMIC&&a.photos.load("?module=album&action=photos&id="+m.id,a.photos.onLoadPhotoList));if(!a.isEmptyObject(p))for(var n in p)p.hasOwnProperty(n)&&album_list.find("li[rel="+n+"]").find(".count:first").text(p[n])},"json");b=f.parent("ul");g=b.children("li.dr[rel!="+g+"]").length;f.next().insertAfter(a(this));f.insertAfter(a(this));g||(b.parent("li").children("i").remove(),
b.remove())}})},privateDescendants:function(g,f){f="boolean"===typeof f?f:!0;g=a("#album-list").find("li[rel="+g+"]");f=f?g:a();changed=!1;f.add(g.find("li.dr")).each(function(){var b=a(this).find(">a");if(!b.find("i.lock-bw").length){var e=b.find(".pictures").next();e.length?(changed=!0,e.before('<i class="icon10 lock-bw no-overhanging"></i>')):b.append('<i class="icon10 lock-bw no-overhanging"></i>')}});return changed},_initDropInsideAlbums:function(){a("li.dr a",a("#album-list")).liveDroppable({accept:function(g){return g.is("li.dr, img#photo")||
g.closest("li[data-photo-id]").length?!0:!1},tolerance:"custom",greedy:!0,out:function(g,f){a(this).parent().removeClass("drag-newparent");f.helper.find("span").show().end().find("i").hide()},over:function(g,f){g=a(this).parent();var b=!1;f.draggable=a.photos_dragndrop._fixUiDraggable(f.draggable);if(f.draggable.parents("#photo-list").length||f.draggable.is("#photo"))g.hasClass("static")?f.helper.find("span").show().end().find("i").hide():f.helper.find("span").hide().end().find("i").show(),b=!0;g.addClass("drag-newparent");
if(b)return!1;if(f.draggable.hasClass("static")&&!g.hasClass("static"))return f.helper.find("i.no-bw").show(),!1;f.helper.find("i.no-bw").hide();var e='.dr[rel!="'+a(f.draggable).attr("rel")+'"]',h=a(),k=function(m,p){if(0>=p.length)return m;m=m.add(p.nextUntil(e).filter("li.drag-newposition"));return 0<p.nextAll(e).length?m:k(m,p.parent().closest("li"))};f=g.prevAll(e).first();0<f.length?(b=f.find(e),h=0<b.length?k(h,b.last()):k(h,f)):h=h.add(g.prevUntil(e).filter("li.drag-newposition"));h=0<g.children("ul").children(e).length?
h.add(g.children("ul").children("li.drag-newposition:first")):k(h,g);var l=a(".drag-newposition:animated, .drag-newposition.dragging").not(h);l.stop().animate({height:"0px"},300,null,function(){l.removeClass("dragging")});h.stop().animate({height:"10px"},300,null,function(){h.addClass("dragging")})},drop:function(g,f){g=a(this).parent().removeClass("drag-newparent");f.draggable=a.photos_dragndrop._fixUiDraggable(f.draggable);if(f.draggable.parents("#photo-list").length||f.draggable.is("#photo")){var b=
this.href.match(/.*#\/album\/([\d]+)/);if(null===b||!parseInt(b[1],10)){console&&console.log("Link: "+this.href+" is not correct");return}b=parseInt(b[1],10);var e=null;g.hasClass("static")&&(e=f.draggable.is("#photo")?[a.photos.photo_stream_cache.getCurrent().id]:f.draggable.data("photo_ids"));e&&(a.photos.addToAlbums({photo_id:e,album_id:b}),a("#photo-list li.selected").trigger("select",!1));return!1}if(f.draggable.hasClass("static")&&!g.hasClass("static"))return!1;b=a(f.draggable);if(g.attr("rel")==
b.attr("rel"))return!1;g.hasClass("drag-newposition")?f=g.parent("ul"):g.children("ul").length?f=g.children("ul"):(f=a('<ul class="menu-v with-icons dr"><li class="drag-newposition"></li></ul>').appendTo(g),f.find(".drag-newposition").mouseover(),a('<i class="icon16 darr overhanging"></i>').insertBefore(g.children("a")));e=b.attr("rel");g=g.attr("rel");if(g==b.parent("ul").parent("li.dr").attr("rel"))return!1;a.post("?module=album&action=move",{id:e,parent_id:g},function(k){var l=a.photos.getAlbum(),
m=k.data.album,p=k.data.counters;0>=m.status&&a.photos_dragndrop.privateDescendants(m.id)&&a.photos.dispatch("album/"+m.id+"/");l&&l.id==m.id&&((k=k.data.frontend_link)&&a("#photo-list-frontend-link").attr("href",k).text(k),m.type==Album.TYPE_DYNAMIC&&a.photos.load("?module=album&action=photos&id="+m.id,a.photos.onLoadPhotoList));m=a("#album-list");if(!a.isEmptyObject(p))for(var n in p)p.hasOwnProperty(n)&&m.find("li[rel="+n+"]").find(".count:first").text(p[n])},"json");g=b.parent("ul");e=g.children("li.dr[rel!="+
e+"]").length;var h=b.next();b.appendTo(f);h.appendTo(f);e||(g.parent("li").children("i").remove(),g.remove())}})},_scrolHelper:function(g){g=a("#helper");var f=g.data("scrollTop"),b=a(document).scrollTop();f=f?b-f:50;g.css("top",g.position().top+f+"px");g.data("scrollTop",b)},_dropAnimation:function(g,f){var b=[];g.each(function(){var e=a(this),h=e.offset(),k=e.clone().css({"z-index":10,position:"absolute",top:h.top,left:h.left}).insertAfter(e);e.css({opacity:0});b.push(e.hide(300).promise());b.push(k.animate({top:h.top,
left:h.left},300).promise().done(function(){a(this).remove()}))});a.when.apply(a,b).done(function(){"function"===typeof f&&f()})},_shiftToLeft:function(g){if("left"!==g.data("shifted")){var f=g.find(".p-wrapper");if(!f.length){var b=g.children();f=a("<div class='p-wrapper' style='position:relative;'></div>").appendTo(g);f.append(b)}f.stop().animate({left:-15},200);g.data("shifted","left")}},_shiftToRight:function(g){if("right"!==g.data("shifted")){var f=g.find(".p-wrapper");if(!f.length){var b=g.children();
f=a("<div class='p-wrapper' style='position:relative;'></div>").appendTo(g);f.append(b)}f.stop().animate({left:15},200);g.data("shifted","right")}},_shiftAtPlace:function(g){if(g.data("shifted")){var f=g.find(".p-wrapper");if(f.length){var b=f.children();f.stop().css({left:0});g.append(b);f.remove()}g.data("shifted","")}},_bindExtDragActivate:function(g,f){a(document).bind("mousemove.ext_drag_activate",function(b){a.photos_dragndrop._extDragActivate(b,g,f)})},_unbindExtDragActivate:function(){a(document).unbind("mousemove.ext_drag_activate")},
_activatePhotoListItem:function(){var g=a(this),f=c(),b=f?"drag-active":"drag-active-disabled";f&&a.photos_dragndrop._shiftToRight(g);g.hasClass("last")?a.photos_dragndrop._bindExtDragActivate(g,b):g.addClass(b)},_unactivatePhotoListItem:function(g){g=a(this);var f=c(),b=f?"drag-active":"drag-active-disabled",e=b+"-last";g.hasClass("last")&&a.photos_dragndrop._unbindExtDragActivate();g.removeClass(b+" "+e);f&&a.photos_dragndrop._shiftAtPlace(g)},_extDragActivate:function(g,f,b){var e=b+"-last";if(f.hasClass("last")){var h=
g.pageX;g=g.pageY;var k=f.width(),l=f.height(),m=f.position();"template-photo-thumbs"==a.photos.list_template?h>m.left+.5*k&&h<=m.left+k?(f.removeClass(b).addClass(e),a.photos_dragndrop._shiftToLeft(f)):h>m.left&&h<=m.left+.5*k?(f.removeClass(e).addClass(b),a.photos_dragndrop._shiftToRight(f)):a.photos_dragndrop._shiftAtPlace(f):"template-photo-descriptions"==a.photos.list_template&&(g>m.top+.5*l?f.removeClass(b).addClass(e):g>m.top&&f.removeClass(e).addClass(b));(g<m.top||g>m.top+l||h<m.left||h>
m.left+k)&&f.removeClass(b).removeClass(e)}else f.addClass(b)},_fixUiDraggable:function(g){if(g.is("#photo"))return g;"IMG"==g.get(0).tagName&&(g=g.parents("li:first"));return g},_extendJqueryUIDragAndDrop:function(){a.fn.liveDraggable=function(f){this.each(function(e,h){e=a(this);e.data("init_draggable")&&e.die("mouseover",e.data("init_draggable"))});var b;this.live("mouseover",b=function(){var e=a(this);e.data("init_draggable")||e.data("init_draggable",b).draggable(f)})};a.fn.liveDroppable=function(f){this.each(function(e,
h){e=a(this);e.data("init_droppable")&&e.die("mouseover",e.data("init_droppable"))});var b=function(){var e=a(this);e.data("init_droppable")||(e.data("init_droppable",b).droppable(f),e.mouseover())};b.call(this);this.die("mouseover",b).live("mouseover",b);this.live("mouseover",b)};var g=a.ui.intersect;a.ui.intersect=function(f,b,e){a(f.element).is("#photo")||"custom"!=e||(e="pointer");if("custom"!=e)return g.call(a.ui,f,b,e);e=b.offset.left;var h=b.offset.top;f=f.helper.position();return a.ui.isOver(f.top,
f.left+a.photos_dragndrop.helper_shift,h,e,b.proportions.height,b.proportions.width)}}}})(jQuery);(function(a){var c=function(d,g){var f=/[^\w\-\.:]/.test(d)?new Function(c.arg+",tmpl","var _e=tmpl.encode"+c.helper+",_s='"+d.replace(c.regexp,c.func)+"';return _s;"):c.cache[d]=c.cache[d]||c(c.load(d));return g?f(g,c):function(b){return f(b,c)}};c.cache={};c.load=function(d){var g=document.getElementById(d),f=/<\\\/(\w+)/g;!g&&console&&console.log("template with id="+d+" not found");return g?("textarea"==g.tagName.toLowerCase()?g.value:document.getElementById(d).innerHTML).replace(f,"</$1"):null};
c.regexp=/([\s'\\])(?![^%]*%\})|(?:\{%(=|#)([\s\S]+?)%\})|(\{%)|(%\})/g;c.func=function(d,g,f,b,e,h){if(g)return{"\n":"\\n","\r":"\\r","\t":"\\t"," ":" "}[d]||"\\"+d;if(f)return"="===f?"'+_e("+b+")+'":"'+("+b+"||'')+'";if(e)return"';";if(h)return"_s+='"};c.encReg=/[<>&"'\x00]/g;c.encMap={"<":"&lt;",">":"&gt;","&":"&amp;",'"':"&quot;","'":"&#39;"};c.encode=function(d){return String(d||"").replace(c.encReg,function(g){return c.encMap[g]||""})};c.arg="o";c.helper=",print=function(s,e){_s+=e&&(s||'')||_e(s);},include=function(s,d){_s+=tmpl(s,d);}";
"function"===typeof define&&define.amd?define(function(){return c}):a.tmpl=c})(this);(function(a){a.fn.inlineEditable=function(c,d){function g(){m(a(this))||a(this).addClass(n.placeholderClass).text(n.placeholder)}function f(){m(a(this))==n.placeholder&&a(this).text("").removeClass(n.placeholderClass)}function b(r){return a(r).val()?!1:(a(this).text(n.placeholder).addClass(n.placeholderClass),!0)}function e(){t="edit";this.id=this.id||(""+Math.random()).slice(2);var r=this.id+"-input",v=a("#"+r);if(!v.length){var x=q,A=x.after;a:switch(n.inputType){case "textarea":var w='<textarea id="'+
r+'" style="display:none;"></textarea>';break a;default:w='<input type="text" id="'+r+'" style="display:none;">'}A.call(x,w);v=a("#"+r)}k(v,q);n.placeholder&&m(a(this))==n.placeholder&&f.call(q);n.beforeMakeEditable.call(this,v);u=n.truncate?q.data("real_text"):m(q);v.val(u).show().focus();q.hide();a(n.editLink).hide();if(!p){r=[];var y=[];x=0;for(A=n.makeReadableBy.length;x<A;++x)w=n.makeReadableBy[x],"blur"==w&&v.blur(function(){"read"!=t&&h.call(this)}),"enter"==w&&r.push(13),"esc"==w&&r.push(27);
x=0;for(A=n.updateBy.length;x<A;++x)w=n.updateBy[x],"alt+enter"==w&&y.push({ctrl:!1,alt:!0,shift:!1,key:13}),"ctrl+enter"==w&&y.push({ctrl:!0,alt:!1,shift:!1,key:13}),"ctrl+s"==w&&y.push({ctrl:!0,alt:!1,shift:!1,key:17});r.length&&function(B){v.keydown(function(z){!~B.indexOf(z.keyCode)||z.ctrlKey||z.altKey||z.shiftKey||"read"!=t&&h.call(this,27==z.keyCode?u:null);if(y.length)for(var E in y){var C=y[E];if(z.keyCode==C.key&&z.ctrlKey==C.ctrl&&z.altKey==C.alt&&z.shiftKey==C.shift){q.trigger("readable");
break}}})}(r);q.bind("readable",function(B,z){"read"!=t&&(B=a("#"+(this.id+"-input")),h.call(B,B.val(),z))});p=!0}}function h(r,v){v="undefined"===typeof v?!1:!0;void 0!=r&&null!=r?a(this).val(r):r=a(this).val();if(!1!==v||!1!==n.beforeBackReadable.call(q.get(0),this,{changed:r!=u,old_text:u,new_text:r})){t="read";if(!n.placeholder||!b.call(q,this))if(n.allowEmpty||r){if(n.truncate)q.data("real_text",r),q.text(r.length<n.truncate-3?r:r.substr(0,n.truncate-3)+"...");else{var x=q,A=r;n.html?x.html(A):
x.text(A)}r||g.call(this)}q.show();a(this).hide();a(n.editLink).show();!1===v&&n.afterBackReadable.call(q.get(0),this,{changed:r!=u,old_text:u})}}function k(r,v){var x=n.size.height||v.height();v=n.size.width||1.5*v.width();x=n.minSize.height&&x<n.minSize.height?n.minSize.height:x;v=n.minSize.width&&v<n.minSize.width?n.minSize.width:v;x=n.maxSize.height&&x>n.maxSize.height?n.maxSize.height:x;v=n.maxSize.width&&v>n.maxSize.width?n.maxSize.width:v;r.height(x);r.width(v)}function l(r){return function(){return r}}
function m(r){return n.html?r.html():r.text()}var p=!1;if("string"==typeof c){if("setOption"==c){var n=this.data("inlineEditableSettings")||{};a.extend(!0,n,d);"undefined"!==typeof d.hold&&"function"!==typeof d.hold&&(n.hold=l(n.hold));this.data("inlineEditableSettings",n)}return this}d=this.data("inlineEditableSettings");this.data("inlineEditableSettings",a.extend({inputType:"text",size:{height:null,width:null},minSize:{height:null,width:null},maxSize:{height:null,width:null},editLink:null,editOnItself:!0,
placeholder:null,makeReadableBy:["blur","enter","esc"],updateBy:["ctrl+enter","alt+enter"],beforeBackReadable:function(){},afterBackReadable:function(){},beforeMakeEditable:function(){},placeholderClass:"hint",truncate:!1,hold:!1,html:!1,allowEmpty:!1},d,c||{}));n=this.data("inlineEditableSettings");var q=this,t="read",u="";"function"!==typeof n.hold&&(n.hold=l(n.hold));(function(){if(!this.data("inited")){n.truncate&&"boolean"==typeof n.truncate&&(n.truncate=255);if(n.truncate){var r=n.placeholder&&
n.placeholder===this.text()?"":this.text();this.data("real_text",r);this.text(r.length<n.truncate-3?r:r.substr(0,n.truncate-3)+"...")}n.placeholder&&g.call(this);n.editLink&&a(n.editLink).click(function(){n.hold.call(q)||"edit"!=t&&e.call(q.get(0))});n.editOnItself&&this.click(function(){n.hold.call(q)||"edit"!=t&&e.call(this)});this.bind("editable",function(){n.hold.call(q)||"edit"!=t&&e.call(this)});this.bind("placeholder",function(v,x){x&&n.placeholder&&g.call(this);x||a(this).removeClass(n.placeholderClass)});
this.data("inited",!0)}}).call(this);return this}})(jQuery);(function(a){a.fn.activeMenu=function(c,d,g){if("string"==typeof c){if("disable"==c||"enable"==c)return a.isArray(d)||(d=[d]),this.find("li").each(function(){var e=a(this);~d.indexOf(e.attr("data-action"))&&("disable"==c?e.hide():e.show())}),this;if("setOption"==c){var f=this.data("activeMenuSettings");if(!f)return;if("string"===typeof d){var b={};b[d]=g;d=b}a.extend(f,d);return this}}if("string"==typeof c&&"fire"==c){f=this.data("activeMenuSettings");if(!f)return;f["on"+c.substr(0,1).toUpperCase()+
c.substr(1)].call(this);return this}this.data("activeMenuSettings",a.extend({beforeAnyAction:function(){},defaultAction:function(){},onInit:function(){},onFire:function(){}},c||{}));if(f=this.data("activeMenuSettings"))return function(){var e=this;this.data("inited")||(this.bind("click.photos-active-menu",function(h){for(var k=h.target,l=e.get(0);"LI"!=k.tagName;){if(k==l)return;k=a(k).parent().get(0)}k=a(k);l=k.attr("data-action")||"default";l=l.split("-");for(var m=1;m<l.length;m++)l[m]=l[m][0].toUpperCase()+
l[m].slice(1);l=l.join("");l+="Action";f[l]&&"function"==typeof f[l]||(l="defaultAction");if(!1!==f.beforeAnyAction(k.attr("data-action")))f[l](k,h);h.preventDefault()}),f.onInit(this),this.data("inited",!0))}.call(this),this}})(jQuery);(function(a){a.fn.rateWidget=function(c,d,g){function f(k){var l=0;this.find("i").removeClass("star star-empty star-half star-hover").addClass("star-empty").each(function(){if(l==k)return!1;l++;l>k?.5==l-k&&a(this).removeClass("star-empty").addClass("star-half"):a(this).removeClass("star-empty").addClass("star")});this.attr("data-rate",k)}function b(k){return function(){return k}}if("string"==typeof c){if("getOption"==c&&"rate"==d)return parseInt(this.attr("data-rate"));if("setOption"==c&&("rate"==
d&&(c=parseFloat(g)||0,f.call(this,Math.round(2*c)/2),d={rate:g}),"object"===typeof d&&d)){var e=this.data("rateWidgetSettings")||{};a.extend(e,d);"undefined"!==typeof d.hold&&"function"!==typeof d.hold&&(e.hold=b(e.hold))}return this}this.data("rateWidgetSettings",a.extend({onUpdate:function(){},rate:null,hold:!1,withClearAction:!0,alwaysUpdate:!1},c||{}));e=this.data("rateWidgetSettings");var h=this;"function"!==typeof e.hold&&(e.hold=b(e.hold));(function(){if(!this.data("inited")){null!=e.rate&&
h.attr("data-rate",e.rate);h.find("i:lt("+h.attr("data-rate")+")").removeClass("star-empty").addClass("star");h.mouseover(function(p){e.hold.call(h)||(p=p.target,"I"==p.tagName&&(p=a(p),p.prevAll().removeClass("star star-half star-empty").addClass("star-hover").end().removeClass("star star-half star-empty").addClass("star-hover"),p.nextAll().removeClass("star star-hover").addClass("star-empty")))}).mouseleave(function(){e.hold.call(h)||f.call(h,h.attr("data-rate"))});h.click(function(p){if(!e.hold.call(h)){for(var n=
p.target;"I"!=n.tagName;)if(n==this)return;var q=h.attr("data-rate"),t=0;h.find("i").removeClass("star star-hover").addClass("star-empty").each(function(){t++;a(this).removeClass("star-empty").addClass("star");if(this==n){if(e.alwaysUpdate||q!=t)h.attr("data-rate",t),e.onUpdate(t);return!1}})}});if(e.withClearAction){var k="clear-"+a(this).attr("id"),l=a("#"+k);l.length||(h.after('<a href="javascript:void(0);" class="inline-link p-rate-clear" id="'+k+'" style="display:none;"><b><i>'+$_("clear")+"</b></i></a>"),
l=a("#"+k));l.click(function(){if(!e.hold.call(h)){var p=h.attr("data-rate");f.call(h,0);if(0!=p)e.onUpdate(0)}});var m;h.parent().mousemove(function(){e.hold.call(h)||(m&&clearTimeout(m),l.show(0))}).mouseleave(function(){m=setTimeout(function(){e.hold.call(h)||l.hide(0)},150)})}this.data("inited",!0)}}).call(this);return this}})(jQuery);var PhotoStream=function(){var a=function(c){this._options=c||{};this._onClear=this._options.onClear||function(){};this._photo_stream=[]};$.extend(a.prototype,{getById:function(c){for(var d=0,g=this._photo_stream[0],f=this._photo_stream.length;d<f;g=this._photo_stream[++d])if(g&&g.id==c)return g;return null},updateById:function(c,d,g){if(c=this.getById(c))return $.extend(c,d),c;g&&this._photo_stream.push(d);return d},deleteById:function(c){$.isArray(c)||(c=[c]);var d=c,g=0,f=d.length;for(c=d[0];g<
f;c=d[++g])(c=this.getById(c))&&c.index&&delete this._photo_stream[c.index];d=[];var b=0;g=0;f=this._photo_stream.length;for(c=this._photo_stream[0];g<f;c=this._photo_stream[++g])c&&(c.index=b++,d.push(c));this._photo_stream=d;return this},replace:function(c,d){c=c.index;this._photo_stream[c]=d;d.index=c;return this},push:function(c){this._photo_stream.push(c);c.index=this._photo_stream.length-1;return this},getNext:function(c){c=c||this.current;"object"!=typeof c&&(c=this.getById(c));if(!c)return null;
c=c.index+1;return this._photo_stream[c]?this._photo_stream[c]:null},getPrev:function(c){c=c||this.current;"object"!=typeof c&&(c=this.getById(c));if(!c)return null;c=c.index-1;return this._photo_stream[c]?this._photo_stream[c]:null},setCurrent:function(c){if(!c.index&&(c=this.getById(c.id),!c||"number"!==typeof c.index&&!c.index))throw Error("This photo is not in stream");this.current=c;return this},setCurrentById:function(c){c=this.getById(c);"object"===typeof c&&c&&this.setCurrent(c);return this},
getCurrent:function(){return this.current},getCurrentId:function(){return"object"===typeof this.current&&this.current?this.current.id:null},set:function(c){this._photo_stream=[];this.append(c);this.isEmpty()||this.setCurrent(this.getFirst());return this},append:function(c){for(var d=0,g=c[d],f=this._photo_stream.length,b=c.length;d<b;g=c[++d],++f)g.index=f,this._photo_stream.push(g);return this},prepend:function(c){var d=this._photo_stream||[];this._photo_stream=[];for(var g=0,f=c[g],b=c.length;g<
b;f=c[++g])f.index=g,this._photo_stream.push(f);this.append(d);return this},clear:function(){this._photo_stream=[];this._onClear();return this},length:function(){return this._photo_stream.length},getAll:function(){return this._photo_stream},getFirst:function(){return this._photo_stream[0]},getLast:function(){return this._photo_stream[this._photo_stream.length-1]},isFirst:function(c){return c&&0==c.index},isLast:function(c){return c&&c.index==this._photo_stream.length-1},isEmpty:function(){return!this._photo_stream.length},
getCurrentIndex:function(){return this.current.index},slice:function(c,d){return this._photo_stream.slice(c,d)},move:function(c,d){var g=[],f=this._photo_stream;if($.isArray(c))for(var b=0,e=c.length;b<e;++b){var h=this.getById(c[b]);delete f[h.index];g.push(h)}else h=this.getById(c),delete f[h.index],g.push(h);if(g.length)for(h="undefined"===typeof d||null===d?this._photo_stream.length:(h=this.getById(d))?h.index:0,Array.prototype.splice.apply(f,[h,0].concat(g)),this.clear(),b=g=0,e=f.length;b<e;++b)h=
f[b],"object"===typeof h&&h&&(h.index=g++,this._photo_stream.push(h))}});return a}();Date.parseISO=function(a){var c=Date.parse(a);if(!isNaN(c))return c;a=a.match(/([0-9]{4})-([0-9]{2})-([0-9]{2}) ([0-9]{2}):([0-9]{2}):([0-9]{2})/);c=new Date(a[1],0,1);a[2]&&c.setMonth(a[2]-1);a[3]&&c.setDate(a[3]);a[4]&&c.setHours(a[4]);a[5]&&c.setMinutes(a[5]);a[6]&&c.setSeconds(a[6]);return+c};
function replaceImg(a,c,d,g){g=g||a.attr("id")||(""+Math.random()).slice(2);replaceImg.loading_map=replaceImg.loading_map||{};replaceImg.loading_map[g]=c;a.unbind("load");null===d?a.attr("src",c):$("<img>").attr("src",c).load(function(){setTimeout(function(){replaceImg.loading_map[g]==c&&(a.attr("src",c),"function"==typeof d&&d.call(a));$(this).remove()},100)});return g}
String.prototype.truncate=function(a,c){var d="";if("undefined"===typeof c||c)d=this.replace(/<\/?[\s\S]+?\/?>/g,"");d.length>a-3&&3<a&&(d=d.substr(0,a-3)+"...");return d};function parseSize(a){var c="unknown";a=(""+a).split("x");var d=a[0]&&0!=a[0]?a[0]:null,g=a[1]&&0!=a[1]?a[1]:null;1==a.length?(c="max",g=d):d==g?c="crop":d&&g?c="rectangle":null===d?c="height":null===g&&(c="width");return{type:c,width:d,height:g}}
function getRealSizesOfThumb(a,c){var d=parseInt(a.width,10),g=parseInt(a.height,10),f=d/g,b=g/d;if(isNaN(f)||isNaN(b))return null;var e="object"!==typeof c?parseSize(c):c;var h=e.width;c=e.height;switch(e.type){case "max":d>g?(f=h,b*=f):(b=h,f*=b);break;case "crop":f=b=h;break;case "rectangle":f=h;b=c;break;case "width":f=h;b*=f;break;case "height":b=c;f*=b;break;default:f=b=null}f=Math.round(f);b=Math.round(b);return d<f&&g<b?{width:a.width,height:a.height}:{width:f,height:b}};(function(a){a.fn.photoStreamSlider=function(c){var d=a.extend({duration:200},c||{}),g=this;(function(){function f(u){function r(){f.execution=!1;var B="on"+v.charAt(0).toUpperCase()+v.slice(1);B=d[B];"function"==typeof B&&B.call(g);B=u.fn;"function"==typeof B&&B.call(g)}"string"==typeof u&&(u={direction:u,animate:!0});var v=u.direction||"forward",x=u.steps||e.length;if(!f.execution){f.execution=!0;var A=e.filter(":first").outerWidth()*x,w=e.length;if("forward"==v){var y=e.filter(":last").nextAll(":lt("+
x+")");x=y.length;y=y.filter(":last");x&&(e.removeClass("visible"),y.prevAll(":lt("+(w-1)+")").addClass("visible"),y.addClass("visible"))}else y=e.filter(":first").prevAll(":lt("+x+")"),x=y.length,y=y.filter(":last"),x&&(e.removeClass("visible"),y.nextAll(":lt("+(w-1)+")").addClass("visible").show(),y.addClass("visible"));e=a("li.visible",b);w=b.position().left;"forward"==v?(x=l-k-n,w-=A,w=w>-x?w:-x):(w+=A,w=w<n?w:n);u.animate?b.animate({left:w},d.duration,r):(b.css({left:w}),r())}}var b=g.find(d.photoStream),
e=a("li.visible",b),h=a("li",b),k=e.filter(":first").outerWidth()*e.length,l=h.filter(":first").outerWidth()*h.length,m=h.filter(":first").outerHeight();b.parent().css({overflow:"hidden",height:m,position:"relative",padding:"4px 0",margin:0,width:k});m=b.find("li:first");var p=e.filter(":first"),n=(p.outerWidth()-p.width())/2,q=0,t=m.outerWidth();for(p=p.get(0);m.length&&m.get(0)!=p;)q+=t,m=m.next();b.css({position:"absolute",left:-(q-n),width:l});a(d.forwardLink).click(function(){f("forward");return!1});
a(d.backwardLink).click(function(){f("backward");return!1});g.bind("append prepend",function(u,r){if("append"==u.type){for(var v=b.find("li:last"),x=a();v.hasClass("dummy");)x=x.add(v),v=v.prev("li");x.remove();b.append(r)}else{v=a("<div></div>").html(r);r=v.find("li");var A=r.length*t;v.remove();v=b.find("li:first");for(x=a();v.hasClass("dummy");)x=x.add(v),v=v.next("li");x.remove();b.prepend(r)}h=b.find("li");l=h.filter(":first").outerWidth()*h.length;b.css("width",l);"prepend"==u.type&&(b.is(":animated")&&
b.stop(!1,!0),b.css("left",parseInt(b.css("left"))-A));b.find("li.selected").hasClass("visible")&&g.trigger("home",[null,!1])});g.bind("forward backward",function(u,r){f({direction:u.type,steps:r.steps,animate:"undefined"!==typeof r.animate?r.animate:!0,fn:r.fn});r=b.find("li.selected");u="forward"==u.type?r.next("li:not(.dummy)"):r.prev("li:not(.dummy)");u.length&&(r.removeClass("selected"),u.addClass("selected"))});g.bind("home",function(u,r,v){u=parseInt(e.length/2);u=e.filter(":eq("+u+")");var x=
u.nextAll(".selected:first"),A=u.prevAll(".selected:first"),w=0,y="";"function"!==typeof r&&(v=r);v="undefined"!==typeof v?v:!0;x.length?(y="forward",u.nextAll().each(function(){++w;if(a(this).hasClass("selected"))return!1})):A.length&&(y="backward",u.prevAll().each(function(){++w;if(a(this).hasClass("selected"))return!1}));y&&w?f({direction:y,steps:w,fn:r,animate:v}):"function"==typeof r&&r();return!1})})()}})(jQuery);(function(a){a.storage=new a.store;a.photos={namespace:".photos",load_from_hash:0,hash:"",raw_hash:"",options:{},shift_next:!1,anchor:"",album:null,total_count:null,photos_per_page:null,list_template:"template-photo-thumbs",photo_list_string:{},init:function(c){"undefined"!=typeof a.History&&(a.History.bind(function(){a.photos.dispatch()}),a.History.unbind=function(d,g){g?a.History.handlers.specific[d]&&a.each(a.History.handlers.specific[d],function(f,b){if(b===g)return a.History.handlers.specific[d].splice(f,
1),!1}):(g=d,a.each(a.History.handlers.generic,function(f,b){if(b===g)return a.History.handlers.generic.splice(f,1),!1}))},a.History.one=function(d,g){g||(g=d,d=null);var f=function(){g.call(this);a.History.unbind.apply(a.History,d?[d,f]:[f])};a.History.bind.apply(a.History,d?[d,f]:[f])});a.wa.errorHandler=function(d){a.storage.del("photos/hash");return 403===d.status?(a("#content").html('<div class="content left'+a.photos_sidebar.width+'px"><div class="block double-padded">'+d.responseText+"</div></div>"),
!1):a.photos.load_from_hash?(a.wa.setHash("#/"),!1):!0};this.options=c;(c=window.location.hash||a.storage.get("photos/hash"))&&c!=window.location.hash?(this.load_from_hash=2,a.wa.setHash("#/"+c)):this.dispatch()},dispatch:function(c){if(a.photos.ignore_dispatch)a.photos.ignore_dispatch--;else if(a.photos.hash="",void 0==c&&(c=window.location.hash),c=c.replace(/^[^#]*#\/*/,""),a.photos.raw_hash=c)if(c=c.split("/"),c[0]){for(var d="",g=c.length,f=0;f<c.length;f++){var b=c[f];if(2>f)if(0===f)d=b;else if("tag"==
d||"search"==d||"plugins"==d||"pages"==d||"app"==d){g=f;break}else if(parseInt(b,10)!=b&&-1==b.indexOf("="))d+=b.substr(0,1).toUpperCase()+b.substr(1);else{g=f;break}else{g=f;break}}g=c.slice(g);a.photos.hash="/"+c.slice(0,2).join("/");~a.photos.hash.indexOf("photo")&&(a.photos.hash="");this.beforeAnyAction(d,g);this[d+"Action"]?(this.load_from_hash&&this.load_from_hash--,this[d+"Action"].apply(this,g),a.storage.set("photos/hash",a.photos.hash)):(a.storage.del("photos/hash"),console&&console.log("Invalid action name:",
d+"Action"))}else this.beforeAnyAction(),this.defaultAction();else this.beforeAnyAction(),this.defaultAction()},ignore_dispatch:0,forceHash:function(c){c!=window.location.hash&&(a.photos.ignore_dispatch=1,window.location.hash=c)},menu:{stack:{list:[],photo:[]},extend_stack:{list:[],photo:[]},register:function(c,d,g){this.stack[c]&&this.stack[c].push(new ToolbarMenu(d,g))},get:function(c,d){if(this.stack[c]&&a.isArray(this.stack[c]))for(var g=0;g<this.stack[c].length;g++)if(this.stack[c][g].is(d))return this.stack[c][g];
return null},init:function(c){var d;if(this.stack[c]){for(;d=this.extend_stack[c].shift();)for(var g=0;g<this.stack[c].length;g++)if(this.stack[c][g].is(d.selector)){for(var f in d.actions)this.stack[c][g].setAction(f,d.actions[f]);break}for(g=0;g<this.stack[c].length;g++)this.stack[c][g].init()}},enable:function(c,d,g){d=d||"*";if(this.stack[c])for(var f=0;f<this.stack[c].length;f++){var b=this.stack[c][f];d&&!b.is(d)||b.enable(g)}},disable:function(c,d,g){d=d||"*";if(this.stack[c])for(var f=0;f<
this.stack[c].length;f++){var b=this.stack[c][f];d&&!b.is(d)||b.disable(g)}},extend:function(c,d,g){this.stack[c]&&this.extend_stack[c].push({selector:d,actions:g});return this}},setOption:function(c,d){this.options[c]=d},getOption:function(c){return this.options[c]},beforeAnyAction:function(){},initClearance:function(){a.photos.toggleFullScreen();a.photos.highlightSidebarItem();a.photos.hotkey_manager.unset();a.photos.unsetLazyLoad();a.photos.photo_stream_cache.clear();a.photos.photo_stack_cache.clear();
delete a.photos.photo_stream_cache.hash},defaultAction:function(){window.location.hash||!a("#album-list ul li.dr").length?(a.storage.set("photos/hash","photos/"),this.photosAction()):(a.storage.set("photos/hash","albums/"),this.albumsAction())},photosAction:function(){a.photos.loadDispatch(arguments,function(){a.photos.load("?module=photo&action=list",a.photos.onLoadPhotoList)})},albumsAction:function(){a.photos.loadDispatch(arguments,function(){a.photos.load("?action=albums")})},albumAction:function(c){a.photos.loadDispatch(arguments,
function(){a.photos.load("?module=album&action=photos&id="+c,a.photos.onLoadPhotoList)})},searchAction:function(c){a.photos.loadDispatch(arguments,function(){a.photos.load("?module=search&action=photos",{q:c},a.photos.onLoadPhotoList)})},tagAction:function(c){a.photos.loadDispatch(arguments,function(){a.photos.load("?module=tag&action=photos&tag="+c,a.photos.onLoadPhotoList)})},appAction:function(c){a.photos.loadDispatch(arguments,function(){a.photos.load("?module=photo&action=list&app_id="+c,a.photos.onLoadPhotoList)})},
settingsAction:function(){a.photos.initClearance();a.photos.load("?module=settings",a.photos.onLoadSettings)},pagesAction:function(c){a("#wa-page-container").length?waLoadPage(c):(a.photos.initClearance(),a.photos.load("?module=pages",a.photos.onLoadPages,'<div class="content left'+a.photos_sidebar.width+'px"></div>'))},designAction:function(c){a.photos.initClearance();c?a("#wa-design-container").length?(a.photos.setTitle($_("Themes")),a.photos.scrollTop(),waDesignLoad()):a.photos.load("?module=design",
function(){waDesignLoad(c);a.photos.setTitle($_("Themes"));a.photos.scrollTop()},'<div class="content left'+a.photos_sidebar.width+'px"></div>'):a.photos.load("?module=design",function(){waDesignLoad("");a.photos.setTitle($_("Design"));a.photos.scrollTop()},'<div class="content left'+a.photos_sidebar.width+'px"></div>')},designThemesAction:function(c){a.photos.initClearance();a("#wa-design-container").length?(a.photos.setTitle($_("Themes")),a.photos.scrollTop(),waDesignLoad()):a.photos.load("?module=design",
function(){waDesignLoad();a.photos.setTitle($_("Themes"));a.photos.scrollTop()},'<div class="content left'+a.photos_sidebar.width+'px"></div>')},pluginsAction:function(c){a.photos.initClearance();a("#p-sidebar li.selected").removeClass("selected");a("#p-sidebar #sidebar-plugins").addClass("selected");a("#wa-plugins-container").length?a.plugins.dispatch("#/plugins/"+c):a.photos.load("?module=plugins")},photoAction:function(c){a.photos.loadPhoto(c)},loadDispatch:function(c,d){for(var g=Array.prototype.slice.call(c,
1),f=0;f<g.length;f++)if("photo"==g[f]&&f<g.length-1){this.loadPhoto(g[f+1]);return}"function"==typeof d&&d(c[0]);a.photos.initClearance()},onLoadSettings:function(){a.photos.setTitle($_("Settings"));a.photos.scrollTop()},onLoadPlugins:function g(d){a.photos.setTitle($_("Plugins"));a("#plugins-settings-form").submit(function(){a("#plugins-settings-form-status").fadeIn(400);a("#plugins-settings-iframe").one("load",function(){var f=a.parseJSON(a(this).contents().find("body").html());a("#plugins-settings-form-status").fadeOut(200,
function(){"ok"==f.status?a.photos.loadPluginSettings(d,g):(a("#plugins-settings-form-status").html(f.errors?f.errors:f).css("color","red"),a("#plugins-settings-form-status").fadeIn("slow"))})})});a.photos.scrollTop()},onLoadPages:function(){a.photos.setTitle($_("Pages"));a.photos.scrollTop()},renderPhotoList:function(){var d=a("#photo-list");d.empty();a.photos.renderPhotoListChunk(d,0);a.photos.photo_stream_cache.length()&&(!a.photos.total_count||a.photos.total_count>a.photos.photo_stream_cache.length())&&
a.photos.setLazyLoad()},renderPhotoListChunk:function(d,g,f,b){var e=a.photos.options.photo_list_render_chunk||10,h=a.photos.photo_stream_cache.length();f=f||{};f.hide_name||(f.hide_name=a.storage.get("photos/list/hide_name",!1));e=a.photos.photo_stream_cache.slice(g,g+=e);e={photos:e,hash:a.photos.hash,last_login_time:a.photos.options.last_login_time,options:f,selected:!!a("#selector-menu").find("[data-action=select-photos]").data("checked"),view:(a.photos.list_template||"").replace("template-photo-",
"")};d.append(tmpl(a.photos.list_template,e));a("#content").trigger("photos_list_chunk_render",[e]);if(g<h)setTimeout(function(){a.photos.renderPhotoListChunk(d,g,f,b)},100);else if("function"==typeof b&&b(),e=f.string||a.photos.photo_list_string||!1)a(".lazyloading-wrapper").html(tmpl("template-photo-counter",{count:h,total_count:a.photos.total_count,string:e})),a.photos.photo_list_string=e;a.Retina&&a.photos.options.retina_2x_enabled&&d.find("img").retina()},selectPhotoListView:function(d){d=d.replace(/-view$/,
"");a.photos.list_template="template-photo-"+d;var g=a.photos.getAlbum();g&&("thumbs"==d?a.storage.del("photos/list/view/"+g.id):a.storage.set("photos/list/view/"+g.id,d));a.photos.menu.enable("list","."+d+"-view-menu");a.photos.menu.disable("list",":not(."+d+"-view-menu)");g=a("#photo-list");g.removeClass(g.attr("class"));switch(d){case "thumbs":g.addClass("thumbs li250px");break;case "descriptions":g.addClass("p-descriptions")}a("#p-block .p-content-control li.selected").removeClass("selected");
a('#p-block .p-content-control a[data-action="'+d+'-view"]').parents("li").addClass("selected")},onLoadPhotoList:function(){var d=a.photos.getAlbum(),g=null;if(d){g=a.storage.get("photos/list/view/"+d.id);"thumbs"!=g&&"descriptions"!=g&&(g="thumbs");var f=a("#album-list li[rel="+d.id+"]");f.find(".count:first").text(d.count);f.find(".count-new:first").text("");a("#album-list-container").trigger("uncollapse_section",f);if(d.edit_rights)a("#photo-list").on("click",".make-key-photo-link",function(){a("#photo-list .key-photo").removeClass("key-photo");
$li=a(this).closest("li").addClass("key-photo");d.key_photo_id=$li.data("photo-id");a.post("?module=album&action=keyPhoto",{album_id:d.id,photo_id:d.key_photo_id})})}g||(g="thumbs");a("#template-photo-"+g).length?(a.photos.list_template="template-photo-"+g,a.photos.renderPhotoList(),a.photos.fixRightToolbar(),a.photos.setTitle(a("#photo-list-name").text()),a.photos.menu.init("list"),a.photos.selectPhotoListView(g),a.Retina&&a.photos.options.retina_2x_enabled&&a("#album-thumbs-list img").retina(),
a("#p-block .p-content-control li a.album-view").click(function(){var b=a(this).attr("data-action");b!=g&&(g=b.replace(/-view$/,""),a.photos.list_template="template-photo-"+g,a.photos.renderPhotoList(),a.photos.selectPhotoListView(g));return!1}),a("#photo-list .p-description div").live("click",function(){a(this);a(this).height();var b=$_("add description");a(this).inlineEditable({inputType:"textarea",makeReadableBy:["esc"],updateBy:["ctrl+enter"],placeholder:b,placeholderClass:"gray",minSize:{height:40},
html:!0,allowEmpty:!0,beforeMakeEditable:function(e){var h=a(this),k=h.parent().find(".full-description:first").html(),l=h.css("font-size"),m=h.css("line-height");e.css("font-size",l).css("line-height",m);h.html(k);k=Math.max(h.parents("li:first").find("img").width(),h.width());e.width(k);k=this.id+"-button";l=a("#"+k);l.length||(e.after('<br><input type="button" id="'+k+'" value="'+$_("Save")+'"> <em class="hint" id="'+this.id+'-hint">Ctrl+Enter</em>'),a("#"+k).click(function(){h.trigger("readable")}));
a("#"+this.id+"-hint").show();l.show()},afterBackReadable:function(e,h){var k=a("#"+(this.id+"-button")),l=a(this);e=a(e).val();var m=l.parents("li:first").find(".p-image a").attr("href");m=/(\d+)[\/]*$/.exec(m);var p=null;k.hide();a("#"+this.id+"-hint").hide();e?(l.text(e.truncate(255)),l.parent().find(".full-description:first").html(e)):l.parent().find(".full-description:first").html("");m&&h.changed&&(p=m[1],a.photos.saveField({id:p,type:"photo",name:"description",value:e,fn:function(){}}))},hold:function(){return!this.hasClass("editable")}}).trigger("editable")}),
f=a("#photo-list-name"),f.hasClass("editable")&&f.inlineEditable({minSize:{width:350},maxSize:{width:600},size:{height:30},afterBackReadable:function(b,e){if(!e.changed)return!1;b=a(b).val();(e=a.photos.getAlbum())&&a.photos.saveField({id:e.id,type:"album",name:"name",value:b,fn:function(h){"ok"==h.status&&(h=h.data.album,a("#album-list li[rel="+h.id+"] > a > .album-name").html(h.name),a("#p-upload-step2 select[name=album_id] option[value="+h.id+"]").html(h.name),a.photos.setTitle(h.not_escaped_name))}})},
hold:function(){return!this.hasClass("editable")}}),f=a("#photo-album-note"),f.hasClass("editable")&&f.inlineEditable({placeholder:"("+$_("subtitle")+")",placeholderClass:"gray",minSize:{width:350},maxSize:{width:600},size:{height:22},afterBackReadable:function(b,e){if(!e.changed)return!1;b=a(b).val();(e=a.photos.getAlbum())&&a.photos.saveField({id:e.id,type:"album",name:"note",value:b})},hold:function(){return!this.hasClass("editable")}}),a("#share-menu-block, #organize-menu-block").bind("recount",
function(){var b=a("#photo-list li.selected").length;0<b?a(".count:first",a(this)).text(b).show():a(".count:first",a(this)).hide()}),a("#p-album-settings").click(function(){var b=a.photos.getAlbum(),e=b?b.id:0;b=a("#album-settings-dialog-acceptor");b.length||(b=a("<div id='album-settings-dialog-acceptor'></div>"),a("body").append(b));b.load("?module=dialog&action=albumSettings&id="+e,function(){a("#album-settings-dialog").waDialog({onSubmit:function(h){var k=a(this);h.trigger("change_loading_status",
!0);a.post(k.attr("action"),k.serializeArray(),function(l){if("ok"==l.status){var m=function(u){a.post("?module=album&action=savePhotosAccess",u,function(){u.offset+=t;u.offset<=p?m(u):(h.trigger("change_loading_status",!1),location.reload())})},p=l.data.total_count,n=l.data.status,q=l.data.groups,t=l.data.count;l=t;t<p?m({id:e,status:n,groups:q,count:t,offset:l}):(h.trigger("change_loading_status",!1),location.reload())}else if("fail"==l.status)for(n in h.trigger("change_loading_status",!1),l=l.errors,
l)l.hasOwnProperty(n)&&h.find("input[name="+n+"]").addClass("error").parent().find(".errormsg").text(l[n])},"json");return!1}})});return!1}),a("#p-album-delete").click(function(){var b=a.photos.getAlbum(),e=b?b.id:0;a.photos.confirmDialog({url:"?module=dialog&action=confirmDeleteAlbum&id="+e,onSubmit:function(h){var k=parseInt(a("input[name=delete-photos]:checked",h).val()),l;(l=a("input[name=delete-offspring]:checked",h).val())?(l=l.split(",").reverse(),l.push(e)):l=[e];h.trigger("close");a.photos.setCover();
a.photos.deleteAllAlbums(l,k,function(){a.photos.unsetCover()});return!1}});return!1}),a("#photo-list").find(".p-description textarea, .p-photo-details textarea, .p-photo-details input").live("select",function(){return!1}),a.photos.hotkey_manager.set("rate"),a.photos.hash!=a.photos.photo_stream_cache.hash&&a.photos.scrollTop(),a("#content").trigger("photos_list_load"),a("#photo-list").find("li.highlighted").length?a(".i-product-review-widget-wrappper").show():a(".i-product-review-widget-wrappper").hide()):
(a("#content").empty(),a.wa.setHash("#/"))},loadPhoto:function(d){if(a.photos.photo_stream_cache.hash!=a.photos.hash)a.photos.loadNewPhoto(d);else{var g=a.photos.photo_stream_cache.getById(d);g?(a.photos.setTitle(g.name_not_escaped),a.photos.loadPhotoCompletly(g)):(g=a.photos.photo_stack_cache.getById(d))?(a.photos.setTitle(g.name_not_escaped),a.photos.loadPhotoInStack(g)):a.photos.loadNewPhoto(d)}},loadPhotoInStack:function f(g){a.photos.abortPrevLoading();a.photos.hooks_manager.trigger("beforeLoadPhoto",
g);a.photos.photo_stack_cache.setCurrent(g);var b=a.photos._chooseProperThumb(g);"object"===typeof b.size&&b.size&&a("#photo").width(b.size.width).height(b.size.height);replaceImg(a("#photo"),g.thumb.url+(g.edit_datetime?"?"+Date.parseISO(g.edit_datetime):""),null);a.photos.setNextPhotoLink();b=a.post("?module=photo&action=load",{id:g.id,in_stack:1},function(e){e=e.data;var h=e.photo;h=a.photos.photo_stack_cache.updateById(h.id,h);e.photo=h;a.photos.updateViewChildPhoto(e);a.photos.hooks_manager.trigger("afterLoadPhoto",
h);delete f.xhr},"json");f.xhr=b;a("#photo-name").html(g.name)},updateViewChildPhoto:function(g){var f=g.author,b=g.albums,e=g.exif;g=g.photo;a.photos.renderPhotoImg(g);a("#photo-author").html(tmpl("template-photo-author",{photo:g,author:f}));a.photos.updatePhotoOriginalBlock(g);a("#photo-exif").html(tmpl("template-photo-exif",{exif:e}));a.photos.renderMap(e.GPSLatitude,e.GPSLongitude,g.name);a("#photo-albums").html(tmpl("template-photo-albums",{albums:b}));a.photos.initPhotoContentControlWidget({frontend_link_template:frontend_link_template,
photo:g})},loadNewPhoto:function b(f){a.photos.initClearance();a.photos.widget.loupe.init();b.xhr_map=b.xhr_map||{};b.xhr_map[f]&&b.xhr_map[f].abort();b.xhr_map[f]=a.post("?module=photo&action=load",{id:f,hash:a.photos.hash},function(e){b.xhr_map[f]=null;e=e.data;var h=e.photo;a.photos.renderViewPhoto(e);var k=a.photos.photo_stream_cache.getNext();k&&a.photos.preloadPhoto(k);e.album&&a.photos.setAlbum(e.album);a.photos.hooks_manager.trigger("afterLoadPhoto",h)},"json")},renderViewPhoto:function(f){var b=
f.photo,e=f.author,h=f.exif,k=f.stack,l=f.albums,m=f.album,p=f.hooks,n=f.frontend_link_template;f=f.photo_stream;var q=f.in_collection,t=!1;if(m&&!q){if(m.type==Album.TYPE_STATIC){a.photos.goToHash("album/"+m.id+"/");return}t=!0}a.photos.setTitle(b.name_not_escaped);a("#content").html(tmpl("template-p-block"));a.photos.initPhotoToolbar({photo:b,author:e,exif:h,stack:k});a.photos.renderPhotoBlock({photo:b,hash:a.photos.hash,albums:l,hooks:p,frontend_link_template:n});a.photos.initPhotoWidgets({photo:b,
stack:k,exif:h,photo_stream:f,hash:a.photos.hash});a.photos.anchor?(a.photos.goToAnchor(a.photos.anchor),a.photos.anchor=""):a.photos.scrollTop();a("#p-warning-not-in-album").hide();t?(a("#p-warning-not-in-album").show(),a.photos.setNextPhotoLink(a.photos.photo_stream_cache.getCurrent())):a.photos.setNextPhotoLink()},loadPhotoCompletly:function(f){a.photos.photo_stream_cache.setCurrent(f);a.photos.updatePhotoStreamWidget({shift:f.id,fn:function(){a.photos._loadPhotoCompletly(f)}})},_loadPhotoCompletly:function e(b){a.photos.abortPrevLoading();
a.photos.hooks_manager.trigger("beforeLoadPhoto",b);a("#p-warning-not-in-album").hide();a.photos.setNextPhotoLink();a.photos.updatePhotoName(b.name);a.photos.updatePhotoDescription(b.description);a.photos.updatePhotoRate(b.rate);a("#photo-frontend-url").html(b.url);a("#stack-stream").hide();a("#photo-hook-bottom").html("");var h=a.photos.isPhotoPreloaded(b);if(h)a.photos.renderPhotoImg(b);else{var k=a.photos._chooseProperThumb(b);"object"===typeof k.size&&k.size&&a("#photo").width(k.size.width).height(k.size.height);
replaceImg(a("#photo"),b.thumb.url+(b.edit_datetime?"?"+Date.parseISO(b.edit_datetime):""),null)}a.photos.updatePhotoTags(b.tags);(k=a.photos.photo_stream_cache.getNext())&&a.photos.preloadPhoto(k);b=a.post("?module=photo&action=load",{id:b.id},function(l){if("ok"==l.status){l=l.data;var m=l.album,p=l.photo,n=l.photo_stream.in_collection,q=!1;if(m&&!n){if(m.type==Album.TYPE_STATIC){a.photos.goToHash("album/"+m.id+"/");return}q=!0}q?(a("#p-warning-not-in-album").show(),a.photos.setNextPhotoLink(a.photos.photo_stream_cache.getCurrent())):
a.photos.setNextPhotoLink();p=a.photos.photo_stream_cache.updateById(p.id,p);l.photo=p;a.photos.updateViewPhoto(l,h);a.photos.hooks_manager.trigger("afterLoadPhoto",p);delete e.xhr}},"json");e.xhr=b},updateViewPhoto:function(b,e){var h=b.author,k=b.albums,l=b.exif,m=b.frontend_link_template,p=b.hooks,n=b.stack;b=b.photo;e||a.photos.renderPhotoImg(b);a.photos.updateViewPhotoMenu(0!=b.parent_id||0<b.stack_count,b.edit_rights);a.photos.updatePhotoName(b.name,b.edit_rights);a.photos.updatePhotoDescription(b.description,
b.edit_rights);a.photos.updatePhotoRate(b.rate,b.edit_rights);a.photos.updatePhotoTags(b.tags);a("#photo-author").html(tmpl("template-photo-author",{photo:b,author:h}));a.photos.updatePhotoOriginalBlock(b);a("#photo-exif").html(tmpl("template-photo-exif",{exif:l}));a.photos.renderMap(l.GPSLatitude,l.GPSLongitude,b.name);a("#photo-albums").html(tmpl("template-photo-albums",{albums:k}));a.photos.initPhotoContentControlWidget({frontend_link_template:m,photo:b});n?(a("#stack-stream").html(tmpl("template-photo-stack",
{stack:n,photo_id:b.id,hash:a.photos.hash})).show(),a.photos.photo_stack_cache.set(n),a.photos.initPhotoStackWidget()):a.photos.photo_stack_cache.clear();e="";for(var q in p.backend_photo)p.backend_photo[q].bottom&&(e+=p.backend_photo[q].bottom);a("#photo-hook-bottom").html(e);e="";for(q in p.backend_photo)p.backend_photo[q].after_rate&&(e+=p.backend_photo[q].after_rate);e&&(a("#photo-rate").nextAll().remove(),a("#photo-rate").after(e));a.photos.anchor&&(a.photos.goToAnchor(a.photos.anchor),a.photos.anchor=
"")},renderPhotoImg:function(b){var e=a.photos._chooseProperThumb(b);replaceImg(a("#photo"),e.url+(b.edit_datetime?"?"+Date.parseISO(b.edit_datetime):""),function(){"object"===typeof e.size&&e.size&&a(this).width(e.size.width).height(e.size.height);a.photos.hooks_manager.trigger("afterRenderImg",this,b,e)})},updateViewPhotoMenu:function(b,e){b?a.photos.menu.enable("photo","#photo-organize-menu","unstack"):a.photos.menu.disable("photo","#photo-organize-menu","unstack");e?(a.photos.menu.enable("photo",
"#photo-organize-menu"),a.photos.menu.enable("photo","#edit-menu"),a("#photo-tags").parent().show()):(a.photos.menu.disable("photo","#photo-organize-menu"),a.photos.menu.disable("photo","#edit-menu"),a("#photo-tags").parent().hide())},preloadPhoto:function(b){var e=a("#preload-photo");e.attr("data-photo-id","");replaceImg(e,b.thumb_big.url,function(){e.attr("data-photo-id",b.id)})},isPhotoPreloaded:function(b){return a("#preload-photo").attr("data-photo-id")==b.id},abortPrevLoading:function(){"object"===
typeof a.photos._loadPhotoCompletly.xhr&&"function"===typeof a.photos._loadPhotoCompletly.xhr.abort&&(a.photos._loadPhotoCompletly.xhr.abort(),a.photos.hooks_manager.trigger("onAbortPrevLoading"));"object"===typeof a.photos.loadPhotoInStack.xhr&&"function"===typeof a.photos.loadPhotoInStack.xhr.abort&&(a.photos.loadPhotoInStack.xhr.abort(),a.photos.hooks_manager.trigger("onAbortPrevLoading"))},updateThumbRate:function(b,e){b=b.find(".p-details .p-rate");(e=Math.round(2*e)/2)?(b.find("i").filter(function(){return~this.className.indexOf("star")}).removeClass("star star-empty star-half").addClass("star-empty").each(function(h){h+=
1;h>e?.5==h-e&&a(this).removeClass("star-empty").addClass("star-half"):a(this).removeClass("star-empty").addClass("star")}),b.show()):b.hide()},showManageAccessDialog:function(b,e){var h=a("#manage-access-dialog-acceptor"),k="?module=dialog&action=manageAccess";h.length||(h=a("<div id='manage-access-dialog-acceptor'></div>"),a("body").append(h));if(b)if(a.isArray(b))for(var l=0,m=b.length;l<m;++l){var p=b[l];k+="&"+p.name+"="+p.value}else k+="&"+b;h.load(k,function(){a("#manage-access-dialog").waDialog({onSubmit:e})})},
initPhotoNameWidget:function(b){b="undefined"===typeof b?!1:b;a("#photo-name").inlineEditable({placeholder:a("#photo-name").text()?null:$_("Edit title..."),placeholderClass:"gray",afterBackReadable:function(e,h){h.changed&&(e=a(e).val(),e.length&&a.photos.saveField({id:a.photos.getPhotoId(),type:"photo",name:"name",value:e,fn:function(k){a("#photo-name").inlineEditable("setOption",{placeholder:null});"ok"==k.status&&a.photos.setTitle(k.data.value)}}))},minSize:{width:350},maxSize:{width:600},size:{height:30},
hold:function(){return!this.hasClass("editable")}});a.photos.updatePhotoName(b)},initPhotoDescriptionWidget:function(b){b="undefined"===typeof b?!1:b;a("#photo-description").inlineEditable({placeholder:$_("add description"),placeholderClass:"gray",makeReadableBy:["esc"],updateBy:["ctrl+enter"],html:!1,allowEmpty:!0,beforeMakeEditable:function(e){var h=a("#photo-description-save");if(!h.length){var k=a(this);e.after('<br><input type="button" id="photo-description-save" value="'+$_("Save")+'"> <em class="hint" id="'+
this.id+'-hint">Ctrl+Enter</em>');h=a("#photo-description-save");h.click(function(){k.trigger("readable")})}a("#"+this.id+"-hint").show();h.show().prev("br").show()},afterBackReadable:function(e,h){a("#photo-description-save").hide().prev("br").hide();a("#"+this.id+"-hint").hide();if(!h.changed)return!1;a(e).val();a.photos.saveField({id:a.photos.photo_stream_cache.getCurrent().id,type:"photo",name:"description",value:a.wa.encodeHTML(a(e).val()),fn:function(){}})},minSize:{height:50,width:600},size:{width:a("#photo").width()},
inputType:"textarea",editLink:"#photo-description-edit-link",hold:function(){return!this.hasClass("editable")}});a.photos.updatePhotoDescription(b)},initPhotoRateWidget:function(b){b="undefined"===typeof b?!1:b;a("#photo-rate").rateWidget({onUpdate:function(e){a.photos.saveField(a.photos.photo_stream_cache.getCurrent().id,"rate",e,function(h){"ok"==h.status&&h.data.count&&a("#rated-count").text(0<h.data.count?h.data.count:"")})},hold:function(){return this.hasClass("hold")}});a.photos.updatePhotoRate(b)},
initPhotoStackWidget:function(b){"object"===typeof b&&b&&a("#stack-stream").html(tmpl("template-photo-stack",b)).show();b=a("#stack-stream li.dr:first a").attr("href");(b=/(\d+)[\/]*$/.exec(b))&&(parent_id=b[1]);a("#stack-stream").data("parent_id",parent_id);a("#stack-stream").sortable({distance:5,helper:"clone",items:"li.dr",opacity:.75,tolerance:"pointer",start:function(){document.ondragstart=function(){return!1}},stop:function(e,h){document.ondragstart=null;h=a(h.item);e=parseInt(h.attr("data-photo-id"));
h=h.next();var k=null;h.length&&(k=parseInt(h.attr("data-photo-id")));a.post("?module=stack&action=photoMove",{id:e,before_id:k},function(l){if("ok"==l.status&&l.data.stack){var m=l.data.stack;l=a("#stack-stream").data("parent_id");m=m[0];var p=m.id;l!=p&&(l=a.photos.photo_stream_cache.getById(l),m.tags=l.tags,a.photos.photo_stream_cache.replace(l,m),a("#stack-stream").data("parent_id",p),a.photos.updatePhotoStreamWidget({current_photo:m}))}},"json")}});if(a("#stack-stream").data("inited"))return!1;
a("#stack-stream li.dr").live("click",function(){a("#stack-stream li.dr.selected").removeClass("selected");a(this).addClass("selected")});a("#stack-stream").data("inited",!0)},initPhotoTagsWidget:function(b){var e=a("#photo-tags"),h=$_("add a tag");"undefined"!==typeof b&&("object"===typeof b&&b&&(b=a.photos.joinObject(b,",")),e.importTags(b));e.data("current_value",e.val());var k=function(){e.data("current_value")!==e.val()&&(e.data("current_value",e.val()),a("#photo-save-tags-status").html('<i style="vertical-align: middle" class="icon16 yes"></i>'+
$_("Saving")).fadeIn("slow"),a.photos.assignTags({photo_id:a.photos.getPhotoId(),tags:a.wa.encodeHTML(a("#photo-tags").val()),fn:function(){a("#photo-save-tags-status").html('<i style="vertical-align: middle" class="icon16 yes"></i>'+$_("Saved")).fadeOut("slow")},onDeniedExist:function(){alert($_("You don't have sufficient access rights"))}}))};try{e.tagsInput({autocomplete_url:"?module=tag&action=list",height:120,width:150,defaultText:h,onChange:function(){},onAddTag:function(){k()},onRemoveTag:function(){k()}})}catch(l){}},
initPhotoContentControlWidget:function(b){"object"===typeof b&&b?(a("#photo-content-control").html(tmpl("template-photo-content-control",b)),edit_rights=b.photo.edit_rights):edit_rights=b;edit_rights="undefined"===typeof edit_rights?!1:edit_rights;var e=a("#photo-frontend-url"),h=e.parents("li:first").find("i.new-window"),k=a("#photo-frontend-link").nextAll("span.slash:first");e.length&&e.inlineEditable({inputType:"input",editLink:"#photo-frontend-url-edit-link",editOnItself:!1,minSize:{width:100},
beforeMakeEditable:function(l){var m=a(this),p=m.text().replace(/\/$/,"");m.text(p);k.show();h.hide();l.removeClass("error");a("#photo-content-control").find(".errormsg").text("").hide()},beforeBackReadable:function(l,m){function p(){n.text(q);k.hide();h.show();a(l).removeClass("error");a("#photo-content-control").find(".errormsg").text("").hide()}var n=a(this),q=n.text()+"/",t=a.photos.getPhotoId(),u=a(l).val();if(m.changed)return a.photos.saveField(t,"url",u,function(r){"ok"==r.status?(r=a("#photo-frontend-link").text(),
a("#photo-frontend-link").attr("href",r),p(),e.trigger("readable",!0)):"fail"==r.status&&(a(l).addClass("error"),a("#photo-content-control").find(".errormsg").text(r.errors.url).show())}),!1;p()},hold:function(){return this.hasClass("hold")}});a.photos.updatePhotoFrontendUrl(edit_rights)},renderMap:function(b,e,h){var k=this.options.map_options||{},l=function(){};b&&e?(l="google"===k.type?function(){window.initPhotosGoogleMap=function(){if(window.google){a("#photo-map").show();var p=new google.maps.LatLng(b,
e),n={zoom:11,center:p,mapTypeId:google.maps.MapTypeId.ROADMAP,disableDefaultUI:!0,zoomControlOptions:{position:google.maps.ControlPosition.TOP_LEFT,style:google.maps.ZoomControlStyle.SMALL}};n=new google.maps.Map(a("#photo-map").get(0),n);new google.maps.Marker({position:p,map:n,title:h})}else a("#photo-map").hide()};if(window.google)initPhotosGoogleMap();else{var m="https://maps.googleapis.com/maps/api/js?sensor=false&key=:KEY&lang=:LOCALE&callback=initPhotosGoogleMap".replace(":KEY",k.key||"").replace(":LOCALE",
k.locale||"");a.getScript(m)}}:"yandex"===k.type?function(){var m=function(){window.ymaps?ymaps.ready(function(){a("#photo-map").show();var n=[b,e],q=new ymaps.Map("photo-map",{center:n,zoom:11,controls:["zoomControl","fullscreenControl"]});q.setCenter(n);q.geoObjects.add(new ymaps.Placemark(n,{balloonContent:""}))}):a("#photo-map").hide()};if(window.ymaps)m();else{var p="https://api-maps.yandex.ru/2.1/?lang="+(k.locale||"ru_RU");k.key&&(p+="&apikey="+k.key);a.getScript(p,m)}}:function(){a("#photo-map").hide()},
l()):a("#photo-map").hide()},joinObject:function(b,e){var h="",k=0;e=e||"";for(var l in b)b.hasOwnProperty(l)&&(0<k++&&(h+=e),h+=b[l]);return h},initPhotoStreamWidget:function(b){var e=b.photos;e=[null].concat(e,[null]);a("#photo-stream").html(tmpl("template-photo-stream",{photos:e,current_photo:b.current_photo||null,hash:a.photos.hash}));var h=!1,k=!1;a("#photo-stream ul.photostream:first").photoStreamSlider({backwardLink:"#photo-stream .rewind",forwardLink:"#photo-stream .ff",photoStream:"ul",duration:400,
onForward:function m(){if(!h){var p=this,n=p.find("ul").find("li:not(.dummy)"),q=n.filter(".visible");n=n.filter(":last");15>q.filter(":last").nextAll().length&&"object"!=typeof m.xhr&&(q=n.attr("data-photo-id"),m.xhr=a.post("?module=photo&action=loadList",{id:q,direction:1,hash:a.photos.hash},function(t){if("ok"==t.status){t=t.data.photos;if(0<t.length)a.photos.photo_stream_cache.append(t);else{h=!0;return}t.push(null);p.trigger("append",tmpl("template-photo-stream-list",{photos:t}))}delete m.xhr},
"json"))}},onBackward:function p(){if(!k){var n=this,q=n.find("ul").find("li:not(.dummy)"),t=q.filter(".visible");q=q.filter(":first");15>t.filter(":first").prevAll().length&&"object"!=typeof p.xhr&&(t=q.attr("data-photo-id"),p.xhr=a.post("?module=photo&action=loadList",{id:t,direction:-1,hash:a.photos.hash},function(u){if("ok"==u.status){u=u.data.photos;if(0<u.length)a.photos.photo_stream_cache.prepend(u);else{k=!0;return}u.unshift(null);n.trigger("prepend",tmpl("template-photo-stream-list",{photos:u}))}delete p.xhr},
"json"))}}})},updatePhotoStreamWidget:function(b){var e=a("#photo-stream ul.photostream:first");if(b.current_photo){var h=e.find("li.selected"),k=b.current_photo;h.attr("data-photo-id",k.id);h.find("a").attr("href","#/photo/"+k.id);h.find("img").attr("src",k.thumb_crop.url)}b.shift&&(e.find("li.selected").removeClass("selected"),e.find("li[data-photo-id="+b.shift+"]").addClass("selected"),e.trigger("home",[b.fn||function(){},!a.photos.shift_next]),a.photos.shift_next=!1)},updatePhotoName:function(b,
e){if("boolean"===typeof b||"undefined"===typeof b)e=b,b=null;var h=a("#photo-name");null!==b&&h.html(b);e?h.addClass("editable"):h.removeClass("editable")},updatePhotoDescription:function(b,e){if("boolean"===typeof b||"undefined"===typeof b)e=b,b=a.wa.encodeHTML(a("#photo-description").html());var h=a("#photo-description"),k=$_("add description");e?(h.addClass("editable"),e=k,a("#photo-description-edit-link").show()):(e=null,b=b!==k?b:"",h.removeClass("editable"),a("#photo-description-edit-link").hide());
h.inlineEditable("setOption",{placeholder:e}).html(b).trigger("placeholder",!!e)},updatePhotoRate:function(b,e){if("boolean"===typeof b||"undefined"===typeof b)e=b,b=null;var h=a("#photo-rate");null!==b&&h.rateWidget("setOption","rate",b);e?h.removeClass("hold").show():(h.addClass("hold"),(b=h.rateWidget("getOption","rate"))||h.hide())},updatePhotoTags:function(b){var e=a(".js-photos-tags");e.data("current_value",e.val());"undefined"!==typeof b&&("object"===typeof b&&b&&(b=a.photos.joinObject(b,",")),
e.importTags(b))},updatePhotoFrontendUrl:function(b){var e=a("#photo-frontend-url");b?(e.removeClass("hold"),a("#photo-frontend-url-edit-link").show()):(e.addClass("hold"),a("#photo-frontend-url-edit-link").hide())},updatePhotoOriginalBlock:function(b){a("#photo-original").html(tmpl("template-photo-original",{photo:b}))},initPhotoToolbar:function(b){a("#p-toolbar").html(tmpl("template-photo-toolbar",b)).addClass("rendered");a.photos.menu.init("photo");var e=a("#photos-photo-popular-tags");e.data("inited")||
e.off("click.photos","a").on("click.photos","a",function(){var h=a(this).text(),k=a("#photo-tags");k.removeTag(h);k.addTag(h)}).data("inited",!0);a.photos.updateViewPhotoMenu(a.isArray(b.stack)&&b.stack.length,b.photo.edit_rights)},renderPhotoBlock:function(b){var e=b.photo,h=a.photos._chooseProperThumb(e),k=e.thumb.size;"object"===typeof h.size&&h.size&&(e.thumb.size={width:h.size.width,height:h.size.height});a("#p-block").html(tmpl("template-photo",b)).addClass("rendered");"object"===typeof k&&
k&&(e.thumb.size={width:k.width,height:k.height});replaceImg(a("#photo"),h.url+(e.edit_datetime?"?"+Date.parseISO(e.edit_datetime):""),function(){a.photos.hooks_manager.trigger("afterRenderImg",this,e,h)})},initPhotoWidgets:function(b){var e=b.photo,h=b.exif,k=b.stack;b=b.photo_stream;var l=a.photos.hash;a.photos.initPhotoNameWidget(e.edit_rights);a.photos.initPhotoDescriptionWidget(e.edit_rights);a.photos.initPhotoRateWidget(e.edit_rights);a.photos.initPhotoTagsWidget(e.tags);a.photos.initPhotoContentControlWidget(e.edit_rights);
a.photos.hotkey_manager.set();a.photos.renderMap(h.GPSLatitude,h.GPSLongitude,e.name);a.isArray(k)&&k.length&&(a.photos.photo_stack_cache.set(k).setCurrentById(e.id),a.photos.initPhotoStackWidget({stack:k,photo_id:e.id,hash:a.photos.hash}));e=a.photos.photo_stream_cache;e.hash=l;e.set(b.photos).setCurrentById(b.current_photo_id);a.photos.initPhotoStreamWidget({photos:b.photos,current_photo:e.getCurrent()});a("#p-block .p-one-photo > .p-image-nav").click(function(){if(a(this).hasClass("p-rewind")){var m=
a.photos.photo_stream_cache.getPrev();m&&(a.photos.goToHash(a.photos.getHashByPhotoId(m.id),!1),a.photos.shift_next=!0)}else if(m=a.photos.photo_stream_cache.getNext())a.photos.goToHash(a.photos.getHashByPhotoId(m.id),!1),a.photos.shift_next=!0})},_chooseProperThumb:function(b){var e=b.thumb_big;b=b.thumb_middle;var h=a("#p-block").width();var k=e;"object"===typeof e.size&&e.size?(parseInt(e.size.height,10)>parseInt(b.bound.height,10)&&parseInt(e.size.height,10)>a(window).height()&&(k=b),parseInt(k.size.width,
10)>h&&(k.size.height=Math.round(h/parseInt(k.size.width,10)*parseInt(k.size.height,10)),k.size.width=h)):k.size={width:h,height:""};"object"===typeof k.size&&k.size||(k.size={widht:h,height:""});return k},setNextPhotoLink:function(b){var e=a("#photo").parents("a:first");(b=b?b:a.photos.photo_stream_cache.getNext())?(e.attr("title",$_("Next \u2192")),e.attr("href","#"+a.photos.hash+"/photo/"+b.id+"/")):(e.attr("title",""),e.attr("href","javascript:void(0);"))},setTitle:function(b){b&&(document.title=
b+a.photos.options.title_suffix)},ignore_scrolltop:!1,scrollTop:function(){a.photos.ignore_scrolltop?a.photos.ignore_scrolltop=!1:a(document).scrollTop(0)},load:function(b,e,h,k){var l=a("#content");"function"==typeof e&&(k=h||null);k&&(l.empty().append(k),l=l.find(":last-child"));"function"==typeof e?l.load(b,e):l.load(b,e,h)},setCover:function(){a.photos.centralizeLoadingIcon();a("#cover").show()},unsetCover:function(){a("#cover").hide()},centralizeLoadingIcon:function(){var b=a("#cover"),e=a("#cover .loading"),
h=b.width(),k=e.width();b=b.height();e=e.height();a(".loading").css({position:"absolute",left:parseInt((h-k)/2)+"px",top:parseInt((b-e)/2)+"px"})},saveField:function(b,e,h,k){var l="photo";1==arguments.length&&(l=a.extend({type:l,fn:function(){}},b),b=l.id,e=l.name,h=l.value,k=l.fn,l=l.type);if(!~["photo","album"].indexOf(l))throw"Unknown type";a.isArray(b)||(b=[{name:"id[]",value:parseInt(b)}]);var m=[].concat(b,{name:"name",value:e},{name:"value",value:h});a.post("?module="+l+"&action=saveField",
m,function(p){if("ok"==p.status){var n={};n[e]=h;p.data.parent_id&&(b=p.data.parent_id);a.photos._updateStreamCache(b,n);"function"==typeof k&&k(p)}else"fail"==p.status&&"function"==typeof k&&k(p)},"json")},saveFields:function(b,e,h){a.post("?module=photo&action=saveFields",{data:b},function(k){if("ok"==k.status)for(var l in k.data.update){var m=k.data.update[l].id;a.isArray(m)||(m=[m]);var p=k.data.update[l].data;l=0;for(var n=m.length;l<n;++l)a.photos.photo_stream_cache.updateById(m[l],p)}},"json")},
_updateStreamCache:function(b,e){a.isArray(b)||(b=[{value:b}]);for(var h=0,k=b.length;h<k;++h)a.photos.photo_stream_cache.updateById(b[h].value,e)},restoreOriginal:function(b,e){e=e||function(){};a.post("?module=photo&action=restore",{id:b},function(h){"ok"==h.status&&(h=h.data.photo,h=0==h.parent_id?a.photos.photo_stream_cache.updateById(b,h):a.photos.photo_stack_cache.updateById(b,h),a.photos.updatePhotoOriginalBlock(h),a.photos.updatePhotoImgs(h,e))},"json")},rotate:function(b,e,h){h=h||function(){};
a.post("?module=photo&action=rotate",{id:b,direction:e},function(k){"ok"==k.status&&(k=k.data.photo,k=0==k.parent_id?a.photos.photo_stream_cache.updateById(b,k):a.photos.photo_stack_cache.updateById(b,k),a.photos.updatePhotoOriginalBlock(k),a.photos.updatePhotoImgs(k,h))},"json").error(function(k){a.photos.showServerError(k.responseText);"function"==typeof h&&h()})},updatePhotoImgs:function(b,e){var h=a.photos._chooseProperThumb(b),k=b.edit_datetime?"?"+Date.parseISO(b.edit_datetime):"";replaceImg(a("#photo"),
h.url+k,function(){a("#photo").width(h.size.width).height(h.size.height);a("#photo-stream .selected img, #stack-stream .selected img").each(function(){var l=a(this);l.hasClass("thumb")?l.attr("src",b.thumb.url+k):l.attr("src",b.thumb_crop.url+k)});"function"==typeof e&&e();a.photos.hooks_manager.trigger("afterRenderImg",this,b,h)})},deletePhotos:function(b,e){a.post("?module=photo&action=resolution",a.isArray(b)?b:{photo_id:b},function(h){if("ok"==h.status){var k=h.data.photo_id;h=[];for(var l=[],
m=0,p=k.length;m<p;++m)h.push({name:"photo_id[]",value:k[m]});a.photos.massPost({photo_id:h,url:"?module=photo&action=delete",dataType:"json",data:{photos_length:a.isArray(b)?b.length:1},success:function(n,q){if("ok"==n.status){l=l.concat(n.data.denied_photo_id);n=0;for(var t=l.length;n<t;++n)q.push({name:"denied_photo_id[]",value:l[n]})}},fullSuccess:function(n){if("ok"==n.status)if(a.isArray(b)){n.data.alert_msg&&alert(n.data.alert_msg);var q={};a.each(k,function(r,v){q[v]=v});n.data.denied_photo_id&&
n.data.denied_photo_id.length&&a.each(n.data.denied_photo_id,function(r,v){delete q[v]});q=a.map(q,function(r,v){a.photos.photo_stream_cache.deleteById(k[r]);return v});a("#photo-list li.selected").trigger("select",!1);q.length?a.photos.makeDeleteAnimation(q,function(){e&&e(n)}):e&&e(n)}else{l.length&&alert($_("You don't have sufficient access rights"));if(n.data.parent_id){var t=a.photos.getHashByPhotoId(n.data.parent_id);a.photos.photo_stack_cache.deleteById(k)}else{var u=a.photos.photo_stream_cache;
t=(t=u.getNext(b))?a.photos.getHashByPhotoId(t.id):u.hash;u.deleteById(k)}a.wa.setHash(t);e&&e(n)}else e&&e(n)}})}},"json")},deleteAllAlbums:function(b,e,h){if(!b.length)return h&&h();var k=b.shift();a.photos.deleteAlbum(k,e,function(){a.photos.deleteAllAlbums(b,e,h)})},deleteAlbum:function(b,e,h){e?a.photos._deleteAlbumWithPhotos(b,h):a.post("?module=album&action=delete",{album_id:b},function(k){"ok"==k.status&&(a.photos.onDeleteAlbum(b),a.photos.goToHash(""),"function"==typeof h&&h())},"json")},
_deleteAlbumWithPhotos:function(b,e){a.post("?module=photo&action=resolution",{album_id:b},function(h){if("ok"==h.status){h=h.data.photo_id;for(var k=[],l=0,m=h.length;l<m;++l)k.push({name:"photo_id[]",value:h[l]});k.length?a.photos.massPost({url:"?module=photo&action=delete",photo_id:k,dataType:"json",fullSuccess:function(p){"ok"==p.status?a.photos.deleteAlbum(b,0,e):console&&console.log("Error while delete album")}}):a.photos.deleteAlbum(b,0,e)}},"json")},serializeData:function(b,e){if("object"===
typeof b&&!a.isArray(b)&&"undefined"===typeof e){var h=[];for(e in b)b.hasOwnProperty(e)&&h.push({name:e,value:b[e]});return h}a.isArray(b)||(b=[b]);h=0;for(var k=b.length,l=b[0];h<k;l=b[++h])"object"!=typeof l&&(l={name:e,value:l}),b[h]=l;return b},saveAccess:function(b){function e(m){for(var p=[],n=[],q=[],t=0,u=m.length;t<u;++t)p.push({name:"photo_id[]",value:m[t]});a.photos.massPost({photo_id:p,url:"?module=photo&action=manageAccessSave",dataType:"json",data:k,success:function(r,v){if("ok"==r.status){n=
n.concat(r.data.denied_photo_id);for(var x=0,A=n.length;x<A;++x)v.push({name:"denied_photo_id[]",value:n[x]});q=r.data.allowed_photo_id;x=0;for(A=q.length;x<A;++x)v.push({name:"allowed_photo_id[]",value:q[x]})}},fullSuccess:function(r){"ok"==r.status&&r.data.alert_msg&&onDeniedExist(r.data.alert_msg);"function"===typeof l&&l(r,q)}})}var h=b.photo_id||[],k=b.data||[],l=b.fn;onDeniedExist=b.onDeniedExist||function(m){alert(m)};resolution="boolean"===typeof b.resolution?b.resolution:!0;"object"!==typeof k||
a.isArray(k)||(k=a.photos.serializeData(k));k.push({name:"photos_length",value:h.length});resolution?a.post("?module=photo&action=resolution",a.isArray(h)?h:{photo_id:h},function(m){"ok"==m.status&&e(m.data.photo_id)},"json"):e(a.isArray(h)?h:[h])},addToAlbums:function(b){var e=b.photo_id||[],h=b.album_id||[],k=void 0==b.copy?1:b.copy,l=b.fn,m=b.onDeniedExist||function(p){alert(p)};e=a.photos.serializeData(e,"photo_id[]");h=a.photos.serializeData(h,"album_id[]");b=e.concat(h);b.push({name:"copy",
value:+k});a.post("?module=photo&action=addToAlbums",b,function(p){if("ok"==p.status){for(var n=[].concat(p.data.albums||[],p.data.old_albums||[]),q=0,t=n.length;q<t;++q){var u=n[q];a("#album-list li[rel="+u.id+"]").find(".count:first").text(u.count).end().find(".count-new:first").text(0<u.count_new?"+"+u.count_new:"")}p.data.alert_msg&&m(p.data.alert_msg)}"function"==typeof l&&l(p)},"json")},assignTags:function(b){var e=b.photo_id||[],h=b.tags||[],k=b.delete_tags||[],l=b.fn,m=b.onDeniedExist||function(p){alert(p)};
b=[];b=a.isArray(e)?e:b.concat([{name:"photo_id[]",value:e},{name:"one_photo",value:1}]);a.isArray(h)&&h.length?b=b.concat(h):(b.push({name:"tags",value:h}),k.length&&(b=b.concat(k)));a.post("?module=photo&action=assignTags",b,function(p){if("ok"==p.status){var n=p.data.cloud,q=a("#tag-cloud-block");a.isArray(n)&&!n.length||!n?q.hide():(a("#tag-cloud").html(tmpl("template-tag-cloud",{cloud:n})),q.show());n=p.data.tags||{};for(var t in n)n.hasOwnProperty(t)&&(q=n[t],a.photos._updateStreamCache(t,{tags:q}));
a("#album-create-dialog").remove();p.data.alert_msg&&m(p.data.alert_msg)}"function"==typeof l&&l(p)},"json")},makeStack:function(b,e){var h=b.shift();a.post("?module=photo&action=resolution",b,function(k){if("ok"==k.status){k=k.data.photo_id;for(var l=[],m=[],p=0,n=k.length;p<n;++p)k[p]!=h.value&&l.push({name:"photo_id[]",value:k[p]});a.photos.massPost({photo_id:l,data:{parent_id:h.value,photos_length:b.length},url:"?module=stack&action=make",dataType:"json",success:function(q,t){if("ok"==q.status&&
"ok"==q.status){m=m.concat(q.data.denied_photo_ids);q=0;for(var u=m.length;q<u;++q)t.push({name:"denied_photo_id[]",value:m[q]})}},fullSuccess:function(q){if("ok"==q.status){q.data.alert_msg&&alert(q.data.alert_msg);for(var t=0,u=b.length;t<u;++t)a.photos.photo_stream_cache.deleteById(b[t].value);a.photos.photo_stream_cache.updateById(q.data.parent_id,q.data.photo);a("#photo-list li.selected").trigger("select",!1);a.photos.makeStackAnimation([h].concat(b))}}})}},"json")},makeStackAnimation:function(b,
e){var h=b[0].value,k=a('li[data-photo-id="'+h+'"]'),l=k.offset(),m=a(window);(l.top<m.scrollTop()||l.top>m.scrollTop()+m.height())&&a("html, body").animate({scrollTop:l.top},300);m=[];for(var p=1;p<b.length;p++){var n=b[p].value,q=a('li[data-photo-id="'+n+'"]'),t=q.offset();t=q.clone().css({"z-index":10,position:"absolute",top:t.top,left:t.left}).insertAfter(q);q.css({opacity:0});m.push(q.hide(300).promise());a.photos.photo_stream_cache.deleteById(n);m.push(t.animate({top:l.top,left:l.left},300).promise().done(function(){a(this).remove()}))}a.when.apply(a,
m).done(function(){var u=k.hasClass("last");k.replaceWith(tmpl(a.photos.list_template,{photos:[a.photos.photo_stream_cache.getById(h)],hash:a.photos.hash,last_login_time:a.photos.options.last_login_time,options:{}}));u||a('li[data-photo-id="'+h+'"]').removeClass("last");a('li[data-photo-id="'+h+'"]').addClass("highlighted");"function"===typeof e&&e()})},makeDeleteAnimation:function(b,e){var h={};a.each(b,function(l,m){h[m]=!0});var k=a("#photo-list").children().filter(function(){return!!h[a(this).data("photo-id")]}).animate({width:0},
function(){k.remove();e&&e()})},highlightSidebarItem:function(){var b=decodeURIComponent(a.photos.hash);a("#p-sidebar li.selected").removeClass("selected");var e=a('#p-sidebar li a[href="#'+(b||"/")+'"]');e.length||(e=a('#p-sidebar li a[href^="#'+(b||"/")+'"]'));e.length&&e.parents("li:first").addClass("selected")},toggleFullScreen:function(){a.storage.get("photos/maximize_photo")?a("#wa-app").addClass("p-full-screen"):a("#wa-app").removeClass("p-full-screen")},hotkey_manager:function(){function b(m){var p=
m.target.type;m=m.keyCode;if(!(b.hold||"text"==p||"textarea"==p||37!=m&&39!=m)){if(39==m){if(p=a.photos.photo_stream_cache.getNext())a.photos.goToHash(a.photos.getHashByPhotoId(p.id),!1),a.photos.shift_next=!0;b.hold=!0}if(37==m){if(p=a.photos.photo_stream_cache.getPrev())a.photos.goToHash(a.photos.getHashByPhotoId(p.id),!1),a.photos.shift_next=!0;b.hold=!0}}}function e(m){b.hold=!1}function h(m){switch(m){case 48:case 96:m=0;break;case 49:case 97:m=1;break;case 50:case 98:m=2;break;case 51:case 99:m=
3;break;case 52:case 100:m=4;break;case 53:case 101:m=5;break;default:m=null}return m}function k(m){var p=m.target.type;if(!k.hold&&"text"!=p&&"textarea"!=p){var n=h(m.keyCode);"number"===typeof n&&(k.hold=!0,a("#photo").length?(m=a.photos.photo_stream_cache.getCurrent(),m.edit_rights&&a.photos.saveField(m.id,"rate",n,function(q){"ok"==q.status&&q.data.count&&(a("#rated-count").text(0<q.data.count?q.data.count:""),a("#photo-rate").rateWidget("setOption","rate",n))})):(m=a("input[name^=photo_id]").map(function(){return this.checked?
{name:"id[]",value:this.value}:null}).toArray(),m.length&&a.photos.saveField({id:m,name:"rate",value:n,fn:function(q){if("ok"==q.status){var t=q.data.allowed_photo_id&&!a.isArray(q.data.allowed_photo_id)?q.data.allowed_photo_id:{};a("#photo-list li.selected").each(function(){var u=a(this);t[u.attr("data-photo-id")]&&a.photos.updateThumbRate(u,n)}).find("input:first").trigger("select",!1);q.data.count&&a("#rated-count").text(0<q.data.count?q.data.count:"");q.data.alert_msg&&alert(q.data.alert_msg)}}})))}}
function l(){k.hold=!1}return{set:function(m){"undefined"===typeof m?a(document).bind("keydown",b).bind("keyup",e).bind("keydown",k).bind("keyup",l):"rate"===m&&a(document).bind("keydown",k).bind("keyup",l)},unset:function(){a(document).unbind("keydown",b).unbind("keyup",e).unbind("keyup",k).unbind("keyup",l)}}}(),getHashByPhotoId:function(b){return a.photos.hash+"/photo/"+b},setLazyLoad:function(){var b=null;a(window).lazyLoad({container:"#photo-list",load:function(){b=b||a("#photo-list li").length;
a(window).lazyLoad("sleep");a(".lazyloading-wrapper .lazyloading-progress").show();a(".lazyloading-wrapper .lazyloading-link").hide();a.post("?module=photo&action=loadList",{offset:b,hash:a.photos.hash},function(e){if(e.data.hash==a.photos.hash){var h=a("#photo-list");if(e.data.photos.length){var k=a.photos.photo_stream_cache.length();a.photos.photo_stream_cache.append(e.data.photos);h.find("li.last").removeClass("last");a.photos.renderPhotoListChunk(h,k,{string:e.data.string},function(){!a.photos.total_count||
a.photos.total_count>a.photos.photo_stream_cache.length()?a(window).lazyLoad("wake"):(a(".lazyloading-wrapper .lazyloading-progress").hide(),a(".lazyloading-wrapper .lazyloading-link").hide(),a(window).lazyLoad("stop"))});b+=e.data.photos.length}else a(".lazyloading-wrapper .lazyloading-progress").hide(),a(".lazyloading-wrapper .lazyloading-link").hide(),a(window).lazyLoad("stop")}},"json")}});a(".lazyloading-wrapper a.lazyloading-link").die("click.lazyloading").live("click.lazyloading",function(){a(window).lazyLoad("force");
return!1})},unsetLazyLoad:function(){a(window).lazyLoad&&a(window).lazyLoad("stop");a(".lazyloading-wrapper a.lazyloading-link").die("click.lazyloading")},getAlbum:function(){return this.album=this.album||null},setAlbum:function(b){this.album=b},unsetAlbum:function(){this.album=null},getPhotoId:function(){var b=/photo\/(\d+)[\/]*$/.exec(location.href);return b?parseInt(b[1]):null},isCurrentPhotoStack:function(){var b=this.getPhotoId();return b?(b=this.photo_stream_cache.getById(b))&&0<b.stack_count:
!1},goToHash:function(b,e){e="undefined"===typeof e?!0:e;b=b.replace(/^\/*/,"").replace(/\/*\s*$/,"");location.hash.replace(/^[^#]*#\/*/,"").replace(/\/*\s*$/,"")==b&&e?(a.photos.ignore_scrolltop=!0,a.photos.dispatch()):location.hash=b?"/"+b+"/":"/"},goToAnchor:function(b){b=a("a[name="+b+"]");b.length&&a(document).scrollTop(b.position().top)},photo_stream_cache:new PhotoStream,onCreateAlbum:function(b,e){var h=tmpl("template-album-list-item",b),k=a("#album-list");if(e){var l=k.find("li[rel="+e+"]");
var m=l.find("ul:first");m.length||(l.append('<ul class="menu-v with-icons"></ul>'),m=l.find("ul:first"),l.find(".count:first").after('<i class="icon16 darr overhanging collapse-handler" id="album-'+e+'-handler"></i>'));m.prepend(h)}else m=k.find("ul:first"),m.length||(k.find(".p-empty-album-list").hide(),k.prepend('<ul class="menu-v with-icons"><li class="drag-newposition"></li></ul>').find("ul:first")),k.find("ul:first").prepend(h);k.find(".new-item").removeClass("new-item").mouseover();b.type||
(h=a("#p-upload-step2 select[name=album_id]"),e?(e=h.find("option[value="+e+"]"),h=e.text().replace(/[^-]/g,"")+"-",e.after('<option value="'+b.id+'">'+h+" "+b.name+"</option>")):h.find("optgroup").prepend('<option value="'+b.id+'">'+b.name+"</option>"))},onDeleteAlbum:function(b){var e=a("#album-list"),h=e.find("li[rel="+b+"]"),k=h.find("ul:first"),l=h.parents("ul:first");h.hide();if(k.length){h.prev(".drag-newposition:first").remove();h.next(".drag-newposition:first").remove();var m=k.children("li");
m.hide().insertAfter(h);k.remove();h.remove();m.show()}else h.next(".drag-newposition:first").remove().end().remove();l.length&&!l.find("li:not(.drag-newposition)").length&&(h=l.parent("li"),h.length&&h.find("i.collapse-handler").remove(),l.remove());e.find("ul:first").length||e.find(".p-empty-album-list").show();a("#p-upload-step2 select[name=album_id]").find("option[value="+b+"]").remove()},fixRightToolbar:function(){a.photos.fixRightToolbar._handler=function e(){var h=a("#p-toolbar");h.length&&
(h.hasClass("rendered")?h.removeClass("p-fixed"):(e.top||(e.top=h.children(":first").position().top),a(this).scrollTop()>e.top?h.addClass("p-fixed"):h.removeClass("p-fixed")))};a.photos.fixRightToolbar._handler.call(document);a(document).bind("scroll",a.photos.fixRightToolbar._handler)},photo_stack_cache:new PhotoStream,isSelectedAnyPhoto:function(){return!!a("#photo-list li.selected:first").length},getRatingHtml:function(b,e,h){e=e||10;b=Math.round(2*b)/2;if(!b&&!h)return"";h="";for(var k=1;5>=k;k+=
1)h+='<i class="icon'+e+" star",k>b&&(h=.5==k-b?h+"-half":h+"-empty"),h+='"></i>';return h},uploadDialog:function(){a("#p-uploader").waDialog({onLoad:a.photos.onUploadDialog,onClose:a.photos.dialogClearSteps,onSubmit:function(){a("#p-start-upload-button").click();return!1}})},dialogClearSteps:function(){a("#p-upload-step2").hide();a("#p-upload-step2-buttons").hide();a("#p-upload-step3").hide();a("#p-upload-step3-buttons").hide();a("#p-upload-step1").show();a("#p-upload-step1-buttons").show()},onUploadDialog:function(){a(this);
a(this).find(".files").empty();var b=a.storage.get("photos/hash"),e=a("#p-upload-step2 select[name=album_id]");b&&~b.indexOf("album")?(b=parseInt(b.replace(/\/?album\//,"")),b=e.find("optgroup option[value="+b+"]"),b.length?b.attr("selected",!0):e.find("option:first").attr("selected",!0)):e.find("option:first").attr("selected",!0)},massPost:function(b){function e(t){p?(n?(k=n.splice(0,h),b.data=l.concat(k)):b.data=l,p-=h,p=0<p?p:0,a.ajax(b)):"function"==typeof b.fullSuccess&&b.fullSuccess(t)}var h=
b.chunk_count||25,k,l=[];if(a.isArray(b.data))l=l.concat(b.data);else if("object"==typeof b.data)for(var m in b.data)l.push({name:m,value:b.data[m]});b.type="post";var p=parseInt(b.count)||0,n=b.photo_id;if(b.photo_id){n=b.photo_id;if(a.isArray(n))n=[].concat(n);else{l.push({name:"photo_id",value:n});b.data=l;b.success=b.fullSuccess;a.ajax(b);return}p=n.length}if("function"==typeof b.success){var q=b.success;b.success=function(t){q(t,l);e(t)}}else b.success=e;e()},confirmDialog:function(b){var e=
a("#confirm-dialog");e.length||(e=a('<div id="confirm-dialog"></div>'),a("body").append(e));b.url&&e.load(b.url,function(){var h=a.extend({},b);delete h.url;var k=a(this),l=h.onLoad;h.onLoad=function(){e.find("input[type=submit]").focus();"function"===typeof l&&l()};k.find("div:first").waDialog(h)})},showServerError:function(b){b?(console&&console.log("Server error occurred:\n"+b),alert(b)):console&&console.log("Server error occurred")},initAlbumThumbsDragAndDrop:function(b,e){b.sortable({handle:"img",
distance:5,tolerance:"pointer",stop:function(h,k){a.post("?module=album&action=move",{id:k.item.data("album-id"),before_id:k.item.next().data("album-id")||0,parent_id:e})}})},toggleReviewWidget:function(){this.$photoList.length&&(this.$photoList.find("li.highlighted").length?a(".i-product-review-widget-wrappper").show():a(".i-product-review-widget-wrappper").hide())},hooks_manager:{handlers:{},bind:function(b,e,h){if(1==arguments.length&&arguments[0]&&"object"===typeof arguments[0]){var k=arguments[0];
for(b in k)k.hasOwnProperty(b)&&this.bind(b,k[b])}else return h=h||(""+Math.random()).slice(2),this.handlers[b]=this.handlers[b]||{},this.handlers[b][h]=e,e.handler_name=h},unbind:function(b,e){var h=e;"undefined"===typeof e?this.handlers[b]={}:("function"===typeof e&&(h=e.handler_name),"function"===typeof this.handlers[b][h]&&delete this.handlers[b][h])},trigger:function(b){var e=this.handlers[b];if(e&&"object"===typeof e){var h=Array.prototype.slice.call(arguments,1),k;for(k in e)e.hasOwnProperty(k)&&
"function"===typeof e[k]&&e[k].apply(null,h)}}}}})(jQuery);
$(function(){$(".p-one-photo .next").live("click",function(){$.photos.shift_next=!0});$(".dialog").die().live("change_loading_status",function(a,c){c=c||!1;a=$(this).find("input[type=submit]");c?a.attr("disabled",!0).after('<i style="vertical-align: middle" class="icon16 loading"></i>'):a.attr("disabled",!1).next("i").remove()});(function(){var a=!1;$(document).on("selectstart","#photo-list",function(){return!a});$(document).keydown(function(c){16==c.keyCode&&(a=!0)}).keyup(function(c){16==c.keyCode&&
(a=!1)})})();$("#photo-list li").live("select",function(a,c,d){d=void 0!==d?d:!0;(void 0!==c?c:1)?$(this).addClass("selected").find("input:first").attr("checked",!0):(a=$("#selector-menu").find('[data-action="select-photos"]'),a.data("checked")&&a.data("checked",!1).find(".unchecked").show().end().find(".checked").hide(),$(this).removeClass("selected").find("input:first").attr("checked",!1));d&&$("#share-menu-block, #organize-menu-block").trigger("recount")});(function(){function a(g,f,b){if(g&&f&&
g[0]&&f[0]&&!g.is(f[0])){var e=!1;f.parent().children().each(function(h,k){if(e){if(g.is(k)||f.is(k))return!1;h=$(k).find(".p-details input:checkbox");h.prop("checked")!=b&&h.prop("checked",b).change()}else if(g.is(k)||f.is(k))e=!0})}}var c=null,d=null;$("#content").on("click","#photo-list li .p-details input:checkbox, #photo-list li .p-details label",function(g){var f=$(this).closest("li"),b=f.find(".p-details input:checkbox");if(b.is(g.target))var e=b.prop("checked");else e=!b.prop("checked"),b.prop("checked",
e).change();e?(g.shiftKey&&c&&a(c,f,!0),c=f,d=null):(g.shiftKey&&d&&a(d,f,!1),c=null,d=f)})})();$("#content").off($.photos.namespace+"-photo-list-select-checkbox").on("change"+$.photos.namespace+"-photo-list-select-checkbox",':checkbox[name="photo_id[]"]',function(){this.checked?$(this).closest("li").addClass("selected"):$(this).closest("li").removeClass("selected");$("#share-menu-block, #organize-menu-block").trigger("recount")});$.photos.hooks_manager.bind("afterLoadPhoto",function(){$.photos.photo_stream_cache.getPrev()?
$("#p-block .p-one-photo > .p-image-nav.p-rewind").show():$("#p-block .p-one-photo > .p-image-nav.p-rewind").hide();$.photos.photo_stream_cache.getNext()?$("#p-block .p-one-photo > .p-image-nav.p-ff").show():$("#p-block .p-one-photo > .p-image-nav.p-ff").hide()});$.photos_dragndrop.init()});
function ToolbarMenu(a,c){var d=null;return{init:function(){d=$(a);d.length&&d.activeMenu(c);return this},enable:function(g){g?d.activeMenu("enable",g):(d.parents("div:first").show(),d.activeMenu("fire"));return this},disable:function(g){g?d.activeMenu("disable",g):d.parents("div:first").hide();return this},setAction:function(g,f){c[g]=f;d&&d.activeMenu("setOption",g,f);return this},getAction:function(g){return c[g]},is:function(g){return d?d.is(g):$(a).is(g)}}};(function(a){a.photos.menu.register("list","#organize-menu",{addToAlbumAction:function(){var c=a("#choose-albums");c.length&&c.parent().remove();a("<div></div>").appendTo("body").load("?module=dialog&action=albums",function(){a("#choose-albums").waDialog({onLoad:function(){a(this).find("h1:first span:first").text("("+a("#photo-list li.selected").length+")")},onSubmit:function(d){var g=a("input[name^=photo_id]").serializeArray(),f=a(this).serializeArray();if(!f.length)return alert($_("Please select at least one album")),
!1;if(!g.length)return d.trigger("close"),!1;d.trigger("change_loading_status",!0);a.photos.addToAlbums({photo_id:g,album_id:f,copy:1,fn:function(){a("#photo-list li.selected").trigger("select",!1);d.trigger("change_loading_status",!1).trigger("close")}});return!1}})})},assignTagsAction:function(){var c=$_("add a tag");a("#photo-list-tags-dialog").waDialog({onLoad:function(){var d=a("#photo-list-tags-dialog #photos-list-tags");a("#photo-list-tags-dialog .tagsinput").length||d.tagsInput({autocomplete_url:"?module=tag&action=list",
height:200,width:"100%",defaultText:c});d.importTags("");a("#photo-list-tags-dialog .js-selected-counter").text("("+a("input[name^=photo_id]:checked").length+")");var g=[];a("input[name^=photo_id]:checked").each(function(){g.push(a(this).val())});for(var f={},b=a.photos.photo_stream_cache.getAll(),e=0,h=a.photos.photo_stream_cache.length();e<h;e++){var k=b[e];if(-1!=a.inArray(k.id,g)&&(k=k.tags,!a.isEmptyObject(k)))if(a.isEmptyObject(f))f=k;else for(var l in k)k.hasOwnProperty(l)&&(f[l]=k[l])}a("#photos-tags-remove-list").empty();
if(jQuery.isEmptyObject(f))a("#photo-tags-remove").hide();else for(l in a("#photo-tags-remove").show(),f)a("#photos-tags-remove-list").append(a("<label></label>").text(f[l]).prepend('<input name="delete_tags[]" value="'+l+'" type="checkbox"> ')).append("<br>");a("#photo-list-tags-dialog .dialog-window").height(a("#photo-list-tags-dialog .dialog-content-indent").outerHeight());a("#photos-popular-tags").off("click.photos","a").on("click.photos","a",function(){var m=a(this).text();d.removeTag(m);d.addTag(m)})},
onSubmit:function(d){var g=a("#photos-list-tags_tag");if(g.length&&g.val()!=c){var f=jQuery.Event("keypress",{which:13});g.trigger(f)}g=a("input[name^=photo_id]:checked").serializeArray();f=a("#photo-list-tags-dialog #photos-list-tags").val();var b=a("#photos-tags-remove-list input[name^=delete_tags]:checked").serializeArray();if(!f.length&&!b.length)return alert($_("Please select at least one tag")),!1;if(!g.length)return d.trigger("close"),!1;d.trigger("change_loading_status",!0);a.photos.assignTags({photo_id:g,
tags:f,delete_tags:b,fn:function(e){if("ok"==e.status){e=e.data.tags;var h=a("#photo-list li.selected"),k;for(k in e)if(e.hasOwnProperty(k)){var l=tmpl("template-photo-list-photo-tags",{tags:e[k]});h.filter("[data-photo-id="+k+"]:first").find(".tags>span").html(l)}h.trigger("select",!1);d.trigger("change_loading_status",!1).trigger("close")}}});return!1}})},deleteFromAlbumAction:function(){var c=a("input[name^=photo_id]").serializeArray();if(c.length){var d=a.photos.getAlbum().id;a.post("?module=photo&action=deleteFromAlbum&id="+
d,c,function(){a.photos.dispatch()},"json")}},deletePhotosAction:function(){var c=a("input[name^=photo_id]").serializeArray();c.length&&a.photos.confirmDialog({url:"?module=dialog&action=confirmDeletePhotos&cnt="+c.length,onSubmit:function(d){d.trigger("change_loading_status",!0);a.photos.deletePhotos(c,function(){a.photos.unsetCover();d.trigger("change_loading_status",!1).trigger("close");a("#photo-list li.selected").trigger("select",!1)});return!1}})},setRateAction:function(){var c=a('<div id="set-rate"></div>').waDialog({url:"?module=dialog&action=rates",
className:"width300px height200px",onLoad:function(d){c.find(".p-rate-photo-counter").text("("+a("input[name^=photo_id]:checked").length+")");a("#photos-rate",d).rateWidget({withClearAction:!1,onUpdate:function(g){var f=c;g=a("#photos-rate",f).rateWidget("getOption","rate");var b=a("input[name^=photo_id]").map(function(){return this.checked?{name:"id[]",value:this.value}:null}).toArray();if(!b.length)return f.trigger("close"),!1;a.photos.saveField({id:b,name:"rate",value:g,fn:function(e){if("ok"==
e.status){var h=e.data.allowed_photo_id&&!a.isArray(e.data.allowed_photo_id)?e.data.allowed_photo_id:{};a("#photo-list li.selected").each(function(){var k=a(this);h[k.attr("data-photo-id")]&&a.photos.updateThumbRate(k,g)}).find("input:first").trigger("select",!1);e.data.count&&a("#rated-count").text(0<e.data.count?e.data.count:"");e.data.alert_msg&&alert(e.data.alert_msg);f.trigger("close")}}});return!1}})}})},makeStackAction:function(){var c=a("input[name^=photo_id]").serializeArray();if(2>c.length)return alert($_("Please select at least two photos")),
!1;a.photos.makeStack(c);return!1},manageAccessAction:function(){var c=a("input[name^=photo_id]").serializeArray();a.photos.showManageAccessDialog(c,function(d){var g=a(this),f=g.serializeArray(),b=g.find("input[name=status]:checked").val();if(!c.length)return d.trigger("close"),!1;d.trigger("change_loading_status",!0);a.photos.saveAccess({photo_id:c,data:f,fn:function(e,h){e=a("#photo-list li.selected");for(var k=0,l=h.length;k<l;++k){var m=e.filter("[data-photo-id="+h[k]+"]:first").find(".p-image-corner.top.left");
m.find(".lock-bw").remove();0>=b&&m.append('<i class="icon16 lock-bw p-private-photo" title="'+$_("Private photo")+'"></i>')}a.photos._updateStreamCache(h,{status:b});a("#photo-list li.selected").trigger("select",!1);d.trigger("change_loading_status",!1).trigger("close")}});return!1});return!1},beforeAnyAction:function(c){if("make-stack"!=c&&!a.photos.isSelectedAnyPhoto())return alert($_("Please select at least one photo")),!1},onFire:function(){a("#organize-menu").trigger("recount")}});a.photos.menu.register("list",
"#selector-menu",{selectPhotosAction:function(c){var d=a("#share-menu-block, #organize-menu-block").find(".count");c.data("checked")?(c.data("checked",!1),c.find(".unchecked").show().end().find(".checked").hide(),d.text("").hide()):(c.data("checked",!0),c.find(".checked").show().end().find(".unchecked").hide(),d.text(a.photos.total_count).show());a("#photo-list li").trigger("select",[!!c.data("checked"),!1])}});a.photos.menu.register("list","#share-menu",{embedAction:function(){var c=a("#embed-photo-list-dialog"),
d=a.storage.get("photos/embed_size"),g=a("#photo-list li.selected").map(function(){var h=a(this).attr("data-photo-id"),k=a.photos.photo_stream_cache.getById(h);0>=k.status&&(h+=":"+k.hash);return h}).toArray().join(","),f=a.photos.getAlbum(),b=a.photos.hash,e={photo_ids:g,hash:b,size:d};f&&0>=f.status&&(b=b.replace(/\/*$/,"")+":"+f.hash+"/",e.hash=b);f="?module=dialog&action=embedPhotoList&photo_ids="+g+"&hash="+b;d&&(f+="&size="+d);c.length||(c=a('<div id="embed-photo-list-dialog"></div>'),a("body").append(c));
c.load(f,function(){c.find("div:first").waDialog({onLoad:function(){function h(n){var q=h.data,t=!1,u;for(u in q)if(q.hasOwnProperty(u)&&q[u]!==n[u]){t=!0;break}h.data=a.extend({},n);t&&(c.find("h1").find(".loading").parent().show(),a.post("?module=photo&action=embedList",n,function(r){if("ok"==r.status){var v=r.data.context;c.find("input[name=link]").val(v.link);c.find("a.link").attr("href",v.link);c.find("textarea[name=urls]").val(v.urls);c.find("#embed-photo-list-html").val(v.html);c.find("#embed-photo-list-html-with-descriptions").val(v.html_with_descriptions);
c.find("textarea[name=smarty_code]").val(v.smarty_code);c.find("h1 span:first").text("("+v.count+")");v.all_public?c.find(".exclamation-message").hide():c.find(".exclamation-message").show();v.domains=v.domains||{};p.children().each(function(){var x=a(this),A=x.attr("value");x.data("frontend-url",(v.domains[A]||{}).frontend_url||"")});k();l()}c.find("h1").find(".loading").parent().hide()},"json"))}function k(){a.each(["textarea[name=urls]","#embed-photo-list-html","#embed-photo-list-html-with-descriptions"],
function(n,q){n=a(q);n.data("context_data",n.val())})}function l(){if(!p.length)return!1;a.each(["textarea[name=urls]","#embed-photo-list-html","#embed-photo-list-html-with-descriptions"],function(q,t){q=a(t);q.val(q.data("context_data").split(p.data("original-domain")).join(p.val()))});var n=p.children(":selected");n.data("frontend-url")?(c.find("input[name=link]").val(n.data("frontend-url")).closest(".field").slideDown(),c.find("a.link").attr("href",n.data("frontend-url"))):c.find("input[name=link]").closest(".field").slideUp()}
var m=c.find("select[name=size]");d&&m.val(d);m.change(function(){var n=a(this).val();e.size=n;h(e);a.storage.set("photos/embed_size",n)});c.find("input[name=description]").click(function(){this.checked?(a("#embed-photo-list-html-with-descriptions").show().attr("disabled",!1),a("#embed-photo-list-html").hide().attr("disabled",!0)):(a("#embed-photo-list-html").show().attr("disabled",!1),a("#embed-photo-list-html-with-descriptions").hide().attr("disabled",!0))});c.find("input[name=link], textarea[name=urls], textarea[name=html], textarea[name=smarty_code]").click(function(){a(this).getSelection().length||
a(this).select()});c.find("input[name=link]").focus().select();c.find(".switcher").activeMenu({selectedPhotosAction:function(n){e.size=c.find("select[name=size]").val();e.photo_ids=g;h(e)},allListPhotosAction:function(n){e.size=c.find("select[name=size]").val();e.photo_ids="";h(e)}}).find("li").click(function(){a(this).parent().find(".selected").removeClass("selected").end().end().addClass("selected")});h.data=h.data||a.extend({},e);var p=c.find("select[name=domain]");p.length&&(k(),l(),p.change(l))},
onSubmit:function(){return!1}})});return!1},beforeAnyAction:function(c){if(!a.photos.isSelectedAnyPhoto()&&"blog-post"!=c&&"embed"!=c)return alert($_("Please select at least one photo")),!1},blogPostAction:function(){for(var c=a("#blog-post-form"),d=a("#photo-list li.selected").map(function(){return a(this).attr("data-photo-id")}).toArray(),g=[0,0],f=0;f<d.length;f++){var b=a.photos.photo_stream_cache.getById(d[f]);b||(b=a.photos.photo_stack_cache.getById(d[f]));b&&(b.hash&&(d[f]+=":"+b.hash),++g[b.status])}f=
a.photos.getAlbum();b=a.photos.hash;var e={photo_ids:d.join(","),hash:b,size:obligatory_size};f&&0>=f.status&&(b=b.replace(/\/*$/,"")+":"+f.hash+"/",e.hash=b);e.hash=null;a("#photo-blog-dialog :submit").attr("disabled",!0);a.post("?module=photo&action=embedList",e,function(h){"ok"==h.status&&(h=h.data.context,c.find('[name="title"]:input').val(a("#photo-list-name").text()),c.find('[name="text"]:input').val(blog_smarty_enabled?h.smarty_code:h.html_with_descriptions),g[0]?a("#photo-blog-dialog :submit").attr("disabled",
!1):c.submit())},"json");g[0]&&a("#photo-blog-dialog").waDialog({onLoad:function(){a("#photo-blog-dialog :submit").attr("disabled",!0);var h=a("#photo-blog-dialog p"),k=[g[0],d.length];h.html(h.html().replace(/(%d)/g,function(){return k.shift()}))},onSubmit:function(){c.submit();return!1}});return!1},onFire:function(){a("#share-menu").trigger("recount")}});a("#p-sidebar a, #wa-header a, a.album-view, #photo-list div.p-image a").live("click",function(c){if(a("#save-menu-block").is(":visible")&&a("#save-menu-block input.button").hasClass("yellow")&&
!confirm($_("Unsaved changes will be lost if you leave this page now. Are you sure?")))return c.preventDefault(),!1});a.photos.menu.register("list","#save-menu",{saveDescriptionAction:function(){var c={},d,g,f;a("#photo-list.p-descriptions :text,#photo-list.p-descriptions textarea").each(function(){if(this.defaultValue!=this.value&&(d=a(this).attr("name").match(/^photo\[(\d+)\]\[(\w+)\]$/))){g=d[1];f=d[2];var e=a.photos.photo_stream_cache.getById(g);e&&this.value==e[f]||(c[g]||(c[g]={id:g}),c[g][f]=
this.value)}});a.photos.saveFields(c);a("#photo-list.p-descriptions :text.highlighted,#photo-list.p-descriptions textarea.highlighted").each(function(){a(this).removeClass("highlighted")});var b=a("#save-menu-block .count.indicator");b.length&&(b.text(0),a("#save-menu-block input.button").removeClass("yellow").addClass("green"),b.hide());return!1},hideNameAction:function(c,d){var g=c.find(":checkbox"),f=g.prop("checked");"INPUT"!=d.target.tagName&&(f=!f);f?(a('#photo-list li :text[name$="[name]"]').hide(),
a('#photo-list li textarea[name$="[description]"].js-small').css("height","+=27").removeClass("js-small").addClass("js-big")):(a('#photo-list li :text[name$="[name]"]').show(),a('#photo-list li textarea[name$="[description]"].js-big').css("height","-=27").removeClass("js-big").addClass("js-small"));setTimeout(function(){g.attr("checked",f)},50);a.storage.set("photos/list/hide_name",f)},onFire:function(){var c=a("#save-menu-block .count.indicator");c.length&&(c.text("0"),a("#save-menu-block input.button").removeClass("yellow").addClass("green"),
c.hide())},onInit:function(c){c.find('[data-action="hide-name"] :checkbox').prop("checked",a.storage.get("photos/list/hide_name",!1));c=function(){var d=[],g;a("#photo-list.p-descriptions :text,#photo-list.p-descriptions textarea").each(function(){if(this.defaultValue!=this.value&&(g=a(this).attr("name").match(/^photo\[(\d+)\]\[(\w+)\]$/))){var e=g[1];if(0>d.indexOf(e)){var h=a.photos.photo_stream_cache.getById(e);h&&this.value==h[g[2]]?a(this).hasClass("highlighted")&&a(this).removeClass("highlighted"):
(a(this).addClass("highlighted"),d.push(e))}}else a(this).hasClass("highlighted")&&a(this).removeClass("highlighted")});var f=a("#save-menu-block .count.indicator"),b=d.length;f.length&&f.text(b);b?(a("#save-menu-block input.button").removeClass("green").addClass("yellow"),f.show()):(a("#save-menu-block input.button").removeClass("yellow").addClass("green"),f.hide())};a("#p-content").on("change.photos-save-menu","#photo-list.p-descriptions :text, #photo-list.p-descriptions textarea",c);a("#p-content").on("keyup.photos-save-menu",
"#photo-list.p-descriptions :text, #photo-list.p-descriptions textarea",c)}})})(jQuery);(function(a){a.photos.menu.register("photo","#photo-organize-menu",{addToAlbumAction:function(){a('<div id="choose-albums-photo"></div>').waDialog({url:"?module=dialog&action=albums&id="+a.photos.getPhotoId(),className:"width600px height400px",onSubmit:function(c){var d=a.photos.photo_stream_cache.getCurrent().id;a.photos.addToAlbums({photo_id:d,album_id:a(this).serializeArray(),copy:0,fn:function(g){if("ok"==g.status){var f=g.data.old_albums||[],b=a.photos.getAlbum();g=g.data.albums;if(b)for(var e=
0,h=f.length;e<h;++e)if(b.id==f[e].id){g.length?a.photos.goToHash("/album/"+g[0].id+"/photo/"+d):a.photos.goToHash("/photo/"+d);c.trigger("close");return}a("#photo-albums").html(tmpl("template-photo-albums",{albums:g}));c.trigger("close")}}});return!1}})},deletePhotoAction:function(){a.photos.confirmDialog({url:"?module=dialog&action=confirmDeletePhoto&id="+a.photos.getPhotoId(),onSubmit:function(c){c.trigger("close");a.photos.setCover();a.photos.deletePhotos(a.photos.getPhotoId(),function(){a.photos.unsetCover()});
return!1}})},unstackAction:function(){a.photos.confirmDialog({url:"?module=dialog&action=confirmUnstack&cnt="+a.photos.photo_stack_cache.length(),onSubmit:function(c){c.trigger("close");c=a.photos.photo_stream_cache.getCurrent().id;a.post("?module=stack&action=unmake&id="+c,{},function(d){a.photos.goToHash(a.photos.hash)},"json");return!1}})},manageAccessAction:function(){var c=a.photos.photo_stream_cache.getCurrent().id;a.photos.showManageAccessDialog("photo_id="+c,function(d){var g=a(this).serializeArray();
g.push({name:"one_photo",value:1});a.photos.saveAccess({photo_id:a.photos.photo_stream_cache.getCurrent().id,data:g,fn:function(f){var b=f.data.photo,e=f.data.stack;if(b)b=a.photos.photo_stream_cache.updateById(b.id,b),a.photos.initPhotoContentControlWidget({frontend_link_template:f.data.frontend_link_template,photo:b}),a.photos.updatePhotoImgs(b);else if(e&&a.isArray(e)&&e.length){b=a.photos.photo_stack_cache;for(var h=b.getCurrent(),k=0,l=e.length;k<l;++k)b.updateById(e[k].id,e[k]);a.photos.initPhotoContentControlWidget({frontend_link_template:f.data.frontend_link_template,
photo:h});a.photos.updatePhotoImgs(h)}d.trigger("close")},onDeniedExist:function(){alert($_("You don't have sufficient access rights"))}});return!1});return!1}});a.photos.menu.register("photo","#edit-menu",{beforeAnyAction:function(){a.photos.setCover()},rotateLeftAction:function(){a.photos.rotate(a.photos.getPhotoId(),"left",function(){a.photos.unsetCover()})},rotateRightAction:function(){a.photos.rotate(a.photos.getPhotoId(),"right",function(){a.photos.unsetCover()})},onInit:function(){a(window).resize(a.photos.centralizeLoadingIcon)}});
a.photos.menu.register("photo","#share-menu",{embedAction:function(){var c=a("#embed-photo-dialog"),d=a.photos.getPhotoId(),g=a.photos.hash,f=a.storage.get("photos/embed_size");d="?module=dialog&action=embedPhoto&photo_id="+d+"&hash="+g;f&&(d+="&size="+f);c.length||(c=a('<div id="embed-photo-dialog"></div>'),a("body").append(c));c.load(d,function(){c.find("div:first").waDialog({onLoad:function(){function b(){k.length&&a.each(["textarea[name=html]","input[name=url]"],function(l,m){l=a(m);l.data("context_data",
l.val())})}function e(){if(!k.length)return!1;a.each(["textarea[name=html]","input[name=url]"],function(m,p){m=a(p);m.val(m.data("context_data").split(k.data("original-domain")).join(k.val()))});var l=k.children(":selected");l.data("frontend-url")?(c.find("input[name=link]").val(l.data("frontend-url")).closest(".field").slideDown(),c.find("a.link").attr("href",l.data("frontend-url"))):c.find("input[name=link]").closest(".field").slideUp()}var h=c.find("select[name=size]");h.val(f);h.change(function(){var l=
a(this).val(),m=c.data("contexts")[l];c.find("textarea[name=html]").val(m.html);c.find("input[name=url]").val(m.url);a.storage.set("photos/embed_size",l);b();e()});var k=c.find("select[name=domain]");k.length&&(b(),e(),k.change(e));c.find("input[name=url], textarea[name=html], input[name=link]").click(function(){a(this).getSelection().length||a(this).select()});c.find("input[name=link]").focus().select()},onSubmit:function(){return!1}})});return!1},blogPostAction:function(){var c=a("#blog-post-form"),
d=a.photos.getPhotoId(),g=a.photos.photo_stream_cache.getById(d);g||(g=a.photos.photo_stack_cache.getById(d));g&&(d=g.id,g.hash&&(d+=":"+g.hash),d={photo_ids:d,hash:null,size:obligatory_size},a("#photo-blog-dialog :submit").attr("disabled",!0),a.post("?module=photo&action=embedList",d,function(f){"ok"==f.status&&(f=f.data.context,c.find('[name="title"]:input').val(g.name),f=f.html_with_descriptions,c.find('[name="text"]:input').val(f.replace(/^<p>(.*)<\/p>$/mi,"$1")),parseInt(g.status)?c.submit():
a("#photo-blog-dialog :submit").attr("disabled",!1))},"json"),parseInt(g.status)||a("#photo-blog-dialog").waDialog({onLoad:function(){a("#photo-blog-dialog :submit").attr("disabled",!0);var f=a("#photo-blog-dialog p"),b=[1,1];f.html(f.html().replace(/(%d)/g,function(){return b.shift()}))},onSubmit:function(){c.submit();return!1}}));return!1}});a("#restore-original").live("click",function(){confirm($_("This will reset all changes you applied to the image after upload and will restore the original image. Are you sure?"))&&
(a.photos.setCover(),a.photos.restoreOriginal(a.photos.getPhotoId(),function(){a.photos.unsetCover()}))})})(jQuery);$.photos=$.photos||{};$.photos.widget=$.photos.widget||{};
$.photos.widget.loupe={options:{animate:!0,debug:!1},css:{init:{width:null,"max-width":null,"margin-left":0,"margin-top":0,height:null}},drag:!1,loaded:!1,photo_data:null,thumb_data:null,container:null,helper:null,link:null,offset:{},status:"thumb",init:function(a){this.options=$.extend(this.options,a||{});var c=this;c.trace("init");$.photos.hooks_manager.bind("afterRenderImg",function(d,g,f){c.trace("afterRenderImg");c.prepare(d,g,f)});$.photos.hooks_manager.bind("beforeLoadPhoto",function(){c.trace("beforeLoadPhoto");
c.stop()});$.photos.hooks_manager.bind("onAbortPrevLoading",function(){c.trace("onAbortPrevLoading");c.stop()})},trace:function(a){console&&this.options.debug&&console.log(a)},prepare:function(a,c,d){var g=this;$(".p-one-photo a.next").die("click.loupe").live("click.loupe",function(f){return g.clickNextHandler.apply(g,[this,f])});this.trace("prepare, status="+this.status);this.photo_data=c;this.container=a;this.thumb_data={height:d.size.height,width:d.size.width,src:d.url};"thumb"!=this.status&&this.stop();
this.loaded=!1;this.reset()},reset:function(){this.trace("reset, status="+this.status);this.link=$("#photo-loupe-link");$("div.photo-loupe-wrapper").length&&(this.container.css({width:this.thumb_data.width+"px","max-width":"",height:this.thumb_data.height+"px","margin-left":"","margin-top":""}),this.container.unwrap());this.status="thumb";this.link.find(".minimize").hide();this.thumb_data.width&&this.thumb_data.width<this.photo_data.width||this.thumb_data.height&&this.thumb_data.height<this.photo_data.height?
(this.link.find(".maximize").show(),this.options.animate=this.thumb_data.height&&this.thumb_data.width?!0:!1):this.link.find(".maximize").hide();var a=this;this.link.unbind(".loupe").bind("click.loupe",function(c){return a.clickHandler.apply(a,[this,c])}).show()},clickHandler:function(){this.trace("clickHandler, status="+this.status);switch(this.status){case "loading":this.container.stop();case "maximized":this.status="unloading";this.link.find(".minimize").hide();this.link.find(".maximize").show();
this.decrease();break;case "thumb":this.status="loading",this.link.find(".minimize").hide(),this.link.find(".maximize").hide(),this.enlarge()}return!1},clickNextHandler:function(a,c){(a="thumb"==this.status?!0:!1)||c.preventDefault();this.trace("clickNextHandler "+a);return a},interaction:function(a,c,d){d=d.parents("body");switch(c.type){case "mouseup":this.drag&&(c.preventDefault(),this.drag=!1,$("div.photo-loupe-wrapper").css("cursor","auto"),$("body").css("cursor",""),d.unbind(".loupe-move"));
break;case "mousedown":case "click":this.clickNextHandler(a,c);if(!this.drag){$("div.photo-loupe-wrapper").css("cursor","move");this.drag=!0;this.offset.mouseX=c.pageX;this.offset.mouseY=c.pageY;var g=this;d.bind("mouseover.loupe-move mousemove.loupe-move",function(f){return g.watch.apply(g,[this,f])})}break;case "mouseleave":this.drag&&(c.preventDefault(),$("div.photo-loupe-wrapper").css("cursor","auto"),this.drag=!1,d.unbind(".loupe-move"))}},enlarge:function(){this.drag=!1;var a=this;this.trace("enlarge, status="+
this.status);$("#photo").removeClass("ui-draggable").closest(".p-image").addClass("p-image-maximized");this.offset=this.container.offset();this.offset.x=Math.round((this.thumb_data.width-this.photo_data.width)/2);this.offset.y=Math.round((this.thumb_data.height-this.photo_data.height)/2);this.container.wrap('<div class="photo-loupe-wrapper" style="height:'+this.thumb_data.height+"px;width:"+this.thumb_data.width+'px;position: relative;"/>');this.container.removeAttr("width").removeAttr("height").css({width:this.thumb_data.width+
"px",height:this.thumb_data.height+"px","margin-left":0,"margin-top":0,"max-width":this.photo_data.width+"px",display:"inline-block"});this.options.animate?this.container.animate({width:this.photo_data.width+"px",height:this.photo_data.height+"px","margin-left":this.offset.x+"px","margin-top":this.offset.y+"px","max-width":this.photo_data.width+"px"},function(){return a.enlargeComplete.apply(a,[this])}):(this.container.css({width:this.photo_data.width+"px",height:this.photo_data.height+"px","margin-left":this.offset.x+
"px","margin-top":this.offset.y+"px","max-width":this.photo_data.width+"px"}),this.enlargeComplete());this.link.find(".minimize").show();this.bind(this.container);if(!this.helper){var c=$("#photo-loupe");this.helper=c.length?c.first():$('<img id="photo-loupe"/>');this.helper.load(function(d){a.loaded=!0})}this.helper.attr("src","?module=photo&action=download&photo_id="+this.photo_data.id+"&attach="+(this.photo_data.edit_datetime||this.photo_data.upload_datetime))},enlargeComplete:function(){if(this.loaded)this.trace("enlargeComplete, status="+
this.status),this.helper.css({width:this.photo_data.width+"px",height:this.photo_data.height+"px","margin-left":this.offset.x+"px","margin-top":this.offset.y+"px","max-width":this.photo_data.width+"px"}).show(),this.container.before(this.helper).hide(),this.container.unbind(".loupe .loupe-move"),this.bind(this.helper),this.container.css({width:this.thumb_data.width+"px","max-width":"",height:this.thumb_data.height+"px","margin-left":"","margin-top":""}),this.link.find(".minimize").show(),this.status=
"maximized";else{var a=this;setTimeout(function(){return a.enlargeComplete.apply(a,[this])},50)}},bind:function(a){this.trace("bind, status="+this.status);var c=this;a.bind("mousedown.loupe",function(d){return c.interaction.apply(c,[this,d,a])});$(document).bind("mouseup.loupe",function(d){return c.interaction.apply(c,[this,d,a])})},stop:function(){this.trace("stop at status="+this.status);var a=this.status;this.status="stop";switch(a){case "loading":this.container.stop();this.decrease(!0);break;
case "maximized":this.decrease(!0);break;case "unloading":this.helper&&this.helper.stop(),this.decreaseComplete(!0)}this.container&&this.container.find("*").unbind(".loupe .loupe-move");$(document).unbind(".loupe .loupe-move");a=$("div.photo-loupe-wrapper");$("#photo-loupe-link img:visible").hide();$("body").css("cursor","");a.length&&this.container.unwrap();this.helper&&(this.helper.remove(),this.helper=null);this.status="thumb"},decrease:function(a){this.trace("decrease, status="+this.status);this.loaded=
!1;var c=this,d={width:this.thumb_data.width+"px",height:this.thumb_data.height+"px","margin-left":0,"margin-top":0};a||!this.options.animate?(this.helper.css(d),c.decreaseComplete()):this.helper.animate(d,function(){c.decreaseComplete()});return!1},decreaseComplete:function(a){this.trace("decreaseComplete, status="+this.status);$("#photo").addClass("ui-draggable").closest(".p-image").removeClass("p-image-maximized");this.container.css(this.css.init).show();this.helper.hide();a||this.reset()},watch:function(a,
c){this.drag&&(c.preventDefault(),this.offset.x=Math.min(0,Math.max(this.thumb_data.width-this.photo_data.width,Math.round(this.offset.x-this.offset.mouseX+c.pageX))),this.offset.y=Math.min(0,Math.max(this.thumb_data.height-this.photo_data.height,Math.round(this.offset.y-this.offset.mouseY+c.pageY))),this.offset.mouseX=c.pageX,this.offset.mouseY=c.pageY,("loading"==this.status?this.container:this.helper).css({"margin-left":this.offset.x+"px","margin-top":this.offset.y+"px"}))}};(function(){jQuery.each({getSelection:function(){var a=this.jquery?this[0]:this;return("selectionStart"in a&&function(){var c=a.selectionEnd-a.selectionStart;return{start:a.selectionStart,end:a.selectionEnd,length:c,text:a.value.substr(a.selectionStart,c)}}||document.selection&&function(){a.focus();var c=document.selection.createRange();if(null===c)return{start:0,end:a.value.length,length:0};var d=a.createTextRange(),g=d.duplicate();d.moveToBookmark(c.getBookmark());g.setEndPoint("EndToStart",d);
return{start:g.text.length,end:g.text.length+c.text.length,length:c.text.length,text:c.text}}||function(){return null})()},replaceSelection:function(a){var c="function"==typeof this.id?this.get(0):this,d=a||"";return("selectionStart"in c&&function(){c.value=c.value.substr(0,c.selectionStart)+d+c.value.substr(c.selectionEnd,c.value.length);return this}||document.selection&&function(){c.focus();document.selection.createRange().text=d;return this}||function(){c.value+=d;return jQuery(c)})()}},function(a){jQuery.fn[a]=
this})})();!function(a){var c=[],d=[];a.fn.doAutosize=function(f){var b=a(this).data("minwidth"),e=a(this).data("maxwidth"),h="",k=a(this),l=a("#"+a(this).data("tester_id"));h!==(h=k.val())&&(h=h.replace(/&/g,"&amp;").replace(/\s/g," ").replace(/</g,"&lt;").replace(/>/g,"&gt;"),l.html(h),l=l.width(),f=l+f.comfortZone>=b?l+f.comfortZone:b,(k.width()>f&&f>=b||f>b&&e>f)&&k.width(f))};a.fn.resetAutosize=function(f){var b=a(this).data("minwidth")||f.minInputWidth||a(this).width();f=a(this).data("maxwidth")||f.maxInputWidth||
a(this).closest(".tagsinput").width()-f.inputPadding;var e=a(this),h=a("<tester/>").css({position:"absolute",top:-9999,left:-9999,width:"auto",fontSize:e.css("fontSize"),fontFamily:e.css("fontFamily"),fontWeight:e.css("fontWeight"),letterSpacing:e.css("letterSpacing"),whiteSpace:"nowrap"}),k=a(this).attr("id")+"_autosize_tester";0< !a("#"+k).length&&(h.attr("id",k),h.appendTo("body"));e.data("minwidth",b);e.data("maxwidth",f);e.data("tester_id",k);e.css("width",b)};a.fn.addTag=function(f,b){return b=
jQuery.extend({focus:!1,callback:!0},b),this.each(function(){var e=a(this).attr("id"),h=a(this).val().split(c[e]);if(""==h[0]&&(h=[]),f=jQuery.trim(f),b.unique){var k=a(this).tagExist(f);1==k&&a("#"+e+"_tag").addClass("not_valid")}else k=!1;if(""!=f&&1!=k){if(a("<span>").addClass("tag").append(a("<span>").text(f).append("&nbsp;&nbsp;"),a("<a>",{href:"#",title:"Removing tag",text:"x"}).click(function(){return a("#"+e).removeTag(escape(f))})).insertBefore("#"+e+"_addTag"),h.push(f),a("#"+e+"_tag").val(""),
b.focus?a("#"+e+"_tag").focus():a("#"+e+"_tag").blur(),a.fn.tagsInput.updateTagsField(this,h),b.callback&&d[e]&&d[e].onAddTag)k=d[e].onAddTag,k.call(this,f);if(d[e]&&d[e].onChange){var l=h.length;k=d[e].onChange;k.call(this,a(this),h[l-1])}}}),!1};a.fn.removeTag=function(f){return f=unescape(f),this.each(function(){var b=a(this).attr("id"),e=a(this).val().split(c[b]);a("#"+b+"_tagsinput .tag").remove();str="";for(i=0;i<e.length;i++)e[i]!=f&&(str=str+c[b]+e[i]);(a.fn.tagsInput.importTags(this,str),
d[b]&&d[b].onRemoveTag)&&d[b].onRemoveTag.call(this,f)}),!1};a.fn.tagExist=function(f){var b=a(this).attr("id");b=a(this).val().split(c[b]);return 0<=jQuery.inArray(f,b)};a.fn.importTags=function(f){var b=a(this).attr("id");a("#"+b+"_tagsinput .tag").remove();a.fn.tagsInput.importTags(this,f)};a.fn.tagsInput=function(f){var b=jQuery.extend({interactive:!0,defaultText:"add a tag",minChars:0,width:"300px",height:"100px",autocomplete:{selectFirst:!1},hide:!0,delimiter:",",unique:!0,removeWithBackspace:!0,
placeholderColor:"#666666",autosize:!0,comfortZone:20,inputPadding:12},f),e=0;return this.each(function(){if("undefined"==typeof a(this).attr("data-tagsinput-init")){a(this).attr("data-tagsinput-init",!0);b.hide&&a(this).hide();var h=a(this).attr("id");h&&!c[a(this).attr("id")]||(h=a(this).attr("id","tags"+(new Date).getTime()+e++).attr("id"));var k=jQuery.extend({pid:h,real_input:"#"+h,holder:"#"+h+"_tagsinput",input_wrapper:"#"+h+"_addTag",fake_input:"#"+h+"_tag"},b);c[h]=k.delimiter;(b.onAddTag||
b.onRemoveTag||b.onChange)&&(d[h]=[],d[h].onAddTag=b.onAddTag,d[h].onRemoveTag=b.onRemoveTag,d[h].onChange=b.onChange);var l='<div id="'+h+'_tagsinput" class="tagsinput"><div id="'+h+'_addTag">';if(b.interactive&&(l=l+'<input id="'+h+'_tag" value="" data-default="'+b.defaultText+'" />'),l+='</div><div class="tags_clear"></div></div>',a(l).insertAfter(this),a(k.holder).css("width",b.width),a(k.holder).css("min-height",b.height),a(k.holder).css("height",b.height),""!=a(k.real_input).val()&&a.fn.tagsInput.importTags(a(k.real_input),
a(k.real_input).val()),b.interactive){if(a(k.fake_input).val(a(k.fake_input).attr("data-default")),a(k.fake_input).css("color",b.placeholderColor),a(k.fake_input).resetAutosize(b),a(k.holder).bind("click",k,function(m){a(m.data.fake_input).focus()}),a(k.fake_input).bind("focus",k,function(m){a(m.data.fake_input).val()==a(m.data.fake_input).attr("data-default")&&a(m.data.fake_input).val("");a(m.data.fake_input).css("color","#000000")}),void 0!=b.autocomplete_url){autocomplete_options={source:b.autocomplete_url};
for(attrname in b.autocomplete)autocomplete_options[attrname]=b.autocomplete[attrname];void 0!==jQuery.Autocompleter?(a(k.fake_input).autocomplete(b.autocomplete_url,b.autocomplete),a(k.fake_input).bind("result",k,function(m,p,n){p&&a("#"+h).addTag(p[0]+"",{focus:!0,unique:b.unique})})):void 0!==jQuery.ui.autocomplete&&(a(k.fake_input).autocomplete(autocomplete_options),a(k.fake_input).bind("autocompleteselect",k,function(m,p){return a(m.data.real_input).addTag(p.item.value,{focus:!0,unique:b.unique}),
!1}))}else a(k.fake_input).bind("blur",k,function(m){var p=a(this).attr("data-default");return""!=a(m.data.fake_input).val()&&a(m.data.fake_input).val()!=p?m.data.minChars<=a(m.data.fake_input).val().length&&(!m.data.maxChars||m.data.maxChars>=a(m.data.fake_input).val().length)&&a(m.data.real_input).addTag(a(m.data.fake_input).val(),{focus:!0,unique:b.unique}):(a(m.data.fake_input).val(a(m.data.fake_input).attr("data-default")),a(m.data.fake_input).css("color",b.placeholderColor)),!1});a(k.fake_input).bind("keypress",
k,function(m){return g(m)?(m.preventDefault(),m.data.minChars<=a(m.data.fake_input).val().length&&(!m.data.maxChars||m.data.maxChars>=a(m.data.fake_input).val().length)&&a(m.data.real_input).addTag(a(m.data.fake_input).val(),{focus:!0,unique:b.unique}),a(m.data.fake_input).resetAutosize(b),!1):void(m.data.autosize&&a(m.data.fake_input).doAutosize(b))});k.removeWithBackspace&&a(k.fake_input).bind("keydown",function(m){if(8==m.keyCode&&""==a(this).val()){m.preventDefault();m=a(this).closest(".tagsinput").find(".tag:last").text();
var p=a(this).attr("id").replace(/_tag$/,"");m=m.replace(/[\s]+x$/,"");a("#"+p).removeTag(escape(m));a(this).trigger("focus")}});a(k.fake_input).blur();k.unique&&a(k.fake_input).keydown(function(m){(8==m.keyCode||String.fromCharCode(m.which).match(/\w+|[\u00e1\u00e9\u00ed\u00f3\u00fa\u00c1\u00c9\u00cd\u00d3\u00da\u00f1\u00d1,/]+/))&&a(this).removeClass("not_valid")})}}}),this};a.fn.tagsInput.updateTagsField=function(f,b){var e=a(f).attr("id");a(f).val(b.join(c[e]))};a.fn.tagsInput.importTags=function(f,
b){a(f).val("");var e=a(f).attr("id");b=b.split(c[e]);for(i=0;i<b.length;i++)a(f).addTag(b[i],{focus:!1,callback:!1});d[e]&&d[e].onChange&&d[e].onChange.call(f,f,b[i])};var g=function(f){var b=!1;return 13==f.which?!0:("string"==typeof f.data.delimiter?f.which==f.data.delimiter.charCodeAt(0)&&(b=!0):a.each(f.data.delimiter,function(e,h){f.which==h.charCodeAt(0)&&(b=!0)}),b)}}(jQuery);
//# sourceMappingURL=photos-jquery.min.js.map
