(function(a){a.wa.controller={free:!0,hashes:[],init:function(c){this.frontend_url=c&&c.url||"/";this.backend_url=c&&c.backend_url||"/webasyst/";a.storage=new a.store;a.ajaxSetup({cache:!1});this.lastView={title:null,hash:null,sort:null,order:null,offset:null};this.options=c;this.random=null;a.wa.dropdownsCloseEnable();"undefined"!=typeof a.History&&a.History.bind(function(b){a.wa.controller.dispatch(b)});a.wa.errorHandler=function(b){return 404==b.status?(a.wa.setHash("/contacts/all/"),!1):!0};a("#contacts-container .contacts-data input.selector").live("click",
function(){a(this).is(":radio")&&a(this).parents(".contact-row").siblings().removeClass("selected");a(this).is(":checked")?a(this).parents(".contact-row").addClass("selected"):a(this).parents(".contact-row").removeClass("selected");a.wa.controller.updateSelectedCount()});a(".collapse-handler",a("#wa-app")).die("click").live("click",function(){a.wa.controller.collapseSidebarSection(this,"toggle")});this.restoreCollapsibleStatusInSidebar();a("ul.collapsible i.darr").click(function(){a(this).hasClass("darr")?
(a(this).parent("li").children("ul").hide(),a(this).removeClass("darr").addClass("rarr")):(a(this).parent("li").children("ul").show(),a(this).removeClass("rarr").addClass("darr"))});var b=null,e=function(e){if(e.hasClass("animated"))return!1;e.addClass("animated");e.hoverIntent({over:function(){b=setTimeout(function(){b=null},500);e.removeClass("disabled")},timeout:0.3,out:function(){e.addClass("disabled");b&&(clearTimeout(b),b=null)}});return!0};a("#c-list-toolbar-menu",a("#c-core")[0]).live("mouseover",
function(){var b=a(this);e(b)&&b.mouseover()});a("#c-list-toolbar-menu",a("#c-core")[0]).live("click",function(d){var c=a(this);if((!b||c.hasClass("disabled"))&&!(0<a(d.target).parents("ul#c-list-toolbar-menu ul").size()))c.toggleClass("disabled"),!e(c)&&b&&(clearTimeout(b),b=null)});a(document).ajaxError(function(){a.storage.del("contacts/last-hash")});a("#c-core").off("click.contact-choose",".contact-row a.contact").on("click.contact-choose",".contact-row a.contact",function(){a.wa.controller.setLastView({offset:a(this).data("offset")||
0,sort:a.wa.grid.settings.sort,order:a.wa.grid.settings.order,title:a.wa.controller.getTitle(),hash:location.hash||""})});a("#c-core").off("click.contact-choose","a.contact.next, a.contact.prev").on("click.contact-choose","a.contact.next, a.contact.prev",function(){a.wa.controller.setLastView({offset:a(this).data("offset")||0})})},stopDispatch:function(a){this.stopDispatchIndex=a},previousHash:null,redispatch:function(){this.previousHash=null;this.dispatch()},dispatch:function(c,b){var c=void 0===
c?this.getHash():this.cleanHash(c),e=c.replace(/^[^#]*#\/*/,""),d=(this.previousHash||"").replace(/^[^#]*#\/*/,"");e!==d&&this.hashes.unshift(c.replace(/^[^#]*#\/*/,""));10<this.hashes.length&&this.hashes.pop();if(0<this.stopDispatchIndex)return this.previousHash=c,this.stopDispatchIndex--,!1;if(this.previousHash!=c){e=this.previousHash;this.previousHash=c;d=new a.Event("wa_before_dispatched");a(window).trigger(d,[c]);if(d.isDefaultPrevented())return this.previousHash=e,window.location.hash=e,!1;
if(c=c.replace(/^[^#]*#\/*/,"")){d=!0;c=c.split("/");if(c[0]){for(var h="",f=c.length,g=0;g<c.length;g++)if(e=c[g],2>g)if(0===g)h=e;else if(parseInt(e,10)!=e&&-1==e.indexOf("."))h+=e.substr(0,1).toUpperCase()+e.substr(1);else{f=g;break}else{f=g;break}e=c.slice(f);this[h+"Action"]?(this.currentAction=h,this.currentActionAttr=e,this[h+"Action"].apply(this,[].concat([e],b||[]))):(d=!1,console&&console.log("Invalid action name:",h+"Action"),a.wa.setHash("#/contacts/all/"))}else this.defaultAction();c.join&&
(c=c.join("/"));d&&a.storage.set("contacts/last-hash",c)}else this.defaultAction(),a.storage.del("contacts/last-hash");this.highlightSidebar();a(document).trigger("hashchange",[c]);a(window).trigger("wa-dispatched")}},lastPage:function(){var c=a.storage.get("contacts/last-hash");c?a.wa.setHash("#/"+c):this.defaultAction()},defaultAction:function(){this.contactsAllAction()},groupsCreateAction:function(a){this.current_group_id=0;this.groupsEditAction(a,$_("New user group"))},groupsEditAction:function(c,
b){b=$_("New user group");c[0]&&(this.current_group_id=c[0],b=this.groups[this.current_group_id].name);a("#c-users-sidebar-menu").length?this.showLoading():this.setBlock("contacts-users",b);this.setTitle(b);this.load("#c-core .c-core-content","?module=groups&action=editor"+(c&&c[0]?"&id="+c[0]:""),null,null,function(){this.setTitle(b);a("#c-group-edit-name").focus();a(".wa-page-heading .loading").hide();a("#c-users-sidebar-menu li.selected").removeClass("selected");!c||!c[0]?a("#c-create-group-toggle").addClass("selected"):
a("#list-group li[rel=group"+c[0]+"]").addClass("selected")})},categoriesCreateAction:function(){this.categoriesEditAction()},categoriesEditAction:function(a){this.loadHTML("?module=categories&action=editor"+(a&&a[0]?"&id="+a[0]:""),null,function(){this.setBlock()})},categoriesDeleteAction:function(c){var b=!0;if(!c||!c[0])c=[this.current_category_id],b=!1;a.wa.dialogCreate("delete-dialog",{content:a("<h2>"+$_("Delete this category?")+"</h2><p>"+$_("No contacts will be deleted.")+"</p>"),buttons:a("<div></div>").append(a('<input type="submit" class="button red" value="'+
$_("Delete category")+'">').click(function(){0>=a(this).find(".loading").size()&&a('<i style="margin: 8px 0 0 10px" class="icon16 loading"></i>').insertAfter(this);a.post("?module=categories&action=delete",{id:c[0]},function(){a.wa.controller.reloadSidebar();a.wa.dialogHide();a.wa.setHash("#/users/all/")})})).append(" "+$_("or")+" ").append(a('<a href="javascript:void(0)">'+$_("cancel")+"</a>").click(function(){a.wa.dialogHide();b&&(a.wa.controller.stopDispatch(1),a.wa.back())})),small:!0});return!1},
deleteCustomField:function(c){a('.custom-field-th[data-field-id="'+c+'"]').remove();a('.custom-field-td[data-field-id="'+c+'"]').remove();if(a(".custom-field-th").length)for(var c=["first","last"],b=0;b<c.length;b+=1){var e=c[b],d=a(".custom-field-th."+e);d.length||(d.removeClass(e),a(".custom-field-td."+e).removeClass(e),a(".custom-field-th:"+e).addClass(e),a(".contact-row").each(function(){a(this).find(".custom-field-td:"+e).addClass(e)}))}else a(".with-custom-fields").removeClass("with-custom-fields"),
a(".list-with-custom-fields").removeClass("list-with-custom-fields")},contactsGroupAction:function(c){if(c&&c[0]){var b=this.parseParams(c.slice(1),"contacts/group/"+c[0]);b.fields=["name","email","company","_access"];b.query="group/"+c[0];a(".wa-page-heading").css({width:""});this.loadGrid(b,"/contacts/group/"+c[0]+"/",!1,{beforeLoad:function(b){this.current_group_id=c[0];if(b.count>0)this.setBlock("contacts-users",null,["group-settings","group-actions"]);else{this.setBlock("contacts-users",null,
"group-settings");a("#contacts-container").html('<div class="block double-padded" style="margin-top: 35px;"><p>'+$_("No users in this group.")+"</p> <p>"+$_('To add users to group, go to <a href="#/users/all/">All users</a>, select them, and click <strong>Actions with selected / Add to group</strong>.')+"</p></div>");return false}},afterLoad:function(b){a('#list-group li[rel="group'+c[0]+'"]').children("span.count").html(b.count)}})}},groupsDeleteAction:function(c){var b=!0;if(!c||!c[0])c=[this.current_group_id],
b=!1;a.wa.dialogCreate("delete-dialog",{content:a("<h2>"+$_("Delete this group?")+"</h2><p>"+$_("No contacts will be deleted.")+"</p>"),buttons:a("<div></div>").append(a('<input type="submit" class="button red" value="'+$_("Delete group")+'">').click(function(){a('<i style="margin: 8px 0 0 10px" class="icon16 loading"></i>').insertAfter(this);a.post("?module=groups&action=delete",{id:c[0]},function(){a('#wa-app .sidebar a[href="#/contacts/group/'+c[0]+'/"]').parent().remove();0>=a("#list-group").find(".c-group").length&&
a("#list-group").find(".c-shown-on-no-groups").show();delete a.wa.controller.groups[c[0]];a.wa.dialogHide();a.wa.setHash("#/users/all/")})})).append(" "+$_("or")+" ").append(a('<a href="javascript:void(0)">'+$_("cancel")+"</a>").click(function(){a.wa.dialogHide();b&&(a.wa.controller.stopDispatch(1),a.wa.back())})),small:!0});return!1},clearLastView:function(){this.lastView={title:null,hash:null,sort:null,order:null,offset:null}},contactsAddAction:function(c){this.setBlock("contacts-info");this.load(a("#c-core .c-core-content"),
"?module=contacts&action=add"+(c&&c[0]?"&company=1":""),{},null,function(){a.wa.controller.setTitle($_("New contact"),!0);a.wa.controller.clearLastView()})},contactAction:function(a){var b={};a[1]&&(b={tab:a[1]});this.lastView&&null!==this.lastView.hash&&(b.last_hash=this.lastView.hash,b.sort=this.lastView.sort,b.offset=this.lastView.offset);this.showLoading();this.load("#c-core","?module=contacts&action=info&id="+a[0],b,function(){this.setBlock("contacts-info")})},contactPhotoAction:function(a){this.showLoading();
this.loadHTML("?module=photo&action=editor&id="+a[0]+(a[1]?"&uploaded=1":""),{},function(){this.setBlock("contacts-info")})},contactsAllAction:function(c){this.showLoading();this.loadGrid(this.parseParams(c,"contacts/all"),"/contacts/all/",!1,{beforeLoad:function(){this.setBlock("contacts-list")},afterLoad:function(b){a("#sb-all-contacts-li span.count").html(b.count)}})},contactsSearchAction:function(c,b){this.showLoading();"results"==c[0]&&(b||(b={search:!0}),c=c.slice(1));var e=c[0];"?"==e.substr(0,
1)&&(e=e.substr(1));var d=this.parseParams(c.slice(1),"contacts/search/"+e);d.query=e;b&&b.search&&(d.search=1);c[5]||(d.view="list");e=this.cleanHash("#/contacts/search/"+e);a.wa.controller.setBlock("contacts-list",null,["search-actions"]);this.loadGrid(d,e.substr(1),null,{afterLoad:function(){a.wa.controller.hideLoading();if(b&&b.search){a("#list-main .item-search").show();a("#list-main .item-search a").attr("href","#/contacts/search/results/"+c[0]+"/");d.search=1}}})},contactsCategoryAction:function(c){if(c&&
c[0]){this.showLoading();var b=this.parseParams(c.slice(1),"contacts/category/"+c[0]);b.query="/category/"+c[0];this.loadGrid(b,"/contacts/category/"+c[0]+"/",!1,{beforeLoad:function(b){this.current_category_id=c[0];this.setBlock("contacts-list",null,b&&b.system_category?[]:["category-actions"])},afterLoad:function(b){a('#list-category li[rel="category'+c[0]+'"]').children("span.count").html(b.count)}})}},usersAllAction:function(c){this.showLoading();c=this.parseParams(c,"users/all");c.query="/users/all/";
c.fields=["name","email","company","_access"];this.loadGrid(c,"/users/all/",!1,{beforeLoad:function(){this.setBlock("contacts-users",$_("All users"),["group-actions"])},afterLoad:function(b){a("#sb-all-users-li span.count").html(b.count);a("#c-core .sidebar ul.stack li:first").addClass("selected")}})},usersAddAction:function(){this.checkAdminRights(function(){this.setBlock("contacts-users",$_("New user"),!1);this.setTitle($_("New user"));a(".wa-page-heading").find(".loading").hide();a(".contacts-data").html('<div class="block double-padded"><p>'+
$_("You can grant access to your account backend to any existing contact.")+"<br><br>"+$_('Find a contact, or <a href="#/contacts/add/">create a new contact</a>, and then customize their access rights on Access tab.')+"</p></div>")})},addToGroupDialog:function(){if(0>=a.wa.grid.getSelected().length)return!1;a.wa.controller.last_selected=a.wa.grid.getSelected();a.wa.dialogCreate("c-d-add-to-group",{url:"?module=groups&action=add"})},addToGroup:function(c){a.post("?module=groups&action=contactSave",
{"id[]":a.wa.grid.getSelected(),"groups[]":c||[]},function(b){a.wa.controller.last_selected=[];"ok"===b.status?(a.wa.controller.updateGroupCounters(b.data.counters||{}),a.wa.controller.afterInitHTML=function(){a.wa.controller.showMessage(b.data.message,!0,"float-left max-width")},a.wa.controller.redispatch(),a.wa.dialogHide(),a.wa.grid.selectItems(a("#c-select-all-items").attr("checked",!1))):a.wa.controller.showMessage(b.data.message)},"json")},updateGroupCounters:function(c){if(!a.isEmptyObject(c))for(var b in c)if(c.hasOwnProperty(b)){var e=
c[b]||0;a("#list-group").find("li[rel=group"+b+"] .count").text(e);this.groups[b]&&(this.groups[b].cnt=e)}},merge:function(){var c=a.wa.grid.getSelected();if(2>c.length)return!1;c=c.join(",");a.wa.setHash("/contacts/merge/"+c)},contactsMergeAction:function(c){if(c[0]){for(var b=[],c=c[0].split(","),e=0;e<c.length;e+=1)parseInt(c[e],10)&&b.push(c[e]);a("#c-abc-index").remove();this.showLoading();this.load("#c-core .c-core-content","?module=contacts&action=mergeSelectMaster",{ids:b},null,function(){a(window).unbind("wa_after_merge_contacts").one("wa_after_merge_contacts",
function(b,e){e&&"ok"===e.status&&(a(window).one("wa_after_load",function(){a.wa.controller.showMessage(e.data.message)}),a.wa.setHash("#/contact/"+e.data.master.id))});a(window).unbind("wa_cancel_merge_contacts").one("wa_cancel_merge_contacts",function(){var b=a.wa.controller.hashes;b[1]?a.wa.setHash(b[1]):a.wa.setHash("")})})}else a.wa.setHash("/contacts/all/")},simpleSearch:function(){var c=a.trim(a("#search-text").val());if(c){var b="",c=c.replace(/\//g,"\\/").replace(/&/,"\\&"),b=-1!=c.indexOf("@")?
"email*="+c:"name*="+c;a.wa.controller.stopDispatch(1);a.wa.setHash("#/contacts/search/"+b+"/");a.wa.controller.contactsSearchAction([b],{search:!0})}},addToCategory:function(c,b){b=b||a.wa.grid.getSelected();a.wa.controller.showMessage("",!0);b.length&&c&&a.post("?module=categories&type=add",{contacts:b,categories:c},function(b){if(b.data&&b.data.count)for(var d in b.data.count)a('#list-category li[rel="category'+d+'"] span.count').html(b.data.count[d]);a.wa.controller.showMessage(b.data.message,
!0)},"json")},dialogAddSelectedToCategory:function(){0>=a.wa.grid.getSelected().length||0>=a("#list-category li:not(.empty):not(.selected):not(.hint)").size()||a('<div id="add-to-category-dialog"></div>').waDialog({url:"?module=categories&action=addSelected"+(this.current_category_id?"&disabled="+this.current_category_id:"")})},dialogRemoveSelectedFromCategory:function(c){c=c||a.wa.grid.getSelected();!(0>=c.length)&&a.wa.controller.current_category_id&&a('<div id="confirm-remove-from-category-dialog" class="small"></div>').waDialog({content:a("<h2></h2>").text($_('Exclude contacts from category "%s"?').replace("%s",
a("h1.wa-page-heading").text())),buttons:a("<div></div>").append(a('<input type="submit" class="button red" value="'+$_("Exclude")+'">').click(function(){a('<i style="margin: 8px 0 0 10px" class="icon16 loading"></i>').insertAfter(this);a.post("?module=categories&action=deleteFrom",{categories:[a.wa.controller.current_category_id],contacts:c},function(b){a.wa.dialogHide();"ok"===b.status&&(a.wa.controller.afterInitHTML=function(){a.wa.controller.showMessage(b.data.message)},a.wa.controller.redispatch())},
"json")})).append(" "+$_("or")+" ").append(a('<a href="javascript:void(0)">'+$_("cancel")+"</a>").click(a.wa.dialogHide))})},dialogRemoveSelectedFromGroup:function(c){c=c||a.wa.grid.getSelected();!(0>=c.length)&&a.wa.controller.current_group_id&&a('<div id="confirm-remove-from-category-dialog" class="small"></div>').waDialog({content:a("<h2></h2>").text($_('Exclude users from group "%s"?').replace("%s",a("h1.wa-page-heading").text())),buttons:a("<div></div>").append(a('<input type="submit" class="button red" value="'+
$_("Exclude")+'">').click(function(){a('<i style="margin: 8px 0 0 10px" class="icon16 loading"></i>').insertAfter(this);a.post("?module=groups&action=deleteFrom",{groups:[a.wa.controller.current_group_id],contacts:c},function(b){a.wa.dialogHide();"ok"===b.status&&(a.wa.controller.updateGroupCounters(b.data.counters||{}),a.wa.controller.afterInitHTML=function(){a.wa.controller.showMessage(b.data.message,null)},a.wa.controller.redispatch())},"json")})).append(" "+$_("or")+" ").append(a('<a href="javascript:void(0)">'+
$_("cancel")+"</a>").click(a.wa.dialogHide))})},contactsDelete:function(c){c=c||a.wa.grid.getSelected();0>=c.length||a.wa.dialogCreate("delete-dialog",{content:"<h2>"+$_("Checking links to other applications...")+' <i class="icon16 loading"></i></h2>',url:"?module=contacts&action=links",small:!0,post:{"id[]":c}})},listTabs:[],addListTab:function(a){this.listTabs.push(a)},addGroup:function(c){a.isEmptyObject(c)||(a.wa.controller.groups[c.id]=c,a("#list-group").replaceWith(this.renderGroups(a.wa.controller.groups)))},
renderGroups:function(c){var b;b='<ul class="menu-v with-icons collapsible" id="list-group">'+('<li class="hint c-shown-on-no-groups" style="padding:0 20px; '+(!a.isEmptyObject(c)?"display: none;":"")+'">'+$_("User groups are for organizing Webasyst users and setting common access rights for groups.")+"</li>");if(!a.isEmptyObject(c)){var e=[],d;for(d in c)c.hasOwnProperty(d)&&e.push(c[d]);e=e.sort(function(b,e){return b.name.toString().localeCompare(e.name.toString())});d=0;for(c=e.length;d<c;d+=
1){var h=e[d];b+='<li rel="group'+h.id+'" class="c-group">';b+='<span class="count">'+h.cnt+"</span>";b+='<a href="#/contacts/group/'+h.id+'/"><img src="../../wa-content/img/users/'+h.icon+'.png"> <b class="name">'+h.name+"</b></a>";b+="</li>"}}return b+"</ul>"},updateGroup:function(c,b){this.groups[c]=b;a("#list-group").find("li[rel=group"+c+"]").html('<span class="count">'+b.cnt+'</span><a href="#/contacts/group/'+b.id+'"><img src="../../wa-content/img/users/'+b.icon+'.png"> <b>'+b.name+"</b></a>")},
checkAdminRights:function(c,b){a.get("?module=contacts&action=user&a=is_admin",function(){c.call(void 0===b?a.wa.controller:b)})},setBlock:function(c,b,e,d){c||(c="default");if(void 0===b||null===b)b=$_("Loading...");var h=this.block;this.block=c;a("#c-core .c-core-header").remove();var d=d||{},e="undefined"===typeof e?[]:e,f="";"contacts-users"===c?(f=a("#c-core .c-core-content"),f="",!1!==d.groups&&(f+=a.wa.controller.renderGroups(d.groups||a.wa.controller.groups)),a("#c-core").html('<div class="shadowed" id="c-users-page"><div class="sidebar left200px" style="min-height: 300px;"><ul class="menu-v with-icons stack" id="c-users-sidebar-menu"><li class="selected" style="margin-left: 17px;"><a class="" href="#/users/all/"><i class="icon16 user"></i>'+
$_("All users")+'</a></li><li style="margin-left: 15px;"><a class="small" href="#/users/add/"><i class="icon10 add"></i>'+$_("New user")+'</a></li><li class="" style="text-transform: uppercase;"><h5 class="heading">'+$_("Groups")+"</h5></li>"+f+'<li class="small" id="c-create-group-toggle" style="margin-left: 14px;"><a href="#/groups/create/"><i class="icon10 add"></i>'+$_("New group")+'</a></li></ul></div><div class="content left200px bordered-left blank"><div class="block not-padded c-core-content"><div class="block" style="overflow:hidden;"><div class="c-actions-wrapper float-right" style="margin: 8px;"></div><h1 class="wa-page-heading">'+
(b||$_("All users"))+' <i class="icon16 loading"></i></h1></div><div class="block not-padded tab-content float-left" style="width: 100%;" id="contacts-container"><div class="block not-padded contacts-data"></div></div></div><div class="clear"></div></div><div class="clear"></div></div>'),f=a("#c-core .c-core-content"),a("#c-create-group-toggle").click(function(){a.wa.controller.last_selected=[]}),a.isArray(e)?a.wa.controller.showMenus(e):f.find(".c-list-toolbar").remove()):(f=a("#c-core").empty().append(a('<div class="contacts-background"><div class="block not-padded c-core-content"></div></div>')).find(".c-core-content"),
f.html('<div class="block"><div class="c-actions-wrapper"></div><h1 class="wa-page-heading">'+b+' <i class="icon16 loading"></i></h1></div>'));a.scrollTo(0);e&&0<=e.indexOf("group-settings")&&this.current_group_id?f.find(".c-actions-wrapper").html('<a href="#/groups/edit/'+this.current_group_id+'/"><i class="icon16 settings"></i></a>'):e&&0<=e.indexOf("category-actions")&&this.current_category_id&&this.global_admin?f.find("div.block").prepend('<ul class="menu-h c-actions"><li><a href="#/categories/edit/'+
this.current_category_id+'/"><i class="icon16 edit"></i>'+$_("Edit category")+'</a></li><li><a href="#/categories/delete/'+this.current_category_id+'/" onclick="return $.wa.controller.categoriesDeleteAction();"><i class="icon16 delete"></i>'+$_("Delete")+"</a></li></ul>"):e&&0<=e.indexOf("search-actions")&&!this.free?f.find("div.block").prepend('<ul class="menu-h c-actions"><li><a href="#" onclick="return $.wa.controller.saveSearchAsFilter()"><i class="icon16 save-as-filter"></i>'+$_("Save as a filter")+
"</a></li></ul>"):e&&(0<=e.indexOf("view-actions")&&this.current_view_id)&&f.find("div.block").prepend('<ul class="menu-h c-actions"><li><a href="#/filters/edit/'+this.current_view_id+'/"><i class="icon16 edit"></i>'+$_("Edit filter")+'</a></li><li><a href="#" onclick="return $.wa.controller.deleteList('+this.current_view_id+', true)"><i class="icon16 delete"></i>'+$_("Delete")+"</a></li></ul>");switch(c){case "contacts-duplicates":case "contacts-list":if(0<this.listTabs.length){d=a('<ul class="tabs" id="c-list-tabs"></ul>');
h=(a("#wa-app .sidebar .selected a").attr("href")||"").replace(/^[^#]*#/g,"");"/"!==h[0]&&(h="/"+h);for(var g=0;g<this.listTabs.length;g++)"function"==typeof this.listTabs[g]&&this.listTabs[g].call(a.wa.controller,d,h);0<d.children().size()&&(d.prepend(a('<li class="selected"></li>').append(a('<a href="#'+h+'">'+$_("Contacts")+"</a>").click(function(){a("#c-list-tabs .selected").removeClass("selected");a(this).parent().addClass("selected");a.wa.controller.showLoading();return true}))),f.append(d))}f.append('<div id="contacts-container" class="tab-content"></div>');
f.next().hasClass("clear-left")||a('<div class="clear-left"></div>').insertAfter(f);this.showMenus((e||[]).concat(["merge","delete"]));f.find("#contacts-container").append('<div class="block not-padded contacts-data"></div>');break;case "contacts-users":case "contacts-info":case "default":break;default:throw this.block=h,Error("Unknown block: "+c);}this.afterInitHTML&&(this.afterInitHTML(),this.afterInitHTML="");a(window).trigger("wa_after_init_html",[c,b,e])},showMenus:function(c){var c='<li><a href="javascript:void(0)" class="inline-link"><b><i>'+
$_("Actions with selected")+' (<span id="selected-count" class="selected-count">0</span>)</i></b><i class="icon10 darr"></i></a><ul class="menu-v" id="actions-with-selected">'+(0<=c.indexOf("group-actions")?'<li><a href="#" onclick="$.wa.controller.addToGroupDialog(); return false"><i class="icon16 contact"></i>'+$_("Add to group")+"</a></li>":"")+'<li id="add-to-category-link"><a href="#" onclick="$.wa.controller.dialogAddSelectedToCategory(); return false"><i class="icon16 contact"></i>'+$_("Add to category")+
"</a></li>"+(0<=c.indexOf("group-actions")&&this.current_group_id?'<li><a href="#" onclick="$.wa.controller.dialogRemoveSelectedFromGroup(); return false"><i class="icon16 contact"></i>'+$_("Exclude from this group")+"</a></li>":"")+(0<=c.indexOf("category-actions")&&this.current_category_id?'<li><a href="#" onclick="$.wa.controller.dialogRemoveSelectedFromCategory(); return false"><i class="icon16 contact"></i>'+$_("Exclude from this category")+"</a></li>":"")+(0<=c.indexOf("merge")&&a.wa.controller.merge&&
a.wa.controller.admin?'<li class="two-or-more disabled"><a href="#" onClick="$.wa.controller.merge(); return false"><i class="icon16 merge"></i>'+$_("Merge contacts")+"</a></li>":"")+(0<=c.indexOf("delete")?'<li><a href="#" onclick="$.wa.controller.contactsDelete(); return false" class="red" id="show-dialog-delete"><i class="icon16 delete"></i>'+$_("Delete")+"</a></li>":"")+"</ul></li>",c='<ul id="list-views" class="menu-h float-right"><li rel="table"><a href="#"><i class="icon16 only view-table" title="'+
$_("List")+'"></i></a></li><li rel="list"><a href="#" title="'+$_("Details")+'"><i class="icon16 only view-thumb-list"></i></a></li><li rel="thumbs"><a href="#" title="'+$_("Userpics")+'"><i class="icon16 only view-thumbs"></i></a></li></ul><div id="c-list-toolbar-menu-wrapper"><input id="c-select-all-items" onclick="$.wa.grid.selectItems(this)" type="checkbox"><ul id="c-list-toolbar-menu" class="menu-h dropdown disabled" style="display:inline-block;">'+c+"</ul></div>",b=a("#contacts-container").find(".c-list-toolbar");
0>=b.size()&&(b=a('<div class="block c-list-toolbar"></div>').prependTo(a("#contacts-container")));b.html(c);a("#contacts-container").off("click.contacts_view","#list-views > li").on("click.contacts_view","#list-views > li",function(){a.wa.grid.setView(a(this).closest("li").attr("rel"));return!1});a.wa.controller.updateSelectedCount()},showLoading:function(){var c=a("h1");0>=c.size()||(c=a(c[0]),0<c.find(".loading").size()||c.append('<i class="icon16 loading"></i>'))},hideLoading:function(){a("h1 .loading").remove()},
updateSelectedCount:function(){var c=a("input.selector:checked").size();a("#selected-count").text(c);a("#selected-count-word-form").text($_(c,"contacts selected"));0>=c?a("#actions-with-selected li").addClass("disabled"):(a("#actions-with-selected li").removeClass("disabled"),0>=a("#list-category li:not(.empty):not(.selected)").size()&&a("#add-to-category-link").addClass("disabled"),2>c&&a("#actions-with-selected li.two-or-more").addClass("disabled"))},getUrl:function(){return this.options.url},loadHTML:function(a,
b,e,d){this.showLoading();this.load(d||"#c-core .c-core-content",a,b,e)},load:function(c,b,e,d,h){a.wa.contactEditor.load.apply(this,Array.prototype.slice.apply(arguments))},parseParams:function(c,b){var e={};c&&c[0]&&(e.offset=c[0]);c&&c[1]&&(e.sort=c[1]);c&&c[2]&&(e.order=c[2]);c&&c[3]?(e.view=c[3],b&&a.storage.set("contacts/view/"+b,e.view)):e.view=a.storage.get("contacts/view/"+b)||"table";c&&c[4]?(e.limit=c[4],b&&a.storage.set("contacts/limit/"+b,e.limit)):e.limit=a.storage.get("contacts/limit/"+
b)||30;return e},setTitle:function(c,b){this.title=c;document.title=this.accountName?c+" \u2014 "+this.accountName:c;b&&a("#c-core h1.wa-page-heading").text("string"===typeof b?b:c)},getTitle:function(){return this.title||""},setLastView:function(c){this.lastView=a.extend(this.lastView,c)},clearLastView:function(){this.lastView={title:null,hash:null,sort:null,order:null,offset:null}},loadGrid:function(c,b,e,d){this.current_category_id=this.current_group_id=this.current_view_id=null;e||(e="?module=contacts&action=list");
d||(d={});a.wa.grid.load(e,c,"#contacts-container .contacts-data",b,d)},showMessage:function(c,b,e){var d=a("#c-core .wa-message");b&&(d.remove(),d=a());c&&(c=a('<div class="wa-message wa-success '+(e||"")+'"><a onclick="$(this).parent().empty().hide();"><i class="icon16 close"></i></a></div>').prepend(a('<span class="wa-message-text"></span>').append(c)),d.size()?a(d[0]).empty().append(c):a("#c-core h1:first").size()?c.insertAfter(a("#c-core h1:first")):a("#c-core").prepend(c))},setHash:function(c){return a.wa.setHash(this.cleanHash(c))},
getHash:function(){return this.cleanHash()},cleanHash:function(a){"undefined"==typeof a&&(a=window.location.hash.toString());for(a.length||(a=""+a);0<a.length&&"/"===a[a.length-1];)a=a.substr(0,a.length-1);a+="/";"#"!=a[0]?("/"!=a[0]&&(a="/"+a),a="#"+a):a[1]&&"/"!=a[1]&&(a="#/"+a.substr(1));return"#/"==a?"":a},collapseSidebarSection:function(c,b){b||(b="coollapse");c=a(c);if(!(0>=c.size())){var e=c.find(".darr, .rarr");0>=e.size()&&(e=a('<i class="icon16 darr">'),c.prepend(e));var d,h=c.attr("id"),
f=e.hasClass("darr")?"shown":"hidden",g=function(){c.parent().find("ul.collapsible").hide();e.removeClass("darr").addClass("rarr");d="hidden";c.trigger("collapsible",["hide"])},j=function(){c.parent().find("ul.collapsible").show();e.removeClass("rarr").addClass("darr");d="shown";c.trigger("collapsible",["show"])};switch(b){case "toggle":"shown"==f?g():j();break;case "restore":h&&("hidden"==a.storage.get("contacts/collapsible/"+h)?g():j());break;case "uncollapse":j();break;default:g()}h&&d&&a.storage.set("contacts/collapsible/"+
h,d)}},restoreCollapsibleStatusInSidebar:function(){a("#wa-app .collapse-handler").each(function(c,b){a.wa.controller.collapseSidebarSection(b,"restore")})},reloadSidebar:function(){a.post("?module=backend&action=sidebar",null,function(c){var b=a("#wa-app .sidebar");b.css("height",b.height()+"px").html(c).css("height","");a.wa.controller.highlightSidebar();a.wa.controller.restoreCollapsibleStatusInSidebar();a.wa.controller.initSidebarDragAndDrop&&a.wa.controller.initSidebarDragAndDrop()})},highlightSidebar:function(){var c=
this.cleanHash(location.hash),b=!1,e=!1;a("#wa-app .sidebar li a").each(function(d,f){var f=a(f),g=a.wa.controller.cleanHash(f.attr("href"));if(g==c)return e=f,!1;!b&&(2<g.length&&c.substr(0,g.length)===g)&&(b=f)});!e&&b&&(e=b);if(e&&(a("#wa-app .sidebar .selected").removeClass("selected"),0>=e.parents("ul.dropdown").size())){for(var d=e.parent();0<d.size()&&"li"!=d[0].tagName.toLowerCase();)d=d.parent();0<d.size()&&d.addClass("selected")}},loadTabSlidingAnimation:function(){a.effects&&!a.effects.slideDIB&&
(a.effects.slideDIB=function(c){return this.queue(function(){var b=a(this),e="position top left width height margin".split(" "),d=a.effects.setMode(b,c.options.mode||"show"),h=c.options.direction||"left";a.effects.save(b,e);b.show();a.effects.createWrapper(b).css({overflow:"hidden",display:"inline-block",width:"auto"});var f="up"==h||"down"==h?"top":"left",h="up"==h||"left"==h?"pos":"neg",g=c.options.distance||("top"==f?b.outerHeight({margin:!0}):b.outerWidth({margin:!0}));"show"==d&&b.css(f,"pos"==
h?-g:g);var j={};j[f]=("show"==d?"pos"==h?"+=":"-=":"pos"==h?"-=":"+=")+g;b.animate(j,{queue:!1,duration:c.duration,easing:c.options.easing,complete:function(){"hide"==d&&b.hide();a.effects.restore(b,e);a.effects.removeWrapper(b);c.callback&&c.callback.apply(this,arguments);b.dequeue()}})})})}}})(jQuery);(function(a){a.wa.grid={count:0,data:{},highlight_terms:[],init:function(){this.defaultSettings={limit:30,offset:0,sort:"name",order:1,view:"table"};this.settings=a.extend({},this.defaultSettings);var c=this;a("#records-per-page").die(a.browser.msie?"click":"change");a("#records-per-page").live(a.browser.msie?"click":"change",function(){var b=a(this).val(),e=0;c.settings&&c.settings.offset&&(e=c.settings.offset);a.wa.setHash(a.wa.grid.hash+a.wa.grid.getHash({limit:b,offset:e}))})},formatFieldValue:function(c,
b){return"_access"===b.id?"admin"==c?"<strong>"+$_("Administrator")+"</strong>":c?"custom"==c?'<span style="white-space: nowrap">'+$_("Limited access")+"</span>":c:'<span style="color: red; white-space: nowrap">'+$_("No access")+"</span>":c?a.wa.encodeHTML(c):""},setHightlightTerms:function(c){var b=[];if(a.isArray(c)&&c.length)for(var e=0,d=c.length;e<d;e+=1)b.push(c[e]||"");else"string"===typeof c&&b.push(c||"");return this.highlight_terms=c},highlight:function(c){var b=this.highlight_terms;if(c&&
!a.isEmptyObject(b)){var e=a.parseXML?a.parseXML:a.parseHTML,d=function(a){for(var e=0,d=b.length;e<d;e+=1)b[e]&&(a=(""+a).replace(RegExp("("+b[e].replace(/[\-\[\]\/\{\}\(\)\*\+\?\.\\\^\$\|]/g,"\\$&")+")","ig"),'<span class="highlighted">$1</span>'));return a};try{var h="wrapper"+(""+Math.random()).slice(2),f=e.call(a,'<div id="'+h+'">'+c+"</div>"),g=function(b){return b.contents().map(function(b,e){if(3==e.nodeType)return d(a.wa.encodeHTML(a(e).text()));if(a(e).contents().length){var c=a("<div>");
g(a(e)).each(function(b,a){c.append(a)});return c.find(":first").get(0)}return e})},j=a("<div>");g(a(f).find("#"+h)).each(function(b,a){j.append(a)});return j.html()}catch(i){return console&&console.log([c,i]),d(c)}}return c},formNamesHtml:function(c){var b=this.highlight(a.wa.encodeHTML(c.name)),e=this.highlight(a.wa.encodeHTML(c.lastname)),d=this.highlight(a.wa.encodeHTML(c.middlename)),h=this.highlight(a.wa.encodeHTML(c.firstname)),f=!1,g=[h,d,e].join(" ").trim();c.lastname?(e="<strong>"+e+"</strong>",
f=!0):c.firstname?(h="<strong>"+h+"</strong>",f=!0):c.middlename&&(d="<strong>"+d+"</strong>",f=!0);d=[h,d,e].join(" ").trim();e=[];if(parseInt(c.is_company,10))return g="",g=f?g+(c.company?this.highlight(a.wa.encodeHTML(c.company)):b):g+((c.company?"<strong>"+this.highlight(a.wa.encodeHTML(c.company)):b)+"</strong>"),[g];c.title&&e.push("<span class='title'>"+this.highlight(a.wa.encodeHTML(c.title))+"</span>");g?e.push(d):b?e.push(b):e.push(a("<span></span>").text($_("<no-name>")).html());e=e.join(" ").trim();
g="";if(c.jobtitle||c.company)c.jobtitle&&(g+='<span class="title">'+this.highlight(a.wa.encodeHTML(c.jobtitle))+"</span>"),c.jobtitle&&c.company&&(g+=' <span class="at">'+$_("@")+"</span> "),c.company&&(g=f?g+('<span class="company">'+this.highlight(a.wa.encodeHTML(c.company))+"</span>"):g+('<span class="company"><strong>'+this.highlight(a.wa.encodeHTML(c.company))+"</strong></span>"));return[e,g]},viewtable:function(a,b){var e=tmpl("template-contacts-list-table",a);this.count=a.count;b||(e+=this.getPaging(a.count));
return e},viewlist:function(a){var b=tmpl("template-contacts-list-list",a);this.count=a.count;return b+=this.getPaging(a.count)},viewthumbs:function(a){var b=tmpl("template-contacts-list-thumbs",a);this.count=a.count;return b+=this.getPaging(a.count)},load:function(c,b,e,d,h){this.url=c;this.options=h;this.hash=d;this.settings=a.extend({},this.defaultSettings);for(var f in b)null!==b[f]&&(this.settings[f]=b[f]);var g=this,j=Math.random();a.wa.controller.random=j;a.post(c,this.settings,function(b){if(a.wa.controller.random!=
j||"ok"!=b.status)return!1;b.data.contacts&&(a.wa.grid.data=b.data);if(b.data.count&&b.data.contacts&&!b.data.contacts.length)return b=Math.floor((b.data.count-1)/g.settings.limit)*g.settings.limit,b!=g.settings.offset&&a.wa.setHash(a.wa.grid.hash+a.wa.grid.getHash({offset:b})),!1;var d=null;g.options&&g.options.beforeLoad&&(d=g.options.beforeLoad.call(a.wa.controller,b.data));b.data.title&&a.wa.controller.setTitle(b.data.title,!0);b.data.desc&&a.wa.controller.setDesc(b.data.desc);b.data.history&&
a.wa.history.updateHistory(b.data.history);e=a(e);!1!==d&&e.html(g.view(g.settings.view,b.data));g.options&&g.options.afterLoad&&g.options.afterLoad(b.data);a.wa.controller.clearLastView()},"json")},getSelected:function(c){var b=[];a("input.selector:checked").each(function(){if(c){var a=parseInt(this.value,10);isNaN(a)||b.push(a)}else b.push(this.value)});return b},setView:function(c){a.wa.setHash(this.hash+this.getHash({view:c}));return!1},selectItems:function(c,b){b=a("#"+(b||"contacts-container"));
a(c).is(":checked")?b.find("input.selector").attr("checked","checked").parents(".contact-row,.item-row").addClass("selected"):b.find("input.selector").removeAttr("checked").parents(".contact-row,.item-row").removeClass("selected");a.wa.controller.updateSelectedCount()},viewlistvalue:function(c,b){if("object"!==typeof c){if("Select"===b.type){var e=b.options||{};void 0!==e[c]&&(c=e[c])}return a.wa.encodeHTML(c)}e="";b.icon&&(e+='<i class="icon16 '+b.icon+'"></i>');var d=!0,h;for(h in c)if("ext"!=h&&
"value"!=h){d=!1;break}c.value&&(e+=d?a.wa.encodeHTML(c.value):c.value);a.trim(c.ext)&&!b.fields&&(e=b.ext&&b.ext[c.ext]?e+(' <em class="hint">'+b.ext[c.ext]+"</em>"):e+(' <em class="hint">'+a.wa.encodeHTML(c.ext)+"</em>"));return e},view:function(c,b,e){this["view"+c]||(c="table");a("#list-views li.selected").removeClass("selected");a("#list-views li[rel="+c+"]").addClass("selected");a("#contacts-container .contacts-data").removeClass("padded").addClass("not-padded");var d=b.highlight_terms||(b.info&&
b.info.highlight_terms?b.info.highlight_terms:[])||[];"string"===typeof d&&(d=[d]);a.wa.grid.setHightlightTerms(d);return this["view"+c](b,e)},getHash:function(a){var b={},e;for(e in this.settings)b[e]=this.settings[e];for(e in a)b[e]=a[e];return b.offset+"/"+b.sort+"/"+b.order+"/"+b.view+"/"+b.limit+"/"},getPaging:function(c,b,e){var b="undefined"===typeof b?!0:b,d='<div class="block paging">',h=a.wa.controller.options.paginator_type;if("undefined"===typeof e||e){for(var f="",g=[30,50,100,200,500],
e=0;e<g.length;e++)f+='<option value="'+g[e]+'"'+(this.settings.limit==g[e]?' selected="selected"':"")+">"+g[e]+"</option>";c>g[0]&&(d+='<span class="c-page-num">'+$_("Show %s records on a page").replace("%s",'<select id="records-per-page">'+f+"</select>")+"</span>")}b&&"page"===h&&(d+='<span class="total">'+$_("Contacts")+": "+c+"</span>");b=Math.ceil(c/parseInt(this.settings.limit));f=Math.ceil(parseInt(this.settings.offset)/parseInt(this.settings.limit))+1;if(1<b){"/"!=this.hash[this.hash.length-
1]&&(this.hash+="/");"page"===h&&(d+="<span>"+$_("Pages")+":</span>");if(1==b)return"";if("page"===h){c=0;for(e=1;e<=b;e++)2>Math.abs(f-e)||2>e||1>b-e?(d+="<a "+(e==f?'class="selected"':"")+' href="#'+this.hash+this.getHash({offset:(e-1)*this.settings.limit})+'">'+e+"</a>",c=0):3>c++&&(d+=".")}else d+=parseInt(this.settings.offset,10)+1+"&mdash;"+Math.min(c,parseInt(this.settings.offset,10)+parseInt(this.settings.limit,10)),d+=" "+$_("of")+" "+c}else"page"!==h&&(0>=b?d+=$_("No contacts."):(d+=Math.min(parseInt(this.settings.offset,
10)+1,c)+"&mdash;"+Math.min(c,parseInt(this.settings.offset,10)+parseInt(this.settings.limit,10)),d+=" "+$_("of")+" "+c));1<f&&(d+='<a href="#'+this.hash+this.getHash({offset:(f-2)*this.settings.limit})+'" class="prevnext"><i class="icon10 larr"></i> '+$_("prev")+"</a>");f<b&&(d+='<a href="#'+this.hash+this.getHash({offset:f*this.settings.limit})+'" class="prevnext">'+$_("next")+' <i class="icon10 rarr"></i></a>');return d+"</div>"}}})(jQuery);$.wa.history={data:null,updateHistory:function(a){this.data=a;var c=$("#wa-search-history").empty(),b=$("#wa-creation-history").empty();$.wa.controller.cleanHash(location.hash);for(var e=0;e<a.length;e++){var d=a[e];d.hash=$.wa.controller.cleanHash(d.hash);var h=$('<li rel="'+d.id+'">'+(0<=d.cnt?'<span class="count">'+d.cnt+"</span>":"")+'<a href="'+d.hash+'"><i class="icon16 '+d.type+'"></i></a></li>');("search"==d.type||"import"==d.type)&&h.addClass("wa-h-type-search");h.children("a").append($("<b>").text(d.name));
"import"==d.type?b.append(h):"add"==d.type?(h.find(".icon16").removeClass(d.type).addClass("userpic20").css("background-image","url("+d.icon+")"),b.append(h)):"search"==d.type&&c.append(h)}a=[c,b];for(c=0;c<a.length;c++)b=a[c],0<b.children().size()?b.parents(".block.wrapper").show():b.parents(".block.wrapper").hide();$.wa.controller.highlightSidebar()},clear:function(a){!a||"search"==a?($("#wa-search-history").parents(".block.wrapper").hide(),$("#wa-search-history").empty(),a="&ctype="+a):a&&"creation"==
a?($("#wa-creation-history").parents(".block.wrapper").hide(),$("#wa-creation-history").empty(),a="&ctype[]=import&ctype[]=add"):a="";$.get("?module=contacts&action=history&clear=1"+a);return!1}};$.wa.fieldTypesFactory=function(a,c){a=a||$.wa.contactEditorFactory();a.baseFieldType={contactType:"person",options:{},createEditor:function(b){this.contactType=b||"person";b=$.extend({},this);delete b.createEditor;delete b.initializeFactory;b.parentEditorData={};b.initialize();return b},fieldValue:"",initializeFactory:function(b,a){this.fieldData=b;this.options=a||{}},initialize:function(){this.setValue("")},reinit:function(){this.currentMode="null";this.initialize()},setValue:function(b){this.fieldValue=
b;"null"==this.currentMode||null===this.domElement||("edit"==this.currentMode?this.domElement.find(".val").val(this.fieldValue):this.domElement.find(".val").html(this.fieldValue))},getValue:function(){var b=this.fieldValue;if("edit"==this.currentMode&&null!==this.domElement){var a=this.domElement.find(".val");if(0<a.length&&(b="",!a.hasClass("empty")&&("checkbox"!=a.attr("type")||a.attr("checked"))))b=a.val()}return b},isModified:function(){return this.fieldValue!=this.getValue()},validate:function(b){var a=
this.getValue();return!b&&this.fieldData.required&&!a?$_("This field is required."):null},newFieldElement:function(b){this.fieldData.read_only&&(b="view");var e=this.newInlineFieldElement(b);if(null===e&&(!this.fieldData.show_empty||"edit"==b))return $('<div style="display: none" class="field" data-field-id="'+this.fieldData.id+'"></div>');var d;"person"===this.contactType?0<=["firstname","middlename","lastname"].indexOf(this.fieldData.id)?(d="subname",e.find(".val").attr("placeholder",this.fieldData.name)):
"title"===this.fieldData.id?(d="subname title",e.find(".val").attr("placeholder",this.fieldData.name)):"jobtitle"===this.fieldData.id?d="jobtitle-company jobtitle":"company"===this.fieldData.id&&(d="jobtitle-company company"):"company"===this.fieldData.id&&(d="company");return a.wrapper(e,this.fieldData.name+"",d).attr("data-field-id",this.fieldData.id)},newInlineFieldElement:function(b){if("view"==b&&!this.fieldValue)return null;var a=null;"edit"==b?(a=$('<span><input class="val" type="text"></span>'),
a.find(".val").val(this.fieldValue)):(a=$('<span class="val"></span>'),a.text(this.fieldValue));return a},showValidationErrors:function(b){if(null!==this.domElement){var a=this.domElement.find(".val");a.parents(".value").children("em.errormsg").remove();null!==b?(a.parents(".value").append($('<em class="errormsg">'+b+"</em>")),a.addClass("error")):a.removeClass("error")}},fieldData:null,domElement:null,currentMode:"null",parentEditor:null,parentEditorData:null,setMode:function(b,a){"undefined"==typeof a&&
(a=!0);if("view"!=b&&"edit"!=b)throw Error("Unknown mode: "+b);if(this.currentMode!=b&&(this.currentMode=b,a)){var d=this.domElement;this.domElement=this.newFieldElement(b);null!==d&&d.replaceWith(this.domElement)}return this.domElement}};a.factoryTypes.Hidden=$.extend({},a.baseFieldType,{newFieldElement:function(b){b=this.newInlineFieldElement(b);return a.wrapper(b,this.fieldData.name).attr("data-field-id",this.fieldData.id).hide()},newInlineFieldElement:function(b){if("view"==b&&!this.fieldValue)return null;
var a=null;"edit"==b&&(a=$('<span><input type="hidden" class="val" type="text"></span>'),a.find(".val").val(this.fieldValue));return a}});a.factoryTypes.String=$.extend({},a.baseFieldType,{setValue:function(b){this.fieldValue=b;"null"==this.currentMode||null===this.domElement||("edit"==this.currentMode?this.domElement.find(".val").val(this.fieldValue):this.domElement.find(".val").html(this.fieldValue))},getValue:function(){var b=this.fieldValue;if("edit"==this.currentMode&&null!==this.domElement){var a=
this.domElement.find(".val"),b="";a.hasClass("empty")||(b=a.val())}return b},newInlineFieldElement:function(b){if("view"==b&&!this.fieldValue)return null;var a=null,d=this.fieldValue;"edit"==b?(a=1>=this.fieldData.input_height?$('<span><input class="val" type="text"><i class="icon16 loading" style="display:none;"></i></span>'):$('<span><textarea class="val" rows="'+this.fieldData.input_height+'"></textarea></span>'),a.find(".val").val(d)):a=$('<span class="val"></span><i class="icon16 loading" style="display:none;">').text(d);
return a},setMode:function(b,a){"undefined"==typeof a&&(a=!0);if("view"!=b&&"edit"!=b)throw Error("Unknown mode: "+b);if(this.currentMode!=b&&(this.currentMode=b,a)){var d=this.domElement;this.domElement=this.newFieldElement(b);null!==d&&d.replaceWith(this.domElement)}return this.domElement}});a.factoryTypes.Text=$.extend({},a.factoryTypes.String);a.factoryTypes.Phone=$.extend({},a.baseFieldType);a.factoryTypes.Select=$.extend({},a.baseFieldType,{notSet:function(){return""},newInlineFieldElement:function(b){if("view"==
b&&!this.fieldValue)return null;if("view"==b)return $('<span class="val"></span>').text(this.fieldData.options[this.fieldValue]||this.fieldValue);for(var b="",a=!1,d,c=0;c<this.fieldData.oOrder.length;c++){var f=this.fieldData.oOrder[c];!a&&f==this.fieldValue&&this.fieldValue?(a=!0,d=" selected"):d="";""===f&&(d+=" disabled");b+='<option value="'+f+'"'+d+">"+$.wa.encodeHTML(this.fieldData.options[f])+"</option>"}return $('<div><select class="val '+(this.fieldData.type+"").toLowerCase()+'"><option value=""'+
(a?"":" selected")+">"+this.notSet()+"</option>"+b+"</select></div>")}});a.factoryTypes.Conditional=$.extend({},a.factoryTypes.Select,{unbindEventHandlers:function(){},getValue:function(){var b=this.fieldValue;if("edit"==this.currentMode&&null!==this.domElement){var a=this.domElement.find(".val:visible");0<a.length&&(b=a.hasClass("empty")?"":a.val())}return b},newInlineFieldElement:function(b){if("view"==b&&!this.fieldValue)return null;this.unbindEventHandlers();if("view"==b)return $("<div></div>").append($('<span class="val"></span>').text(this.fieldData.options&&
this.fieldData.options[this.fieldValue]||this.fieldValue));for(var e=this,b=(e.fieldData.parent_field||"").split(":"),d=a.fieldEditors[b.shift()];d&&b.length;){var c=d.subfieldEditors;if(c instanceof Array)for(var d=null,f=0;f<c.length;f++){if(c[f]===e.parentEditor){d=c[f];break}}else d=c[b.shift()]}if(d){var g=this.fieldData.options&&this.fieldData.options[this.fieldValue]||this.fieldValue,j=$('<input type="text" class="hidden val">').val(g),i=$('<select class="hidden val"></select>').hide(),k;setTimeout(function(){d.domElement?
(d.domElement.on("change",".val",k=function(){var b=$(this),a=j.is(":visible")?j.val():i.is(":visible")?i.val():g,b=(b.val()||"").toLowerCase();if(b=e.fieldData.parent_options[b]){j.hide();i.show().children().remove();for(f=0;f<b.length;f++)i.append($("<option></option>").attr("value",b[f]).text(b[f]).attr("selected",e.fieldValue==b[f]));i.val(a)}else j.val(a||"").show().blur(),i.hide()}),k.call(d.domElement.find(".val:visible")[0])):j.show()},0);e.unbindEventHandlers=function(){k&&d.domElement&&
d.domElement.find(".val").unbind("change",k);e.unbindEventHandlers=function(){}};return $("<div></div>").append(j).append(i)}return $("<div></div>").append($('<input type="text" class="val">').val(e.fieldValue))}});a.factoryTypes.Region=$.extend({},a.factoryTypes.Select,{notSet:function(){return""},unbindEventHandlers:function(){},setCurrentCountry:function(){var b=this.current_country;this.current_country=this.parentEditorData.parent.subfieldEditors.country.getValue();return b!==this.current_country?
(delete this.fieldData.options,!0):!1},getRegionsControllerUrl:function(b){return(a.regionsUrl||"?module=backend&action=regions&country=")+b},newInlineFieldElement:function(b){if("view"==b&&!this.fieldValue)return null;this.unbindEventHandlers();var e=this.options||{};void 0!==e.country&&(this.current_country=e.country);if("view"==b)return $("<div></div>").append($('<span class="val"></span>').text(this.fieldData.options&&this.fieldData.options[this.fieldValue]||this.fieldValue));var d=this;if(this.parentEditorData.parent&&
this.parentEditorData.parent.subfieldEditors.country){this.setCurrentCountry();var c;$(document).on("change","select.country",c=function(){if(d.setCurrentCountry()){var a="",e=d.domElement.find(".val"),a=e.is("input")?e.val().trim():e.find(":selected").text().trim(),c=function(b,a){var e=a.toLocaleLowerCase();b.find("option").each(function(){if($(this).text().trim().toLocaleLowerCase()===e){$(this).attr("selected",true);return false}})};d.domElement.empty().append(d.newInlineFieldElement(b).children());
e=d.domElement.find(".val");e.is("input")&&!e.val()?e.val(a):e.is("select")&&a?c(e,a):d.domElement.unbind("load.fieldTypes").bind("load.fieldTypes",function(){var b=d.domElement.find(".val");b.is("select")&&a&&c(b,a)})}});d.unbindEventHandlers=function(){$(document).off("change","select.country",c);d.unbindEventHandlers=function(){}}}if(!e.no_ajax_select&&void 0===this.fieldData.options&&this.current_country&&this.fieldData.region_countries[this.current_country]){var f=this.current_country;$.get(this.getRegionsControllerUrl(f),
function(a){if(!(b!==d.currentMode||f!==d.current_country)){d.fieldData.options=a.data.options||false;d.fieldData.oOrder=a.data.oOrder||[];$.isPlainObject(d.options)&&d.options.country!==void 0&&delete d.options.country;$("<div></div>").append(d.newInlineFieldElement(b).children());d.domElement.empty().append(d.newInlineFieldElement(b).children());d.domElement.trigger("load")}},"json");return $("<div></div>").append($('<i class="icon16 loading"></i>'))}if(this.fieldData.options)return $("<div></div>").append(a.factoryTypes.Select.newInlineFieldElement.call(this,
b));e=$("<div></div>").append(a.baseFieldType.newInlineFieldElement.call(this,b));e.find(".val").val("");e.find(".val").attr("placeholder",this.fieldData.name+(this.fieldData.required?" ("+$_("required")+")":""));return e}});a.factoryTypes.Country=$.extend({},a.factoryTypes.Select);a.factoryTypes.Checklist=$.extend({},a.baseFieldType,{validate:function(){return null},setValue:function(b){this.fieldValue=b;if("edit"==this.currentMode&&this.domElement){this.domElement.find('input[type="checkbox"]').attr("checked",
!1);for(var a in this.fieldValue)this.domElement.find('input[type="checkbox"][value="'+a+'"]').attr("checked",!0)}else"view"==this.currentMode&&this.domElement&&this.domElement.find(".val").html(this.getValueView())},getValue:function(){if("edit"!=this.currentMode||!this.domElement)return this.fieldValue;var b=[];this.domElement.find('input[type="checkbox"]:checked').each(function(a,d){b.push($(d).val())});return b},getValueView:function(){for(var b="",e=0;e<this.fieldData.oOrder.length;e++){var d=
this.fieldData.oOrder[e];0>this.fieldValue.indexOf(d)||(b+=(b?", ":"")+'<a href="'+(this.fieldData.hrefPrefix||"#")+d+'">'+(this.fieldData.options[d]&&a.htmlentities(this.fieldData.options[d])||$_("&lt;no name&gt;"))+"</a>")}return b||$_("&lt;none&gt;")},newInlineFieldElement:function(b){if("view"==b&&(!this.fieldValue||!this.fieldValue.length))return null;if("view"==b)return $('<span class="val"></span>').html(this.getValueView());var b=0,e;for(e in this.fieldData.options)if(b++,1<b)break;if(!b)return null;
for(var b="",d=0;d<this.fieldData.oOrder.length;d++){e=this.fieldData.oOrder[d];b+='<li><label><input type="checkbox" value="'+e+'"';this.fieldData.disabled&&this.fieldData.disabled[e]&&(b+=' disabled="disabled"');if(-1!==(this.fieldValue||[]).indexOf(e))b+=' checked="checked"';b+=" />"+(this.fieldData.options[e]&&a.htmlentities(this.fieldData.options[e])||$_("&lt;no name&gt;"))+"</label></li>"}return a.initCheckboxList('<div class="c-checkbox-menu-container val"><div><ul class="menu-v compact with-icons c-checkbox-menu">'+
b+"</ul></div></div>")}});a.factoryTypes.Name=$.extend({},a.baseFieldType,{newInlineFieldElement:null,newFieldElement:function(){return $('<div style="display: none;" class="field" data-field-id="'+this.fieldData.id+'"></div>')},setValue:function(b){this.fieldValue=b},getValue:function(b){if(this.fieldValue&&!b)return this.fieldValue;b=[];"person"==this.contactType?(a.fieldEditors.firstname&&b.push(a.fieldEditors.firstname.getValue()),a.fieldEditors.middlename&&b.push(a.fieldEditors.middlename.getValue()),
a.fieldEditors.lastname&&b.push(a.fieldEditors.lastname.getValue())):a.fieldEditors.company&&b.push(a.fieldEditors.company.getValue());return b.join(" ").trim()},validate:function(b){var e=this.getValue(!0);if(!b&&this.fieldData.required&&!e){b=$("#contact-info-block input:visible:text[value]:not(.empty)").val();if(!b)return $_("At least one of these fields must be filled");a.fieldEditors.firstname.setValue(b)}return null},showValidationErrors:function(b){var e=$("#contact-info-block");e.find("div.wa-errors-block").remove();
if(null!==b){var d=$('<div class="field wa-errors-block"><div class="value"><em class="errormsg">'+b+"</em></div></div>");a.fieldEditors.lastname?a.fieldEditors.lastname.domElement.after(d):e.prepend(d)}e=["firstname","middlename","lastname"];for(d=0;d<e.length;d++){var c=e[d];a.fieldEditors[c]&&(null!==b?a.fieldEditors[c].domElement.find(".val").addClass("external-error"):a.fieldEditors[c].domElement.find(".val").removeClass("external-error"))}},setMode:function(b,e){"undefined"==typeof e&&(e=!0);
if("view"!=b&&"edit"!=b)throw Error("Unknown mode: "+b);if(this.currentMode!=b&&(this.currentMode=b,e)){var d=this.domElement;this.domElement=this.newFieldElement(b);null!==d&&d.replaceWith(this.domElement)}var c="";a.fieldEditors.title&&(c=a.fieldEditors.title.getValue()+" ");if("view"===b&&!a.not_update_name){var d=$("#contact-fullname"),f="",g="",j="";if(a.fieldEditors.firstname){var i=a.fieldEditors.firstname.currentMode;a.fieldEditors.firstname.currentMode=b;f=a.fieldEditors.firstname.getValue();
a.fieldEditors.firstname.currentMode=i}a.fieldEditors.middlename&&(i=a.fieldEditors.middlename.currentMode,a.fieldEditors.middlename.currentMode=b,g=a.fieldEditors.middlename.getValue(),a.fieldEditors.middlename.currentMode=i);a.fieldEditors.lastname&&(i=a.fieldEditors.lastname.currentMode,a.fieldEditors.lastname.currentMode=b,j=a.fieldEditors.lastname.getValue(),a.fieldEditors.lastname.currentMode=i);(i=[f,g,j].join(" ").trim())||(i=this.fieldValue||"<"+$_("no name")+">");c=d.find("h1.name").html('<span class="title">'+
$.wa.encodeHTML(c)+"</span>"+$.wa.encodeHTML(i));"person"===this.contactType&&(j=g=f="",a.fieldEditors.jobtitle&&(i=a.fieldEditors.jobtitle.currentMode,a.fieldEditors.jobtitle.currentMode=b,g=a.fieldEditors.jobtitle.getValue(),a.fieldEditors.jobtitle.currentMode=i),a.fieldEditors.company&&(i=a.fieldEditors.company.currentMode,a.fieldEditors.company.currentMode=b,j=a.fieldEditors.company.getValue(),a.fieldEditors.company.currentMode=i),g&&(f+='<span class="title">'+$.wa.encodeHTML(g)+"</span> "),g&&
j&&(f+='<span class="at">'+$_("@")+"</span> "),j&&(f+='<span class="company">'+$.wa.encodeHTML(j)+"</span> "),d.find("h1.jobtitle-company").html(f));a.update_title&&$.wa.controller.setTitle(c.text())}a.contact_id&&a.contact_id==a.current_user_id&&$("#wa-my-username").text(""+(this.fieldValue?this.fieldValue:"<"+$_("no name")+">"));return this.domElement}});a.factoryTypes.NameSubfield=$.extend({},a.baseFieldType,{});a.factoryTypes.Multifield=$.extend({},a.baseFieldType,{subfieldEditors:null,subfieldFactory:null,
emptySubValue:null,initializeFactory:function(b){this.fieldData=b;if("undefined"!=typeof this.fieldData.ext){this.fieldData.extKeys=[];this.fieldData.extValues=[];for(var a in this.fieldData.ext)this.fieldData.extKeys[this.fieldData.extKeys.length]=a,this.fieldData.extValues[this.fieldData.extValues.length]=this.fieldData.ext[a]}},initialize:function(){this.subfieldFactory=$.extend({},a.factoryTypes[this.fieldData.type]);this.subfieldFactory.parentEditor=this;this.subfieldFactory.initializeFactory($.extend({},
this.fieldData));this.fieldData=$.extend({},this.fieldData,{required:this.subfieldFactory.fieldData.required});this.subfieldEditors=[this.subfieldFactory.createEditor(this.contactType)];this.emptySubValue="object"==typeof this.subfieldEditors[0].fieldValue?$.extend({},this.subfieldEditors[0].fieldValue):{value:this.subfieldEditors[0].fieldValue};this.fieldData.ext&&(this.emptySubValue.ext=this.fieldData.extKeys[0]);this.fieldValue=[this.emptySubValue]},setValue:function(b){if(!b||"undefined"==typeof b[0])b=
[this.emptySubValue];this.fieldValue=b;var a=0;do{this.subfieldEditors.length<=a&&(this.subfieldEditors[a]=this.subfieldFactory.createEditor(this.contactType),"null"!=this.currentMode&&this.subfieldEditors[a].setMode(this.currentMode).insertAfter(this.subfieldEditors[a-1].parentEditorData.domElement));if("undefined"!=typeof b[a]){var d=!1,c;for(c in b[a])if("value"!=c&&"ext"!=c){d=!0;break}this.subfieldEditors[a].setValue(d?b[a]:b[a].value?b[a].value:"");if("undefined"!=typeof this.fieldData.ext&&
(d=b[a].ext,"null"!=this.currentMode&&this.subfieldEditors[a].parentEditorData.domElement)){var f=this.subfieldEditors[a].parentEditorData.domElement.find("input.ext");0<f.size()&&f[0].setExtValue(d)}}else throw Error("At least one record must exist in data at this time.");a++}while(a<b.length);if(b.length<this.subfieldEditors.length){for(a=b.length;a<this.subfieldEditors.length;a++)0!==a&&"null"!=this.currentMode&&this.subfieldEditors[a].parentEditorData.domElement.remove();b=0<b.length?b.length:
1;this.subfieldEditors.splice(b,this.subfieldEditors.length-b)}this.origFieldValue=null},getValue:function(){if("null"==this.currentMode)return $.extend({},this.fieldValue);for(var b=[],a=0;a<this.subfieldEditors.length;a++){var d=this.subfieldEditors[a];b[a]={value:d.getValue()};if("undefined"!=typeof this.fieldData.ext){var c=this.fieldValue[a].ext,f=d.parentEditorData.domElement.find("input.ext")[0];"edit"==d.currentMode&&f&&(c=f.getExtValue());b[a].ext=c}}return b},isModified:function(){for(var b=
0;b<this.subfieldEditors.length;b++)if(this.subfieldEditors[b].isModified())return!0;return!1},validate:function(b){for(var a=[],d=!0,c=0;c<this.subfieldEditors.length;c++){var f=this.subfieldEditors[c],g=f.validate(!0);g&&(a[c]=g);if((f=f.getValue())||"string"!=typeof f)d=!1}!b&&(this.fieldData.required&&d)&&(a[0]="This field is required.");return 0>=a.length?null:a},showValidationErrors:function(b){for(var a=0;a<this.subfieldEditors.length;a++){var d=this.subfieldEditors[a];null!==b&&"undefined"!=
typeof b[a]?d.showValidationErrors(b[a]):d.showValidationErrors(null)}},deleteSubfieldButton:function(b){var a=this,d=$('<a class="delete-subfield hint" href="javascript:void(0)">'+$_("delete")+"</a>").click(function(){if(1>=a.subfieldEditors.length)return!1;var d=a.subfieldEditors.indexOf(b);"null"!=a.currentMode&&a.subfieldEditors[d].parentEditorData.domElement.remove();a.subfieldEditors.splice(d,1);1>=a.subfieldEditors.length&&a.domElement.find(".delete-subfield").hide();return!1});1>=this.subfieldEditors.length&&
d.hide();return d},newSubFieldElement:function(b,e){var e=e-0,d=this.subfieldEditors[e];d.parentEditorData||(d.parentEditorData={});d.parentEditorData.parent=this;d.parentEditorData.empty=!1;var c;if("function"!=typeof d.newInlineFieldElement){var f=a.wrapper('<span class="replace-me-with-value"></span>',0===e?this.fieldData.name+"":"","no-bot-margins"),g=f.find("span.replace-me-with-value");c=this.fieldValue[e].ext;"edit"==b?c=a.createExtSelect(this.fieldData.ext,c):(c=this.fieldData.ext[this.fieldValue[e].ext]||
c,c=$("<strong>"+a.htmlentities(c)+"</strong>"));g.before(c);"edit"==b&&g.before(this.deleteSubfieldButton(d));g.remove();d.domElement=this.subfieldEditors[e].newFieldElement(b);var j=this;d.domElement.find("div.name").each(function(b,a){if(a.innerHTML.substr(0,j.fieldData.name.length)===j.fieldData.name)a.innerHTML=""});d.parentEditorData.domElement=$("<div></div>").append(f).append(d.domElement);d.parentEditorData.empty="edit"==b?!1:!d.fieldValue.value&&!d.fieldData.show_empty;return d.parentEditorData.domElement}c=
d.newInlineFieldElement(b);if(null===c)return d.parentEditorData.domElement=d.domElement=$("<div></div>"),d.parentEditorData.empty=!0,d.parentEditorData.domElement;d.domElement=c;d.domElement.data("subfield-index",e).attr("data-subfield-index",e);f=$('<div class="value"></div>').append(c);g=f.find(".replace-with-ext");0>=g.size()&&(f.append('<span><span class="replace-with-ext"></span></span>'),g=f.find(".replace-with-ext"));"undefined"!=typeof this.fieldData.ext&&(c=this.fieldValue[e].ext,"edit"==
b?g.before(a.createExtSelect(this.fieldData.ext,c)):(c=this.fieldData.ext[this.fieldValue[e].ext]||c,0<g.parents(".ext").size()?g.before(a.htmlentities(c)):g.before($('<em class="hint"></em>').text(" "+c))));"edit"==b&&g.before(this.deleteSubfieldButton(d));g.remove();return d.parentEditorData.domElement=f},newInlineFieldElement:null,newFieldElement:function(b){this.fieldData.read_only&&(b="view");for(var e=$('<div class="multifield-subfields"></div>'),d="function"==typeof this.subfieldFactory.newInlineFieldElement,
c=!0,f=0;f<this.subfieldEditors.length;f++){var g=this.newSubFieldElement(b,f);e.append(g);c=c&&this.subfieldEditors[f].parentEditorData.empty}if(c&&!this.fieldData.show_empty)return $('<div style="display: none;" class="field" data-field-id="'+this.fieldData.id+'"></div>');c=d?$("<div></div>").append(e):$('<div class="field" data-field-id="'+this.fieldData.id+'"></div>').append(e);if("edit"==b){var f=d?$('<div class="value multifield-subfields-add-another"><span class="replace-me-with-value"></span></div>'):
a.wrapper('<span class="replace-me-with-value"></span>'),j=this;f.find(".replace-me-with-value").replaceWith($('<a href="javascript:void(0)" class="small inline-link"><b><i>'+$_("Add another")+"</i></b></a>").click(function(){var a=j.subfieldFactory.createEditor(this.contactType),d=j.subfieldEditors.length;val={value:a.getValue(),temp:!0};"undefined"!=typeof j.fieldData.ext&&(val.ext="");j.fieldValue[d]=val;j.subfieldEditors[d]=a;"null"!=j.currentMode&&a.setMode(j.currentMode);e.append(j.newSubFieldElement(b,
d));j.domElement.find(".delete-subfield").css("display","inline")}));c.append(f)}d&&(c=a.wrapper(c,this.fieldData.name+"").attr("data-field-id",this.fieldData.id));return c},setMode:function(b,a){"undefined"==typeof a&&(a=!0);if("view"!=b&&"edit"!=b)throw Error("Unknown mode: "+b);if(this.currentMode!=b){if("view"==b&&"edit"==this.currentMode&&this.origFieldValue)this.setValue(this.origFieldValue);else if("view"==this.currentMode&&!this.origFieldValue){this.origFieldValue=[];for(var d=0;d<this.fieldValue.length;d++)this.origFieldValue.push($.extend({},
this.fieldValue[d]))}this.currentMode=b;a&&(d=this.domElement,this.domElement=this.newFieldElement(b),null!==d&&d.replaceWith(this.domElement))}for(d=0;d<this.subfieldEditors.length;d++)this.subfieldEditors[d].setMode(b,!1);return this.domElement}});a.factoryTypes.Composite=$.extend({},a.baseFieldType,{subfieldEditors:null,initializeFactory:function(b,a){this.fieldData=b;if(this.fieldData.required){for(var d in this.fieldData.required)if(this.fieldData.required[d]){this.fieldData.required=!0;break}!0!==
this.fieldData.required&&(this.fieldData.required=!1)}this.options=a||{}},initialize:function(){var b={data:{},value:""};this.subfieldEditors={};this.fieldData.subfields=this.fieldData.fields;for(var e in this.fieldData.subfields){var d=$.extend({},a.factoryTypes[this.fieldData.subfields[e].type]),c=this.fieldData.fields[e];this.fieldData.required&&this.fieldData.required[e]&&(c.required=!0);c=$.extend({},c,{id:null,multi:!1});d.initializeFactory(c,this.options);d.parentEditor=this;d.parentEditorData=
{};d.initialize();d.parentEditorData.sfid=e;d.parentEditorData.parent=this;this.subfieldEditors[e]=d;b.data[e]=d.getValue()}this.fieldValue=b},setValue:function(b){if(b){this.fieldValue=b;for(var a in this.subfieldEditors){var d=this.subfieldEditors[a];"undefined"==typeof b.data?(d.initialize(),d.setValue(d.getValue())):"undefined"!=typeof b.data[a]?d.setValue(b.data[a]):d.setValue(d.getValue())}}},getValue:function(){if("null"==this.currentMode)return $.extend({},this.fieldValue.data);var b={},a;
for(a in this.subfieldEditors)b[a]=this.subfieldEditors[a].getValue();return b},isModified:function(){for(var b in this.subfieldEditors)if(this.subfieldEditors[b].isModified())return!0;return!1},validate:function(b){var a={},d=!1,c;for(c in this.subfieldEditors){var f=this.subfieldEditors[c].validate(b);f&&(a[c]=f,d=!0)}return!d?null:a},showValidationErrors:function(b){if(null!==this.domElement)for(var a in this.subfieldEditors){var c=this.subfieldEditors[a];null!==b&&"undefined"!=typeof b[a]?c.showValidationErrors(b[a]):
c.showValidationErrors(null)}},newInlineFieldElement:null,newFieldElement:function(b){this.fieldData.read_only&&(b="view");if("view"==b&&!this.fieldValue.value&&!this.fieldData.show_empty)return $('<div style="display: none;" class="field" data-field-id="'+this.fieldData.id+'"></div>');var c=$('<div class="composite '+b+' field" data-field-id="'+this.fieldData.id+'"></div>').append(a.wrapper('<span style="display:none" class="replace-with-ext"></span>',this.fieldData.name,"hdr")),d;for(d in this.subfieldEditors){var h=
this.subfieldEditors[d],f=h.newFieldElement(b);f.attr("data-field-id",d);f.data("fieldId",d);h.domElement=f;c.append(f)}return c},setMode:function(b,a){"undefined"==typeof a&&(a=!0);if("view"!=b&&"edit"!=b)throw Error("Unknown mode: "+b);if(this.currentMode!=b&&(this.currentMode=b,a)){var c=this.domElement;this.domElement=this.newFieldElement(b);null!==c&&c.replaceWith(this.domElement)}for(var h in this.subfieldEditors)this.subfieldEditors[h].setMode(b,!1);return this.domElement}});a.factoryTypes.Address=
$.extend({},a.factoryTypes.Composite,{showValidationErrors:function(b){if(null!==this.domElement&&(this.domElement.find("em.errormsg").remove(),this.domElement.find(".val").removeClass("error"),b))for(var a in this.subfieldEditors){var c=this.subfieldEditors[a];"undefined"!=typeof b[a]&&c.domElement.find(".val").addClass("error").parents(".address-subfield").append($('<em class="errormsg">'+b[a]+"</em>"))}},newInlineFieldElement:function(b){var a="";if("view"==b){if(!this.fieldValue.value)return null;
var c="",c="string"===typeof this.fieldValue.for_map?this.fieldValue.for_map:this.fieldValue.for_map.coords?this.fieldValue.for_map.coords:this.fieldValue.for_map.with_street;return a=$('<div class="address-field"></div>').append(this.fieldValue.value).append('<span style="display:none" class="replace-with-ext"></span> ').append('<a target="_blank" href="//maps.google.com/maps?q='+encodeURIComponent(c)+'&z=15" class="small map-link">'+$_("map")+"</a>")}b=$('<div class="address-field"></div>');b.append('<span style="display:none" class="replace-with-ext"></span>');
for(c in this.subfieldEditors){var a=this.subfieldEditors[c],h=a.newInlineFieldElement("edit");a.domElement=h;b.append($('<div class="address-subfield"></div>').append(h));"Hidden"!==a.fieldData.type&&h.find("input.val").attr("placeholder",a.fieldData.name+(a.fieldData.required?" ("+$_("required")+")":""))}return b}});a.factoryTypes.Birthday=a.factoryTypes.Date=$.extend({},a.baseFieldType,{newInlineFieldElement:function(a){if("view"==a&&!this.fieldValue.value)return null;var c=null,c=this.fieldValue.data||
{};if("edit"==a){for(var a=$('<select class="val" data-part="day"><option data=""></option></select>'),d=1;31>=d;d+=1){var h=$('<option data="'+d+'" value="'+d+'">'+d+"</option>");d==c.day&&h.attr("selected",!0);a.append(h)}for(var d=$('<select class="val" data-part="month"><option data=""></option></select>'),f="January February March April May June July August September October November December".split(" "),g=0;12>g;g+=1)h=$_(f[g]),h=$('<option data="'+(g+1)+'"  value="'+(g+1)+'">'+h+"</option>"),
g+1==c.month&&h.attr("selected",!0),d.append(h);h=$('<input type="text" data-part="year" class="val" style="min-width: 32px; width: 32px;" placeholder="'+$_("year")+'">');c.year&&h.val(c.year);c=$("<span></span>").append(a).append(" ").append(d).append(" ").append(h)}else c=$('<span class="val"></span>').text(this.fieldValue.value);return c},getValue:function(){var a=this.fieldValue;if("edit"==this.currentMode&&null!==this.domElement){var c=this.domElement.find(".val");0<c.length&&(a={value:{day:null,
month:null,year:null}},c.each(function(){var c=$(this),e=c.data("part");a.value[e]=parseInt(c.val(),10)||null}))}return a},setValue:function(a){this.fieldValue=a;"null"==this.currentMode||null===this.domElement||("edit"==this.currentMode?this.domElement.find(".val").each(function(){var c=$(this),d=c.data("part");c.val(a.data[d]||"")}):this.domElement.find(".val").html(this.fieldValue))}});a.factoryTypes.IM=$.extend({},a.baseFieldType,{setValue:function(a){"undefined"==typeof a&&(a="");"object"==typeof a?
(this.fieldValue=a.data,this.viewValue=a.value):this.fieldValue=this.viewValue=a;"null"!=this.currentMode&&this.domElement&&("edit"==this.currentMode?this.domElement.find("input.val").val(this.fieldValue):this.domElement.find(".val").html(this.viewValue))},newInlineFieldElement:function(a){if("view"==a&&!this.fieldValue)return null;var c=null;"edit"==a?(c=$('<span><input class="val" type="text"></span>'),c.find(".val").val(this.fieldValue)):c=$('<span class="val"></span>').html(this.viewValue);return c}});
a.factoryTypes.SocialNetwork=$.extend({},a.baseFieldType,{setValue:function(a){"undefined"==typeof a&&(a="");"object"==typeof a?(this.fieldValue=a.data,this.viewValue=a.value):this.fieldValue=this.viewValue=a;"null"!=this.currentMode&&this.domElement&&("edit"==this.currentMode?this.domElement.find("input.val").val(this.fieldValue):this.domElement.find(".val").html(this.viewValue))},newInlineFieldElement:function(a){if("view"==a&&!this.fieldValue)return null;var c=null;"edit"==a?(c=$('<span><input class="val" type="text"></span>'),
c.find(".val").val(this.fieldValue)):c=$('<span class="val"></span>').html(this.viewValue);return c}});a.factoryTypes.Url=$.extend({},a.factoryTypes.IM,{validate:function(a){var c=$.trim(this.getValue());if(!a&&this.fieldData.required&&!c)return $_("This field is required.");if(!c)return null;/^(https?|ftp|gopher|telnet|file|notes|ms-help)/.test(c)||(c="http://"+c,this.setValue(c));a=RegExp("^(https?|ftp|gopher|telnet|file|notes|ms-help):((//)|(\\\\\\\\))+[^`!\\[\\]{}'\"<>\u00ab\u00bb\u201c\u201d\u2018\u2019\\s]*$",
"i");return!a.test(c)||/^(http|ftp)/.test(c.toLowerCase())&&(a=RegExp("^(https?|ftp):((//)|(\\\\\\\\))+((?:[^`!()\\[\\]{};:'\".,<>?\u00ab\u00bb\u201c\u201d\u2018\u2019\\s+]+\\.)+[^`!()\\[\\]{};:'\".,<>?\u00ab\u00bb\u201c\u201d\u2018\u2019\\s+]{2,6})((/|\\\\|#)[^`!\\[\\]{}'\"<>\u00ab\u00bb\u201c\u201d\u2018\u2019\\s]*)?$","i"),!a.test(c))?$_("Incorrect URL format."):null}});a.factoryTypes.Email=$.extend({},a.factoryTypes.Url,{validate:function(a){var c=$.trim(this.getValue());return!a&&this.fieldData.required&&
!c?$_("This field is required."):!c?null:!/^([^@\s]+)@[^\s@]+\.[^\s@\.]{2,}$/i.test(c)?$_("Incorrect Email address format."):null}});a.factoryTypes.Checkbox=$.extend({},a.baseFieldType,{setValue:function(a){this.fieldValue=parseInt(a);"null"!=this.currentMode&&this.domElement&&("edit"==this.currentMode?this.domElement.find("input.val").attr("checked",!!this.fieldValue):this.domElement.find(".val").text(this.fieldValue?"Yes":"No"))},newInlineFieldElement:function(a){var c=null;"edit"==a?(c=$('<span><input class="val" type="checkbox" value="1" checked="checked"></span>'),
this.fieldValue||c.find(".val").removeAttr("checked")):c=$('<span class="val"></span>').text(this.fieldValue?"Yes":"No");return c}});a.factoryTypes.Number=$.extend({},a.baseFieldType,{validate:function(a){var c=$.trim(this.getValue());return!a&&this.fieldData.required&&!c&&0!==c?$_("This field is required."):c&&!/^-?[0-9]+([\.,][0-9]+$)?/.test(c)?$_("Must be a number."):null}});return c?a.factoryTypes[c]:a.factoryTypes};
$.wa.fieldTypeFactory=function(a){return $.extend({},$.wa.fieldTypesFactory(null,a))};$.wa.contactEditorFactory=function(a){var a=$.extend({contact_id:null,current_user_id:null,contactType:"person",baseFieldType:null,saveUrl:"?module=contacts&action=save",el:"#contact-info-block",with_inplace_buttons:!0,update_title:!0},a),c=$.extend({fields:{},fieldsOrder:[],factoryTypes:{},editorFactories:{},fieldEditors:{},initFactories:function(a,c){this.fields=a;this.fieldsOrder=c;this.editorFactories={};this.fieldEditors={};for(var d=0;d<c.length;d+=1){var h=c[d];if("object"!=typeof a[h]||!a[h].type)throw Error("Field data error for "+
h);if("undefined"==typeof this.factoryTypes[a[h].type])throw Error("Unknown factory type: "+a[h].type);this.editorFactories[h]=a[h].multi?$.extend({},this.factoryTypes.Multifield):$.extend({},this.factoryTypes[a[h].type]);this.editorFactories[h].initializeFactory(a[h])}},initAllEditors:function(){for(var a=0;a<this.fieldsOrder.length;a+=1){var c=this.fieldsOrder[a];"undefined"==typeof this.fieldEditors[c]?this.fieldEditors[c]=this.editorFactories[c].createEditor(this.contactType,c):this.fieldEditors[c].reinit()}},
initFieldEditors:function(a){if(!(a instanceof Array))for(var c=0;c<this.fieldsOrder.length;c+=1){var d=this.fieldsOrder[c];if("undefined"==typeof this.editorFactories[d]){$.wa.controller.contactAction([this.contact_id]);break}"undefined"==typeof this.fieldEditors[d]&&(this.fieldEditors[d]=this.editorFactories[d].createEditor(this.contactType));this.fieldEditors[d].setValue(a[d])}},initContactInfoBlock:function(a){this.switchMode(a,!0)},switchMode:function(a,c){var d=$(this.el),h=this;c&&(d.html(""),
d.removeClass("edit-mode"),d.removeClass("view-mode"),$(d).add("#contact-info-top").off("click.map",".map-link").on("click.map",".map-link",function(){var a=$(this).parent().data("subfield-index");void 0!==a&&h.geocodeAddress(h.fieldEditors.address.fieldValue,a)}));if(!("edit"==a&&d.hasClass("edit-mode"))&&!("view"==a&&d.hasClass("view-mode"))){$("#tc-contact").trigger("before_switch_mode");d.find("div.field.buttons").remove();for(var f=[],g=0;g<this.fieldsOrder.length;g+=1){var j=this.fieldsOrder[g];
f.push(j);var i=this.fieldEditors[j].setMode(a);$(this).trigger("set_mode",[{mode:a,el:d,field_id:j,field:this.fieldEditors[j]}]);c&&d.append(i)}var k=this;"edit"==a?(d.find(".subname").wrapAll('<div class="subname-wrapper"></div>'),d.find(".jobtitle-company").wrapAll('<div class="jobtitle-company-wrapper"></div>'),this.with_inplace_buttons&&(f=this.inplaceEditorButtons(f,function(a){if(typeof a!="undefined"&&!a)return false;if(typeof k.justCreated!="undefined"&&k.justCreated){a=$("#sb-all-contacts-li .count");
a.text(1+parseInt(a.text()));$.wa.setHash("/contact/"+k.contact_id);return false}k.switchMode("view");$.scrollTo(0);return false},function(){if(k.contact_id==null)$.wa.back();else{k.switchMode("view");$.scrollTo(0)}}),null===k.contact_id&&f.find(".cancel, .or").remove(),d.append(f),d.removeClass("view-mode"),d.addClass("edit-mode"),$("#edit-contact-double").hide(),d.find(".buttons").sticky({fixed_css:{bottom:0,background:"#fff",width:"100%",margin:"0"},fixed_class:"sticky-bottom",isStaticVisible:function(a){var b=
$(window),a=a.element.offset().top;return b.scrollTop()+b.height()>a}}),d.find(".sticky-bottom .cancel").click(function(){d.find(".buttons:not(.sticky-bottom) .cancel").click();return false}),d.find(".sticky-bottom :submit").click(function(){d.find(".buttons:not(.sticky-bottom) :submit").click();return false}))):(d.removeClass("edit-mode"),d.addClass("view-mode"),$("#edit-contact-double").show(),d.find(".subname-wrapper").length&&d.find(".subname").unwrap(),d.find(".jobtitle-company-wrapper").length&&
d.find(".jobtitle-company").unwrap());$("#tc-contact").trigger("after_switch_mode",[a,this])}},saveFields:function(a,c){if(!a){var a=[],d;for(d in this.fields)this.fields.hasOwnProperty(d)&&a.push(d)}var h={};d=!1;for(var f=0;f<a.length;f++){var g=a[f],j=this.fieldEditors[g].validate();if(j){if(!d)for(d=this.fieldEditors[g].domElement;!d.is(":visible");)d=d.parent();this.fieldEditors[g].showValidationErrors(j)}else this.fieldEditors[g].showValidationErrors(null);h[g]=this.fieldEditors[g].getValue()}if(d)$.scrollTo(d),
$.scrollTo("-=100px"),c(!1);else{var i=this,k=function(a){a=void 0===a?!0:a;$.post(i.saveUrl,{data:$.JSON.encode(h),type:i.contactType,id:null!=i.contact_id?i.contact_id:0},function(b){if("ok"!=b.status)throw new Exception("AJAX error: "+$.JSON.encode(b));b=b.data;b.history&&$.wa.history.updateHistory(b.history);if(b.data&&b.data.top){for(var d="",f=0;f<b.data.top.length;f++)var g=b.data.top[f],d=d+("<li>"+("im"!=g.id?g.icon?'<i class="icon16 '+g.id+'"></i>':"":"")+g.value+"</li>");$("#contact-info-top").html(d);
delete b.data.top}null!=i.contact_id&&i.initFieldEditors(b.data);d=!1;for(g in i.fieldEditors)if("undefined"!=typeof b.errors[g]){if(i.fieldEditors[g].showValidationErrors(b.errors[g]),!d)for(d=i.fieldEditors[g].domElement;!d.is(":visible");)d=d.parent()}else"edit"==i.fieldEditors[g].currentMode&&i.fieldEditors[g].showValidationErrors(null);if(d)$.scrollTo(d),$.scrollTo("-=100px");else if(i.contact_id&&b.data.reload){window.location.reload();return}if(d)c(!d);else if(null===i.contact_id&&(i.justCreated=
!0),i.contact_id=b.data.id,a)if(g=$.storage.get("contacts/last_geocoding")||0,3600<(new Date).getTime()-g)if($.storage.del("contacts/last_geocoding"),b=b.data.address,$.isEmptyObject(b))c(!d);else{for(var j=[],m=[],g=0;g<b.length;g+=1)j.push(i.sendGeocodeRequest(b[g].for_map)),m.push(g);var n=function(a,b){if(a.status==="OK"){var c=a.results[0].geometry.location.lng||"";h.address[b].value.lat=a.results[0].geometry.location.lat||"";h.address[b].value.lng=c}else a.status==="OVER_QUERY_LIMIT"&&$.storage.set("contacts/last_geocoding",
(new Date).getTime()/1E3)};$.when.apply($,j).then(function(){if(j.length<=1&&arguments[1]==="success")n(arguments[0],m[0]);else for(var a=0;a<arguments.length;a=a+1)arguments[a][1]==="success"&&n(arguments[a][0],m[a]);k.call(i,false)})}else c(!d);else c(!d)},"json")};k()}},createExtSelect:function(a,c){var d="",h=!0,f;for(f in a){var g="";if(a[f]===c||f===c)g=' selected="selected"',h=!1;var j=this.htmlentities(a[f]),d=d+('<option value="'+("undefined"===typeof a.length?f:j)+'"'+g+">"+j+"</option>")}var i;
h?(d+='<option value="%custom" selected="selected">'+$_("other")+"...</option>",i='<input type="text" class="small ext">'):(d+='<option value="%custom">'+$_("other")+"...</option>",i='<input type="text" class="small empty ext">');var d=$('<span><select class="ext">'+d+"</select><span>"+i+"</span></span>"),k=d.children("select");i=d.find("input");i.val(c);"%custom"!==k.val()&&i.hide();var c=$_("which?"),l=function(){if(!i.val()&&!i.hasClass("empty")){i.val(c);i.addClass("empty")}};i.blur(l);i.focus(function(){if(i.hasClass("empty")){i.val("");
i.removeClass("empty")}});k.change(function(){var a=k.val();if(a==="%custom"){i.hasClass("empty")&&i.val(c);i.show()}else{i.hide();i.addClass("empty");i.val(a||"")}l()});i[0].getExtValue=function(){return k.val()==="%custom"&&i.hasClass("empty")?"":i.val()};i[0].setExtValue=function(c){a[c]?k.val(c):k.val("%custom");i.val(c)};return d},inplaceEditorButtons:function(a,c,d){var h=$('<div class="field buttons"><div class="value submit"><em class="errormsg" id="validation-notice"></em></div></div>'),
f=this,g=function(){$(".buttons .loading").show();f.saveFields(a,function(a){$(".buttons .loading").hide();c(a)});return!1},j=$('#contact-info-block.edit-mode input[type="text"]',$("#c-core")[0]);j.die("keyup");j.live("keyup",function(a){13==a.keyCode&&(!$(a.currentTarget).data("autocomplete")||!$(a.currentTarget).data("contact_id"))&&g()});var j=$('<input type="submit" class="button green" value="'+$_("Save")+'" />').click(g),f=this,i=$('<a href="javascript:void(0)" class="cancel">'+$_("cancel")+
"</a>").click(function(){$(".buttons .loading").hide();"function"!=typeof d?c():d();f.fieldEditors.name.showValidationErrors(null);$.scrollTo(0);return!1});h.children("div.value.submit").append(j).append('<span class="or"> '+$_("or")+" </span>").append(i).append($('<i class="icon16 loading" style="margin-left: 16px; display: none;"></i>'));return h},destroy:function(){$(this.el).html("")},wrapper:function(a,c,d){d=$('<div class="field'+("undefined"!=typeof d&&d?" "+d:"")+'"></div>');"undefined"!=
typeof c&&c&&d.append('<div class="name">'+$.wa.encodeHTML(c)+"</div>");if("object"!=typeof a||!(a instanceof jQuery)||0>=a.find("div.value").size())a=$('<div class="value"></div>').append(a);d.append(a);return d},setOptions:function(b){this.options=$.extend(a,this.options||{},b)},htmlentities:function(a){var c=document.createElement("div"),a=document.createTextNode(a);c.appendChild(a);return c.innerHTML},addressToString:function(a){for(var c=[],d=["street","city","country","region","zip"],a=$.extend({},
a||{}),h=0;h<d.length;h+=1)c.push(a[d[h]]||""),delete a[d[h]];for(var f in a)a.hasOwnProperty(f)&&("lat"!==f&&"lng"!=f)&&c.push(a[f]);return c.join(",")},geocodeAddress:function(a,c){var d=this;if(!a[c].data.lat||!a[c].data.lng)this.sendGeocodeRequest(a[c].for_map||a[c].value,function(h){a[c].data.lat=h.lat;a[c].data.lng=h.lng;$.post("?module=contacts&action=saveGeocoords",{id:d.contact_id,lat:h.lat,lng:h.lng,sort:c})})},sendGeocodeRequest:function(a,c,d){var h=[];"string"===typeof a?h.push(a):a.with_street&&
a.without_street&&a.with_street===a.without_street?h.push(a.with_street):a.with_street&&h.push(a.with_street);1>=h.length&&void 0===d&&(d=!0);var f=$.Deferred(),g=this;$.ajax({url:"//maps.googleapis.com/maps/api/geocode/json",data:{sensor:!1,address:h[0]},dataType:"json",success:function(a){var b,k;if(a)if("OK"===a.status){b=a.results.length;var l=!1;for(k=0;k<b;k+=1)if(!a.results[k].partial_match){b=a.results[k].geometry.location.lat||"";k=a.results[k].geometry.location.lng||"";c instanceof Function&&
c({lat:b,lng:k});l=!0;break}l?f.resolve([a,"success"]):d?(b=a.results[0].geometry.location.lat||"",k=a.results[0].geometry.location.lng||"",c instanceof Function&&c({lat:b,lng:k}),f.resolve([a,"success"])):h[1]?g.sendGeocodeRequest(h[1],c,!0).always(function(a){f.resolve(a)}):f.resolve([a,"success"])}else f.resolve([a,"success"]);else f.resolve([{},"error"])},error:function(a){f.resolve([a,"error"])}});return f},switchToTab:function(a,c,d,h){"string"==typeof a&&("t-"==a.substr(0,2)?a="#"+a:"#"!=a[0]&&
(a="#t-"+a));a=$(a);if(!(0>=a.size()||a.hasClass("selected"))){if(!h){var f=a.attr("id");if(!f||"t-"!=f.substr(0,2))return;h=$("#tc-"+f.substr(2))}d&&(f=a.parent().children(".selected"),0<f.size()&&f.each(function(a,b){d.call(b)}));var g=function(){a.parent().find("li.selected").removeClass("selected");a.removeClass("hidden").css("display","").addClass("selected");h.siblings(".tab-content").addClass("hidden");h.removeClass("hidden");c&&c.call(a[0]);$("#c-info-tabs").trigger("after_switch_tab",[a])};
$("#c-info-tabs").trigger("before_switch_tab",[a]);$.effects&&$.effects.slideDIB&&!a.is(":visible")?($.wa.controller.loadTabSlidingAnimation(),a.hide().removeClass("hidden").show("slideDIB",{direction:"down"},300,function(){g()})):g()}},initCheckboxList:function(a){var a=$(a),c=function(a,b){var c=$(b||this);c.is(":checked")?c.parent().addClass("highlighted"):c.parent().removeClass("highlighted")};a.find('input[type="checkbox"]').click(c).each(c);return a},load:function(a,c,d,h,f){var g=Math.random(),
j=this;j.random=g;$.get(c,d,function(i){j.random==g&&(h&&h.call(j),$(window).trigger("wa_before_load",[a,c,d,i]),$(a).html(i),$(window).trigger("wa_after_load",[a,c,d,i]),f&&f.call(j))})}},a);$.wa.fieldTypesFactory(c);return c};$.wa.contactEditor=$.wa.contactEditorFactory();
