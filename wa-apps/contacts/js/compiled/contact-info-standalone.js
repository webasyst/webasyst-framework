$.wa.fieldTypesFactory=function(d,k){d=d||$.wa.contactEditorFactory();d.baseFieldType={contactType:"person",options:{},createEditor:function(a){this.contactType=a||"person";a=$.extend({},this);delete a.createEditor;delete a.initializeFactory;a.parentEditorData={};a.initialize();return a},fieldValue:"",initializeFactory:function(a,b){this.fieldData=a;this.options=b||{}},initialize:function(){this.setValue("")},reinit:function(){this.currentMode="null";this.initialize()},setValue:function(a){this.fieldValue=
a;"null"==this.currentMode||null===this.domElement||("edit"==this.currentMode?this.domElement.find(".val").val(this.fieldValue):this.domElement.find(".val").html(this.fieldValue))},getValue:function(){var a=this.fieldValue;if("edit"==this.currentMode&&null!==this.domElement){var b=this.domElement.find(".val");if(0<b.length&&(a="",!b.hasClass("empty")&&("checkbox"!=b.attr("type")||b.attr("checked"))))a=b.val()}return a},isModified:function(){return this.fieldValue!=this.getValue()},validate:function(a){var b=
this.getValue();return!a&&this.fieldData.required&&!b?$_("This field is required."):null},newFieldElement:function(a){this.fieldData.read_only&&(a="view");var b=this.newInlineFieldElement(a);if(null===b&&(!this.fieldData.show_empty||"edit"==a))return $('<div style="display: none" class="field" data-field-id="'+this.fieldData.id+'"></div>');var c;"person"===this.contactType?0<=["firstname","middlename","lastname"].indexOf(this.fieldData.id)?(c="subname",b.find(".val").attr("placeholder",this.fieldData.name)):
"title"===this.fieldData.id?(c="subname title",b.find(".val").attr("placeholder",this.fieldData.name)):"jobtitle"===this.fieldData.id?c="jobtitle-company jobtitle":"company"===this.fieldData.id&&(c="jobtitle-company company"):"company"===this.fieldData.id&&(c="company");return d.wrapper(b,this.fieldData.name+"",c).attr("data-field-id",this.fieldData.id)},newInlineFieldElement:function(a){if("view"==a&&!this.fieldValue)return null;var b=null;"edit"==a?(b=$('<span><input class="val" type="text"></span>'),
b.find(".val").val(this.fieldValue)):(b=$('<span class="val"></span>'),b.text(this.fieldValue));return b},showValidationErrors:function(a){if(null!==this.domElement){var b=this.domElement.find(".val");b.parents(".value").children("em.errormsg").remove();null!==a?(b.parents(".value").append($('<em class="errormsg">'+a+"</em>")),b.addClass("error")):b.removeClass("error")}},fieldData:null,domElement:null,currentMode:"null",parentEditor:null,parentEditorData:null,setMode:function(a,b){"undefined"==typeof b&&
(b=!0);if("view"!=a&&"edit"!=a)throw Error("Unknown mode: "+a);if(this.currentMode!=a&&(this.currentMode=a,b)){var c=this.domElement;this.domElement=this.newFieldElement(a);null!==c&&c.replaceWith(this.domElement)}return this.domElement}};d.factoryTypes.Hidden=$.extend({},d.baseFieldType,{newFieldElement:function(a){a=this.newInlineFieldElement(a);return d.wrapper(a,this.fieldData.name).attr("data-field-id",this.fieldData.id).hide()},newInlineFieldElement:function(a){if("view"==a&&!this.fieldValue)return null;
var b=null;"edit"==a&&(b=$('<span><input type="hidden" class="val" type="text"></span>'),b.find(".val").val(this.fieldValue));return b}});d.factoryTypes.String=$.extend({},d.baseFieldType,{setValue:function(a){this.fieldValue=a;"null"==this.currentMode||null===this.domElement||("edit"==this.currentMode?this.domElement.find(".val").val(this.fieldValue):this.domElement.find(".val").html(this.fieldValue))},getValue:function(){var a=this.fieldValue;if("edit"==this.currentMode&&null!==this.domElement){var b=
this.domElement.find(".val"),a="";b.hasClass("empty")||(a=b.val())}return a},newInlineFieldElement:function(a){if("view"==a&&!this.fieldValue)return null;var b=null,c=this.fieldValue;"edit"==a?(b=1>=this.fieldData.input_height?$('<span><input class="val" type="text"><i class="icon16 loading" style="display:none;"></i></span>'):$('<span><textarea class="val" rows="'+this.fieldData.input_height+'"></textarea></span>'),b.find(".val").val(c)):b=$('<span class="val"></span><i class="icon16 loading" style="display:none;">').text(c);
return b},setMode:function(a,b){"undefined"==typeof b&&(b=!0);if("view"!=a&&"edit"!=a)throw Error("Unknown mode: "+a);if(this.currentMode!=a&&(this.currentMode=a,b)){var c=this.domElement;this.domElement=this.newFieldElement(a);null!==c&&c.replaceWith(this.domElement)}return this.domElement}});d.factoryTypes.Text=$.extend({},d.factoryTypes.String);d.factoryTypes.Phone=$.extend({},d.baseFieldType);d.factoryTypes.Select=$.extend({},d.baseFieldType,{notSet:function(){return""},newInlineFieldElement:function(a){if("view"==
a&&!this.fieldValue)return null;if("view"==a)return $('<span class="val"></span>').text(this.fieldData.options[this.fieldValue]||this.fieldValue);for(var a="",b=!1,c,e=0;e<this.fieldData.oOrder.length;e++){var d=this.fieldData.oOrder[e];!b&&d==this.fieldValue&&this.fieldValue?(b=!0,c=" selected"):c="";""===d&&(c+=" disabled");a+='<option value="'+d+'"'+c+">"+$.wa.encodeHTML(this.fieldData.options[d])+"</option>"}return $('<div><select class="val '+(this.fieldData.type+"").toLowerCase()+'"><option value=""'+
(b?"":" selected")+">"+this.notSet()+"</option>"+a+"</select></div>")}});d.factoryTypes.Conditional=$.extend({},d.factoryTypes.Select,{unbindEventHandlers:function(){},getValue:function(){var a=this.fieldValue;if("edit"==this.currentMode&&null!==this.domElement){var b=this.domElement.find(".val:visible");0<b.length&&(a=b.hasClass("empty")?"":b.val())}return a},newInlineFieldElement:function(a){if("view"==a&&!this.fieldValue)return null;this.unbindEventHandlers();if("view"==a)return $("<div></div>").append($('<span class="val"></span>').text(this.fieldData.options&&
this.fieldData.options[this.fieldValue]||this.fieldValue));for(var b=this,a=(b.fieldData.parent_field||"").split(":"),c=d.fieldEditors[a.shift()];c&&a.length;){var e=c.subfieldEditors;if(e instanceof Array)for(var c=null,f=0;f<e.length;f++){if(e[f]===b.parentEditor){c=e[f];break}}else c=e[a.shift()]}if(c){var i=this.fieldData.options&&this.fieldData.options[this.fieldValue]||this.fieldValue,h=$('<input type="text" class="hidden val">').val(i),g=$('<select class="hidden val"></select>').hide(),j;setTimeout(function(){c.domElement?
(c.domElement.on("change",".val",j=function(){var a=$(this),c=h.is(":visible")?h.val():g.is(":visible")?g.val():i,a=(a.val()||"").toLowerCase();if(a=b.fieldData.parent_options[a]){h.hide();g.show().children().remove();for(f=0;f<a.length;f++)g.append($("<option></option>").attr("value",a[f]).text(a[f]).attr("selected",b.fieldValue==a[f]));g.val(c)}else h.val(c||"").show().blur(),g.hide()}),j.call(c.domElement.find(".val:visible")[0])):h.show()},0);b.unbindEventHandlers=function(){j&&c.domElement&&
c.domElement.find(".val").unbind("change",j);b.unbindEventHandlers=function(){}};return $("<div></div>").append(h).append(g)}return $("<div></div>").append($('<input type="text" class="val">').val(b.fieldValue))}});d.factoryTypes.Region=$.extend({},d.factoryTypes.Select,{notSet:function(){return""},unbindEventHandlers:function(){},setCurrentCountry:function(){var a=this.current_country;this.current_country=this.parentEditorData.parent.subfieldEditors.country.getValue();return a!==this.current_country?
(delete this.fieldData.options,!0):!1},getRegionsControllerUrl:function(a){return d.getRegionsUrl()+a},newInlineFieldElement:function(a){if("view"==a&&!this.fieldValue)return null;this.unbindEventHandlers();var b=this.options||{};void 0!==b.country&&(this.current_country=b.country);if("view"==a)return $("<div></div>").append($('<span class="val"></span>').text(this.fieldData.options&&this.fieldData.options[this.fieldValue]||this.fieldValue));var c=this;if(this.parentEditorData.parent&&this.parentEditorData.parent.subfieldEditors.country){this.setCurrentCountry();
var e;$(document).on("change","select.country",e=function(){if(c.setCurrentCountry()){var b="",e=c.domElement.find(".val"),b=e.is("input")?e.val().trim():e.find(":selected").text().trim(),d=function(a,b){var c=b.toLocaleLowerCase();a.find("option").each(function(){if($(this).text().trim().toLocaleLowerCase()===c){$(this).attr("selected",true);return false}})};c.domElement.empty().append(c.newInlineFieldElement(a).children());e=c.domElement.find(".val");e.is("input")&&!e.val()?e.val(b):e.is("select")&&
b?d(e,b):c.domElement.unbind("load.fieldTypes").bind("load.fieldTypes",function(){var a=c.domElement.find(".val");a.is("select")&&b&&d(a,b)})}});c.unbindEventHandlers=function(){$(document).off("change","select.country",e);c.unbindEventHandlers=function(){}}}if(!b.no_ajax_select&&void 0===this.fieldData.options&&this.current_country&&this.fieldData.region_countries[this.current_country]){var f=this.current_country;$.get(this.getRegionsControllerUrl(f),function(b){if(!(a!==c.currentMode||f!==c.current_country)){c.fieldData.options=
b.data.options||false;c.fieldData.oOrder=b.data.oOrder||[];$.isPlainObject(c.options)&&c.options.country!==void 0&&delete c.options.country;$("<div></div>").append(c.newInlineFieldElement(a).children());c.domElement.empty().append(c.newInlineFieldElement(a).children());c.domElement.trigger("load")}},"json");return $("<div></div>").append($('<i class="icon16 loading"></i>'))}if(this.fieldData.options)return $("<div></div>").append(d.factoryTypes.Select.newInlineFieldElement.call(this,a));b=$("<div></div>").append(d.baseFieldType.newInlineFieldElement.call(this,
a));b.find(".val").val("");b.find(".val").attr("placeholder",this.fieldData.name+(this.fieldData.required?" ("+$_("required")+")":""));return b}});d.factoryTypes.Country=$.extend({},d.factoryTypes.Select);d.factoryTypes.Checklist=$.extend({},d.baseFieldType,{validate:function(){return null},setValue:function(a){this.fieldValue=a;if("edit"==this.currentMode&&this.domElement){this.domElement.find('input[type="checkbox"]').attr("checked",!1);for(var b in this.fieldValue)this.domElement.find('input[type="checkbox"][value="'+
b+'"]').attr("checked",!0)}else"view"==this.currentMode&&this.domElement&&this.domElement.find(".val").html(this.getValueView())},getValue:function(){if("edit"!=this.currentMode||!this.domElement)return this.fieldValue;var a=[];this.domElement.find('input[type="checkbox"]:checked').each(function(b,c){a.push($(c).val())});return a},getValueView:function(){for(var a="",b=0;b<this.fieldData.oOrder.length;b++){var c=this.fieldData.oOrder[b];0>this.fieldValue.indexOf(c)||(a+=(a?", ":"")+'<a href="'+(this.fieldData.hrefPrefix||
"#")+c+'">'+(this.fieldData.options[c]&&d.htmlentities(this.fieldData.options[c])||$_("&lt;no name&gt;"))+"</a>")}return a||$_("&lt;none&gt;")},newInlineFieldElement:function(a){if("view"==a&&(!this.fieldValue||!this.fieldValue.length))return null;if("view"==a)return $('<span class="val"></span>').html(this.getValueView());var a=0,b;for(b in this.fieldData.options)if(a++,1<a)break;if(!a)return null;for(var a="",c=0;c<this.fieldData.oOrder.length;c++){b=this.fieldData.oOrder[c];a+='<li><label><input type="checkbox" value="'+
b+'"';this.fieldData.disabled&&this.fieldData.disabled[b]&&(a+=' disabled="disabled"');if(-1!==(this.fieldValue||[]).indexOf(b))a+=' checked="checked"';a+=" />"+(this.fieldData.options[b]&&d.htmlentities(this.fieldData.options[b])||$_("&lt;no name&gt;"))+"</label></li>"}return d.initCheckboxList('<div class="c-checkbox-menu-container val"><div><ul class="menu-v compact with-icons c-checkbox-menu">'+a+"</ul></div></div>")}});d.factoryTypes.Name=$.extend({},d.baseFieldType,{newInlineFieldElement:null,
newFieldElement:function(){return $('<div style="display: none;" class="field" data-field-id="'+this.fieldData.id+'"></div>')},setValue:function(a){this.fieldValue=a},getValue:function(a){if(this.fieldValue&&!a)return this.fieldValue;a=[];"person"==this.contactType?(d.fieldEditors.firstname&&a.push(d.fieldEditors.firstname.getValue()),d.fieldEditors.middlename&&a.push(d.fieldEditors.middlename.getValue()),d.fieldEditors.lastname&&a.push(d.fieldEditors.lastname.getValue())):d.fieldEditors.company&&
a.push(d.fieldEditors.company.getValue());return a.join(" ").trim()},validate:function(a){var b=this.getValue(!0);if(!a&&this.fieldData.required&&!b){a=$("#contact-info-block input:visible:text[value]:not(.empty)").val();if(!a)return $_("At least one of these fields must be filled");d.fieldEditors.firstname.setValue(a)}return null},showValidationErrors:function(a){var b=$("#contact-info-block");b.find("div.wa-errors-block").remove();if(null!==a){var c=$('<div class="field wa-errors-block"><div class="value"><em class="errormsg">'+
a+"</em></div></div>");d.fieldEditors.lastname?d.fieldEditors.lastname.domElement.after(c):b.prepend(c)}b=["firstname","middlename","lastname"];for(c=0;c<b.length;c++){var e=b[c];d.fieldEditors[e]&&(null!==a?d.fieldEditors[e].domElement.find(".val").addClass("external-error"):d.fieldEditors[e].domElement.find(".val").removeClass("external-error"))}},setMode:function(a,b){"undefined"==typeof b&&(b=!0);if("view"!=a&&"edit"!=a)throw Error("Unknown mode: "+a);if(this.currentMode!=a&&(this.currentMode=
a,b)){var c=this.domElement;this.domElement=this.newFieldElement(a);null!==c&&c.replaceWith(this.domElement)}var e="";d.fieldEditors.title&&(e=d.fieldEditors.title.getValue()+" ");if("view"===a&&!d.not_update_name){var c=$("#contact-fullname"),f="",i="",h="";if(d.fieldEditors.firstname){var g=d.fieldEditors.firstname.currentMode;d.fieldEditors.firstname.currentMode=a;f=d.fieldEditors.firstname.getValue();d.fieldEditors.firstname.currentMode=g}d.fieldEditors.middlename&&(g=d.fieldEditors.middlename.currentMode,
d.fieldEditors.middlename.currentMode=a,i=d.fieldEditors.middlename.getValue(),d.fieldEditors.middlename.currentMode=g);d.fieldEditors.lastname&&(g=d.fieldEditors.lastname.currentMode,d.fieldEditors.lastname.currentMode=a,h=d.fieldEditors.lastname.getValue(),d.fieldEditors.lastname.currentMode=g);(g=[f,i,h].join(" ").trim())||(g=this.fieldValue||"<"+$_("no name")+">");e=c.find("h1.name").html('<span class="title">'+$.wa.encodeHTML(e)+"</span>"+$.wa.encodeHTML(g));"person"===this.contactType&&(h=i=
f="",d.fieldEditors.jobtitle&&(g=d.fieldEditors.jobtitle.currentMode,d.fieldEditors.jobtitle.currentMode=a,i=d.fieldEditors.jobtitle.getValue(),d.fieldEditors.jobtitle.currentMode=g),d.fieldEditors.company&&(g=d.fieldEditors.company.currentMode,d.fieldEditors.company.currentMode=a,h=d.fieldEditors.company.getValue(),d.fieldEditors.company.currentMode=g),i&&(f+='<span class="title">'+$.wa.encodeHTML(i)+"</span> "),i&&h&&(f+='<span class="at">'+$_("@")+"</span> "),h&&(f+='<span class="company">'+$.wa.encodeHTML(h)+
"</span> "),c.find("h1.jobtitle-company").html(f));d.update_title&&$.wa.controller.setTitle(e.text())}d.contact_id&&d.contact_id==d.current_user_id&&$("#wa-my-username").text(""+(this.fieldValue?this.fieldValue:"<"+$_("no name")+">"));return this.domElement}});d.factoryTypes.NameSubfield=$.extend({},d.baseFieldType,{});d.factoryTypes.Multifield=$.extend({},d.baseFieldType,{subfieldEditors:null,subfieldFactory:null,emptySubValue:null,initializeFactory:function(a){this.fieldData=a;if("undefined"!=typeof this.fieldData.ext){this.fieldData.extKeys=
[];this.fieldData.extValues=[];for(var b in this.fieldData.ext)this.fieldData.extKeys[this.fieldData.extKeys.length]=b,this.fieldData.extValues[this.fieldData.extValues.length]=this.fieldData.ext[b]}},initialize:function(){this.subfieldFactory=$.extend({},d.factoryTypes[this.fieldData.type]);this.subfieldFactory.parentEditor=this;this.subfieldFactory.initializeFactory($.extend({},this.fieldData));this.fieldData=$.extend({},this.fieldData,{required:this.subfieldFactory.fieldData.required});this.subfieldEditors=
[this.subfieldFactory.createEditor(this.contactType)];this.emptySubValue="object"==typeof this.subfieldEditors[0].fieldValue?$.extend({},this.subfieldEditors[0].fieldValue):{value:this.subfieldEditors[0].fieldValue};this.fieldData.ext&&(this.emptySubValue.ext=this.fieldData.extKeys[0]);this.fieldValue=[this.emptySubValue]},setValue:function(a){if(!a||"undefined"==typeof a[0])a=[this.emptySubValue];this.fieldValue=a;var b=0;do{this.subfieldEditors.length<=b&&(this.subfieldEditors[b]=this.subfieldFactory.createEditor(this.contactType),
"null"!=this.currentMode&&this.subfieldEditors[b].setMode(this.currentMode).insertAfter(this.subfieldEditors[b-1].parentEditorData.domElement));if("undefined"!=typeof a[b]){var c=!1,e;for(e in a[b])if("value"!=e&&"ext"!=e){c=!0;break}this.subfieldEditors[b].setValue(c?a[b]:a[b].value?a[b].value:"");if("undefined"!=typeof this.fieldData.ext&&(c=a[b].ext,"null"!=this.currentMode&&this.subfieldEditors[b].parentEditorData.domElement)){var d=this.subfieldEditors[b].parentEditorData.domElement.find("input.ext");
0<d.size()&&d[0].setExtValue(c)}}else throw Error("At least one record must exist in data at this time.");b++}while(b<a.length);if(a.length<this.subfieldEditors.length){for(b=a.length;b<this.subfieldEditors.length;b++)0!==b&&"null"!=this.currentMode&&this.subfieldEditors[b].parentEditorData.domElement.remove();a=0<a.length?a.length:1;this.subfieldEditors.splice(a,this.subfieldEditors.length-a)}this.origFieldValue=null},getValue:function(){if("null"==this.currentMode)return $.extend({},this.fieldValue);
for(var a=[],b=0;b<this.subfieldEditors.length;b++){var c=this.subfieldEditors[b];a[b]={value:c.getValue()};if("undefined"!=typeof this.fieldData.ext){var e=this.fieldValue[b].ext,d=c.parentEditorData.domElement.find("input.ext")[0];"edit"==c.currentMode&&d&&(e=d.getExtValue());a[b].ext=e}}return a},isModified:function(){for(var a=0;a<this.subfieldEditors.length;a++)if(this.subfieldEditors[a].isModified())return!0;return!1},validate:function(a){for(var b=[],c=!0,e=0;e<this.subfieldEditors.length;e++){var d=
this.subfieldEditors[e],i=d.validate(!0);i&&(b[e]=i);if((d=d.getValue())||"string"!=typeof d)c=!1}!a&&(this.fieldData.required&&c)&&(b[0]="This field is required.");return 0>=b.length?null:b},showValidationErrors:function(a){for(var b=0;b<this.subfieldEditors.length;b++){var c=this.subfieldEditors[b];null!==a&&"undefined"!=typeof a[b]?c.showValidationErrors(a[b]):c.showValidationErrors(null)}},deleteSubfieldButton:function(a){var b=this,c=$('<a class="delete-subfield hint" href="javascript:void(0)">'+
$_("delete")+"</a>").click(function(){if(1>=b.subfieldEditors.length)return!1;var c=b.subfieldEditors.indexOf(a);"null"!=b.currentMode&&b.subfieldEditors[c].parentEditorData.domElement.remove();b.subfieldEditors.splice(c,1);1>=b.subfieldEditors.length&&b.domElement.find(".delete-subfield").hide();return!1});1>=this.subfieldEditors.length&&c.hide();return c},newSubFieldElement:function(a,b){var b=b-0,c=this.subfieldEditors[b];c.parentEditorData||(c.parentEditorData={});c.parentEditorData.parent=this;
c.parentEditorData.empty=!1;var e;if("function"!=typeof c.newInlineFieldElement){var f=d.wrapper('<span class="replace-me-with-value"></span>',0===b?this.fieldData.name+"":"","no-bot-margins"),i=f.find("span.replace-me-with-value");e=this.fieldValue[b].ext;"edit"==a?e=d.createExtSelect(this.fieldData.ext,e):(e=this.fieldData.ext[this.fieldValue[b].ext]||e,e=$("<strong>"+d.htmlentities(e)+"</strong>"));i.before(e);"edit"==a&&i.before(this.deleteSubfieldButton(c));i.remove();c.domElement=this.subfieldEditors[b].newFieldElement(a);
var h=this;c.domElement.find("div.name").each(function(a,b){if(b.innerHTML.substr(0,h.fieldData.name.length)===h.fieldData.name)b.innerHTML=""});c.parentEditorData.domElement=$("<div></div>").append(f).append(c.domElement);c.parentEditorData.empty="edit"==a?!1:!c.fieldValue.value&&!c.fieldData.show_empty;return c.parentEditorData.domElement}e=c.newInlineFieldElement(a);if(null===e)return c.parentEditorData.domElement=c.domElement=$("<div></div>"),c.parentEditorData.empty=!0,c.parentEditorData.domElement;
c.domElement=e;c.domElement.data("subfield-index",b).attr("data-subfield-index",b);f=$('<div class="value"></div>').append(e);i=f.find(".replace-with-ext");0>=i.size()&&(f.append('<span><span class="replace-with-ext"></span></span>'),i=f.find(".replace-with-ext"));"undefined"!=typeof this.fieldData.ext&&(e=this.fieldValue[b].ext,"edit"==a?i.before(d.createExtSelect(this.fieldData.ext,e)):(e=this.fieldData.ext[this.fieldValue[b].ext]||e,0<i.parents(".ext").size()?i.before(d.htmlentities(e)):i.before($('<em class="hint"></em>').text(" "+
e))));"edit"==a&&i.before(this.deleteSubfieldButton(c));i.remove();return c.parentEditorData.domElement=f},newInlineFieldElement:null,newFieldElement:function(a){this.fieldData.read_only&&(a="view");for(var b=$('<div class="multifield-subfields"></div>'),c="function"==typeof this.subfieldFactory.newInlineFieldElement,e=!0,f=0;f<this.subfieldEditors.length;f++){var i=this.newSubFieldElement(a,f);b.append(i);e=e&&this.subfieldEditors[f].parentEditorData.empty}if(e&&!this.fieldData.show_empty)return $('<div style="display: none;" class="field" data-field-id="'+
this.fieldData.id+'"></div>');e=c?$("<div></div>").append(b):$('<div class="field" data-field-id="'+this.fieldData.id+'"></div>').append(b);if("edit"==a){var f=c?$('<div class="value multifield-subfields-add-another"><span class="replace-me-with-value"></span></div>'):d.wrapper('<span class="replace-me-with-value"></span>'),h=this;f.find(".replace-me-with-value").replaceWith($('<a href="javascript:void(0)" class="small inline-link"><b><i>'+$_("Add another")+"</i></b></a>").click(function(){var c=
h.subfieldFactory.createEditor(this.contactType),e=h.subfieldEditors.length;val={value:c.getValue(),temp:!0};"undefined"!=typeof h.fieldData.ext&&(val.ext="");h.fieldValue[e]=val;h.subfieldEditors[e]=c;"null"!=h.currentMode&&c.setMode(h.currentMode);b.append(h.newSubFieldElement(a,e));h.domElement.find(".delete-subfield").css("display","inline")}));e.append(f)}c&&(e=d.wrapper(e,this.fieldData.name+"").attr("data-field-id",this.fieldData.id));return e},setMode:function(a,b){"undefined"==typeof b&&
(b=!0);if("view"!=a&&"edit"!=a)throw Error("Unknown mode: "+a);if(this.currentMode!=a){if("view"==a&&"edit"==this.currentMode&&this.origFieldValue)this.setValue(this.origFieldValue);else if("view"==this.currentMode&&!this.origFieldValue){this.origFieldValue=[];for(var c=0;c<this.fieldValue.length;c++)this.origFieldValue.push($.extend({},this.fieldValue[c]))}this.currentMode=a;b&&(c=this.domElement,this.domElement=this.newFieldElement(a),null!==c&&c.replaceWith(this.domElement))}for(c=0;c<this.subfieldEditors.length;c++)this.subfieldEditors[c].setMode(a,
!1);return this.domElement}});d.factoryTypes.Composite=$.extend({},d.baseFieldType,{subfieldEditors:null,initializeFactory:function(a,b){this.fieldData=a;if(this.fieldData.required){for(var c in this.fieldData.required)if(this.fieldData.required[c]){this.fieldData.required=!0;break}!0!==this.fieldData.required&&(this.fieldData.required=!1)}this.options=b||{}},initialize:function(){var a={data:{},value:""};this.subfieldEditors={};this.fieldData.subfields=this.fieldData.fields;for(var b in this.fieldData.subfields){var c=
$.extend({},d.factoryTypes[this.fieldData.subfields[b].type]),e=this.fieldData.fields[b];this.fieldData.required&&this.fieldData.required[b]&&(e.required=!0);e=$.extend({},e,{id:null,multi:!1});c.initializeFactory(e,this.options);c.parentEditor=this;c.parentEditorData={};c.initialize();c.parentEditorData.sfid=b;c.parentEditorData.parent=this;this.subfieldEditors[b]=c;a.data[b]=c.getValue()}this.fieldValue=a},setValue:function(a){if(a){this.fieldValue=a;for(var b in this.subfieldEditors){var c=this.subfieldEditors[b];
"undefined"==typeof a.data?(c.initialize(),c.setValue(c.getValue())):"undefined"!=typeof a.data[b]?c.setValue(a.data[b]):c.setValue(c.getValue())}}},getValue:function(){if("null"==this.currentMode)return $.extend({},this.fieldValue.data);var a={},b;for(b in this.subfieldEditors)a[b]=this.subfieldEditors[b].getValue();return a},isModified:function(){for(var a in this.subfieldEditors)if(this.subfieldEditors[a].isModified())return!0;return!1},validate:function(a){var b={},c=!1,e;for(e in this.subfieldEditors){var d=
this.subfieldEditors[e].validate(a);d&&(b[e]=d,c=!0)}return!c?null:b},showValidationErrors:function(a){if(null!==this.domElement)for(var b in this.subfieldEditors){var c=this.subfieldEditors[b];null!==a&&"undefined"!=typeof a[b]?c.showValidationErrors(a[b]):c.showValidationErrors(null)}},newInlineFieldElement:null,newFieldElement:function(a){this.fieldData.read_only&&(a="view");if("view"==a&&!this.fieldValue.value&&!this.fieldData.show_empty)return $('<div style="display: none;" class="field" data-field-id="'+
this.fieldData.id+'"></div>');var b=$('<div class="composite '+a+' field" data-field-id="'+this.fieldData.id+'"></div>').append(d.wrapper('<span style="display:none" class="replace-with-ext"></span>',this.fieldData.name,"hdr")),c;for(c in this.subfieldEditors){var e=this.subfieldEditors[c],f=e.newFieldElement(a);f.attr("data-field-id",c);f.data("fieldId",c);e.domElement=f;b.append(f)}return b},setMode:function(a,b){"undefined"==typeof b&&(b=!0);if("view"!=a&&"edit"!=a)throw Error("Unknown mode: "+
a);if(this.currentMode!=a&&(this.currentMode=a,b)){var c=this.domElement;this.domElement=this.newFieldElement(a);null!==c&&c.replaceWith(this.domElement)}for(var e in this.subfieldEditors)this.subfieldEditors[e].setMode(a,!1);return this.domElement}});d.factoryTypes.Address=$.extend({},d.factoryTypes.Composite,{showValidationErrors:function(a){if(null!==this.domElement&&(this.domElement.find("em.errormsg").remove(),this.domElement.find(".val").removeClass("error"),a))for(var b in this.subfieldEditors){var c=
this.subfieldEditors[b];"undefined"!=typeof a[b]&&c.domElement.find(".val").addClass("error").parents(".address-subfield").append($('<em class="errormsg">'+a[b]+"</em>"))}},newInlineFieldElement:function(a){var b="";if("view"==a){if(!this.fieldValue.value)return null;var c="",c="string"===typeof this.fieldValue.for_map?this.fieldValue.for_map:this.fieldValue.for_map.coords?this.fieldValue.for_map.coords:this.fieldValue.for_map.with_street;return b=$('<div class="address-field"></div>').append(this.fieldValue.value).append('<span style="display:none" class="replace-with-ext"></span> ').append('<a target="_blank" href="//maps.google.com/maps?q='+
encodeURIComponent(c)+'&z=15" class="small map-link">'+$_("map")+"</a>")}a=$('<div class="address-field"></div>');a.append('<span style="display:none" class="replace-with-ext"></span>');for(c in this.subfieldEditors){var b=this.subfieldEditors[c],e=b.newInlineFieldElement("edit");b.domElement=e;a.append($('<div class="address-subfield"></div>').append(e));"Hidden"!==b.fieldData.type&&e.find("input.val").attr("placeholder",b.fieldData.name+(b.fieldData.required?" ("+$_("required")+")":""))}return a}});
d.factoryTypes.Birthday=d.factoryTypes.Date=$.extend({},d.baseFieldType,{newInlineFieldElement:function(a){if("view"==a&&!this.fieldValue.value)return null;var b=null,b=this.fieldValue.data||{};if("edit"==a){for(var a=$('<select class="val" data-part="day"><option data=""></option></select>'),c=1;31>=c;c+=1){var e=$('<option data="'+c+'" value="'+c+'">'+c+"</option>");c==b.day&&e.attr("selected",!0);a.append(e)}for(var c=$('<select class="val" data-part="month"><option data=""></option></select>'),
d="January February March April May June July August September October November December".split(" "),i=0;12>i;i+=1)e=$_(d[i]),e=$('<option data="'+(i+1)+'"  value="'+(i+1)+'">'+e+"</option>"),i+1==b.month&&e.attr("selected",!0),c.append(e);e=$('<input type="text" data-part="year" class="val" style="min-width: 32px; width: 32px;" placeholder="'+$_("year")+'">');b.year&&e.val(b.year);b=$("<span></span>").append(a).append(" ").append(c).append(" ").append(e)}else b=$('<span class="val"></span>').text(this.fieldValue.value);
return b},getValue:function(){var a=this.fieldValue;if("edit"==this.currentMode&&null!==this.domElement){var b=this.domElement.find(".val");0<b.length&&(a={value:{day:null,month:null,year:null}},b.each(function(){var b=$(this),e=b.data("part");a.value[e]=parseInt(b.val(),10)||null}))}return a},setValue:function(a){this.fieldValue=a;"null"==this.currentMode||null===this.domElement||("edit"==this.currentMode?this.domElement.find(".val").each(function(){var b=$(this),c=b.data("part");b.val(a.data[c]||
"")}):this.domElement.find(".val").html(this.fieldValue))}});d.factoryTypes.IM=$.extend({},d.baseFieldType,{setValue:function(a){"undefined"==typeof a&&(a="");"object"==typeof a?(this.fieldValue=a.data,this.viewValue=a.value):this.fieldValue=this.viewValue=a;"null"!=this.currentMode&&this.domElement&&("edit"==this.currentMode?this.domElement.find("input.val").val(this.fieldValue):this.domElement.find(".val").html(this.viewValue))},newInlineFieldElement:function(a){if("view"==a&&!this.fieldValue)return null;
var b=null;"edit"==a?(b=$('<span><input class="val" type="text"></span>'),b.find(".val").val(this.fieldValue)):b=$('<span class="val"></span>').html(this.viewValue);return b}});d.factoryTypes.SocialNetwork=$.extend({},d.baseFieldType,{setValue:function(a){"undefined"==typeof a&&(a="");"object"==typeof a?(this.fieldValue=a.data,this.viewValue=a.value):this.fieldValue=this.viewValue=a;"null"!=this.currentMode&&this.domElement&&("edit"==this.currentMode?this.domElement.find("input.val").val(this.fieldValue):
this.domElement.find(".val").html(this.viewValue))},newInlineFieldElement:function(a){if("view"==a&&!this.fieldValue)return null;var b=null;"edit"==a?(b=$('<span><input class="val" type="text"></span>'),b.find(".val").val(this.fieldValue)):b=$('<span class="val"></span>').html(this.viewValue);return b}});d.factoryTypes.Url=$.extend({},d.factoryTypes.IM,{validate:function(a){var b=$.trim(this.getValue());if(!a&&this.fieldData.required&&!b)return $_("This field is required.");if(!b)return null;/^(https?|ftp|gopher|telnet|file|notes|ms-help)/.test(b)||
(b="http://"+b,this.setValue(b));a=RegExp("^(https?|ftp|gopher|telnet|file|notes|ms-help):((//)|(\\\\\\\\))+[^`!\\[\\]{}'\"<>\u00ab\u00bb\u201c\u201d\u2018\u2019\\s]*$","i");return!a.test(b)||/^(http|ftp)/.test(b.toLowerCase())&&(a=RegExp("^(https?|ftp):((//)|(\\\\\\\\))+((?:[^`!()\\[\\]{};:'\".,<>?\u00ab\u00bb\u201c\u201d\u2018\u2019\\s+]+\\.)+[^`!()\\[\\]{};:'\".,<>?\u00ab\u00bb\u201c\u201d\u2018\u2019\\s+]{2,6})((/|\\\\|#)[^`!\\[\\]{}'\"<>\u00ab\u00bb\u201c\u201d\u2018\u2019\\s]*)?$","i"),!a.test(b))?
$_("Incorrect URL format."):null}});d.factoryTypes.Email=$.extend({},d.factoryTypes.Url,{validate:function(a){var b=$.trim(this.getValue());return!a&&this.fieldData.required&&!b?$_("This field is required."):!b?null:!/^([^@\s]+)@[^\s@]+\.[^\s@\.]{2,}$/i.test(b)?$_("Incorrect Email address format."):null}});d.factoryTypes.Checkbox=$.extend({},d.baseFieldType,{setValue:function(a){this.fieldValue=parseInt(a);"null"!=this.currentMode&&this.domElement&&("edit"==this.currentMode?this.domElement.find("input.val").attr("checked",
!!this.fieldValue):this.domElement.find(".val").text(this.fieldValue?"Yes":"No"))},newInlineFieldElement:function(a){var b=null;"edit"==a?(b=$('<span><input class="val" type="checkbox" value="1" checked="checked"></span>'),this.fieldValue||b.find(".val").removeAttr("checked")):b=$('<span class="val"></span>').text(this.fieldValue?"Yes":"No");return b}});d.factoryTypes.Number=$.extend({},d.baseFieldType,{validate:function(a){var b=$.trim(this.getValue());return!a&&this.fieldData.required&&!b&&0!==
b?$_("This field is required."):b&&!/^-?[0-9]+([\.,][0-9]+$)?/.test(b)?$_("Must be a number."):null}});return k?d.factoryTypes[k]:d.factoryTypes};$.wa.fieldTypeFactory=function(d){return $.extend({},$.wa.fieldTypesFactory(null,d))};$.wa.contactEditorFactory=function(d){var d=$.extend({contact_id:null,current_user_id:null,contactType:"person",baseFieldType:null,saveUrl:"?module=contacts&action=save",saveGeocoordsUrl:"?module=contacts&action=saveGeocoords",regionsUrl:"?module=backend&action=regions&country=",el:"#contact-info-block",with_inplace_buttons:!0,update_title:!0},d),k=$.extend({wa_app_url:"",fields:{},fieldsOrder:[],fieldsValues:{},factoryTypes:{},editorFactories:{},fieldEditors:{},initFactories:function(a,b){this.fields=
a;this.fieldsOrder=b;this.editorFactories={};this.fieldEditors={};for(var c=0;c<b.length;c+=1){var e=b[c];if("object"!=typeof a[e]||!a[e].type)throw Error("Field data error for "+e);if("undefined"==typeof this.factoryTypes[a[e].type])throw Error("Unknown factory type: "+a[e].type);this.editorFactories[e]=a[e].multi?$.extend({},this.factoryTypes.Multifield):$.extend({},this.factoryTypes[a[e].type]);this.editorFactories[e].initializeFactory(a[e])}},initAllEditors:function(){for(var a=0;a<this.fieldsOrder.length;a+=
1){var b=this.fieldsOrder[a];"undefined"==typeof this.fieldEditors[b]?this.fieldEditors[b]=this.editorFactories[b].createEditor(this.contactType,b):this.fieldEditors[b].reinit()}},initFieldEditors:function(a){if(!(a instanceof Array)){this.fieldsValues=a;for(var b=0;b<this.fieldsOrder.length;b+=1){var c=this.fieldsOrder[b];if("undefined"==typeof this.editorFactories[c]){$.wa.controller.contactAction([this.contact_id]);break}"undefined"==typeof this.fieldEditors[c]&&(this.fieldEditors[c]=this.editorFactories[c].createEditor(this.contactType));
this.fieldEditors[c].setValue(a[c])}}},initContactInfoBlock:function(a){this.switchMode(a,!0)},_getUrl:function(a){return"string"===typeof this[a]?this.saveUrl.slice(0,this.wa_app_url.length)!==this.wa_app_url?this.wa_app_url+this[a]:this.saveUrl:""},getSaveUrl:function(){return this._getUrl("saveUrl")},getSaveGeocoordsUrl:function(){return this._getUrl("saveGeocoordsUrl")},getPasswdSaveUrl:function(){return this._getUrl("passwdSaveUrl")},getRegionsUrl:function(){return this._getUrl("regionsUrl")},
switchMode:function(a,b){var c=$(this.el),e=this;b&&(c.html(""),c.removeClass("edit-mode"),c.removeClass("view-mode"),$(c).add("#contact-info-top").off("click.map",".map-link").on("click.map",".map-link",function(){var a=$(this).parent().data("subfield-index");void 0!==a&&e.geocodeAddress(e.fieldEditors.address.fieldValue,a)}));if(!("edit"==a&&c.hasClass("edit-mode"))&&!("view"==a&&c.hasClass("view-mode"))){$("#tc-contact").trigger("before_switch_mode");c.find("div.field.buttons").remove();for(var d=
[],i=0;i<this.fieldsOrder.length;i+=1){var h=this.fieldsOrder[i];d.push(h);var g=this.fieldEditors[h].setMode(a);$(this).trigger("set_mode",[{mode:a,el:c,field_id:h,field:this.fieldEditors[h]}]);b&&c.append(g)}var j=this;"edit"==a?(c.find(".subname").wrapAll('<div class="subname-wrapper"></div>'),c.find(".jobtitle-company").wrapAll('<div class="jobtitle-company-wrapper"></div>'),this.with_inplace_buttons&&(d=this.inplaceEditorButtons(d,function(a){if(typeof a!="undefined"&&!a)return false;if(typeof j.justCreated!=
"undefined"&&j.justCreated){a=$("#sb-all-contacts-li .count");a.text(1+parseInt(a.text()));$.wa.setHash("/contact/"+j.contact_id);return false}j.switchMode("view");$.scrollTo(0);return false},function(){if(j.contact_id==null)$.wa.back();else{j.switchMode("view");$.scrollTo(0)}}),null===j.contact_id&&d.find(".cancel, .or").remove(),c.append(d),c.removeClass("view-mode"),c.addClass("edit-mode"),$("#edit-contact-double").hide(),c.find(".buttons").sticky({fixed_css:{bottom:0,background:"#fff",width:"100%",
margin:"0"},fixed_class:"sticky-bottom",isStaticVisible:function(a){var b=$(window),a=a.element.offset().top;return b.scrollTop()+b.height()>a}}),c.find(".sticky-bottom .cancel").click(function(){c.find(".buttons:not(.sticky-bottom) .cancel").click();return false}),c.find(".sticky-bottom :submit").click(function(){c.find(".buttons:not(.sticky-bottom) :submit").click();return false}))):(c.removeClass("edit-mode"),c.addClass("view-mode"),$("#edit-contact-double").show(),c.find(".subname-wrapper").length&&
c.find(".subname").unwrap(),c.find(".jobtitle-company-wrapper").length&&c.find(".jobtitle-company").unwrap());$("#tc-contact").trigger("after_switch_mode",[a,this])}},saveFields:function(a,b){if(!a){var a=[],c;for(c in this.fields)this.fields.hasOwnProperty(c)&&a.push(c)}var e={};c=!1;for(var d=0;d<a.length;d++){var i=a[d],h=this.fieldEditors[i].validate();if(h){if(!c)for(c=this.fieldEditors[i].domElement;!c.is(":visible");)c=c.parent();this.fieldEditors[i].showValidationErrors(h)}else this.fieldEditors[i].showValidationErrors(null);
e[i]=this.fieldEditors[i].getValue()}if(c)$.scrollTo(c),$.scrollTo("-=100px"),b(!1);else{var g=this,j=function(a){a=void 0===a?!0:a;$.post(g.getSaveUrl(),{data:$.JSON.encode(e),type:g.contactType,id:null!=g.contact_id?g.contact_id:0},function(c){if("ok"!=c.status)throw new Exception("AJAX error: "+$.JSON.encode(c));c=c.data;c.history&&$.wa.history.updateHistory(c.history);if(c.data&&c.data.top){for(var d="",f=0;f<c.data.top.length;f++)var h=c.data.top[f],d=d+("<li>"+("im"!=h.id?h.icon?'<i class="icon16 '+
h.id+'"></i>':"":"")+h.value+"</li>");$("#contact-info-top").html(d);delete c.data.top}d=g.fieldsValues||{};null!=g.contact_id&&g.initFieldEditors(c.data);f=!1;for(h in g.fieldEditors)if("undefined"!=typeof c.errors[h]){if(g.fieldEditors[h].showValidationErrors(c.errors[h]),!f)for(f=g.fieldEditors[h].domElement;!f.is(":visible");)f=f.parent()}else"edit"==g.fieldEditors[h].currentMode&&g.fieldEditors[h].showValidationErrors(null);if(f)$.scrollTo(f),$.scrollTo("-=100px");else if(g.contact_id&&c.data.reload){window.location.reload();
return}if(f)b(!f);else if(null===g.contact_id&&(g.justCreated=!0),g.contact_id=c.data.id,a)if(h=$.storage.get("contacts/last_geocoding")||0,3600<(new Date).getTime()-h)if($.storage.del("contacts/last_geocoding"),c=c.data.address,$.isEmptyObject(c))b(!f);else{for(var i=[],k=[],h=0;h<c.length;h+=1){var l=!0;if(e.address[h]){a:{for(var l=c[h].data,o=(d.address[h]||{}).data||{},n=["city","country","region","street","zip"],m=0;m<n.length;m+=1)if(l[n[m]]&&o[n[m]]&&l[n[m]]!=o[n[m]]){l=!1;break a}l=!0}l=
!l}l&&(i.push(g.sendGeocodeRequest(c[h].for_map)),k.push(h))}if(i.length){var p=function(a,b){if(a.status==="OK"){var c=a.results[0].geometry.location.lng||"";e.address[b].value.lat=a.results[0].geometry.location.lat||"";e.address[b].value.lng=c}else a.status==="OVER_QUERY_LIMIT"&&$.storage.set("contacts/last_geocoding",(new Date).getTime()/1E3)};$.when.apply($,i).then(function(){if(i.length<=1&&arguments[1]==="success")p(arguments[0],k[0]);else for(var a=0;a<arguments.length;a=a+1)arguments[a][1]===
"success"&&p(arguments[a][0],k[a]);j.call(g,false)})}else b(!f)}else b(!f);else b(!f)},"json")};j()}},createExtSelect:function(a,b){var c="",e=!0,d;for(d in a){var i="";if(a[d]===b||d===b)i=' selected="selected"',e=!1;var h=this.htmlentities(a[d]),c=c+('<option value="'+("undefined"===typeof a.length?d:h)+'"'+i+">"+h+"</option>")}var g;e?(c+='<option value="%custom" selected="selected">'+$_("other")+"...</option>",g='<input type="text" class="small ext">'):(c+='<option value="%custom">'+$_("other")+
"...</option>",g='<input type="text" class="small empty ext">');var c=$('<span><select class="ext">'+c+"</select><span>"+g+"</span></span>"),j=c.children("select");g=c.find("input");g.val(b);"%custom"!==j.val()&&g.hide();var b=$_("which?"),k=function(){if(!g.val()&&!g.hasClass("empty")){g.val(b);g.addClass("empty")}};g.blur(k);g.focus(function(){if(g.hasClass("empty")){g.val("");g.removeClass("empty")}});j.change(function(){var a=j.val();if(a==="%custom"){g.hasClass("empty")&&g.val(b);g.show()}else{g.hide();
g.addClass("empty");g.val(a||"")}k()});g[0].getExtValue=function(){return j.val()==="%custom"&&g.hasClass("empty")?"":g.val()};g[0].setExtValue=function(b){a[b]?j.val(b):j.val("%custom");g.val(b)};return c},inplaceEditorButtons:function(a,b,c){var d=$('<div class="field buttons"><div class="value submit"><em class="errormsg" id="validation-notice"></em></div></div>'),f=this,i=function(){$(".buttons .loading").show();f.saveFields(a,function(a){$(".buttons .loading").hide();b(a)});return!1},h=$('#contact-info-block.edit-mode input[type="text"]',
$("#c-core")[0]);h.die("keyup");h.live("keyup",function(a){13==a.keyCode&&(!$(a.currentTarget).data("autocomplete")||!$(a.currentTarget).data("contact_id"))&&i()});var h=$('<input type="submit" class="button green" value="'+$_("Save")+'" />').click(i),f=this,g=$('<a href="javascript:void(0)" class="cancel">'+$_("cancel")+"</a>").click(function(){$(".buttons .loading").hide();"function"!=typeof c?b():c();f.fieldEditors.name.showValidationErrors(null);$.scrollTo(0);return!1});d.children("div.value.submit").append(h).append('<span class="or"> '+
$_("or")+" </span>").append(g).append($('<i class="icon16 loading" style="margin-left: 16px; display: none;"></i>'));return d},destroy:function(){$(this.el).html("")},wrapper:function(a,b,c){c=$('<div class="field'+("undefined"!=typeof c&&c?" "+c:"")+'"></div>');"undefined"!=typeof b&&b&&c.append('<div class="name">'+$.wa.encodeHTML(b)+"</div>");if("object"!=typeof a||!(a instanceof jQuery)||0>=a.find("div.value").size())a=$('<div class="value"></div>').append(a);c.append(a);return c},setOptions:function(a){this.options=
$.extend(d,this.options||{},a)},htmlentities:function(a){var b=document.createElement("div"),a=document.createTextNode(a);b.appendChild(a);return b.innerHTML},addressToString:function(a){for(var b=[],c=["street","city","country","region","zip"],a=$.extend({},a||{}),d=0;d<c.length;d+=1)b.push(a[c[d]]||""),delete a[c[d]];for(var f in a)a.hasOwnProperty(f)&&("lat"!==f&&"lng"!=f)&&b.push(a[f]);return b.join(",")},geocodeAddress:function(a,b){var c=this;if(!a[b].data.lat||!a[b].data.lng)this.sendGeocodeRequest(a[b].for_map||
a[b].value,function(d){a[b].data.lat=d.lat;a[b].data.lng=d.lng;$.post(c.getSaveGeocoordsUrl(),{id:c.contact_id,lat:d.lat,lng:d.lng,sort:b})})},sendGeocodeRequest:function(a,b,c){var d=[];"string"===typeof a?d.push(a):a.with_street&&a.without_street&&a.with_street===a.without_street?d.push(a.with_street):(a.with_street&&d.push(a.with_street),a.without_street&&d.push(a.without_street));var c=!0,f=$.Deferred(),i=this;$.ajax({url:"//maps.googleapis.com/maps/api/geocode/json",data:{sensor:!1,address:d[0]},
dataType:"json",success:function(a){var g,j;if(a)if(a.status==="OK"){g=a.results.length;var k=false;for(j=0;j<g;j=j+1)if(!a.results[j].partial_match){g=a.results[j].geometry.location.lat||"";j=a.results[j].geometry.location.lng||"";b instanceof Function&&b({lat:g,lng:j});k=true;break}if(k)f.resolve([a,"success"]);else if(c){g=a.results[0].geometry.location.lat||"";j=a.results[0].geometry.location.lng||"";b instanceof Function&&b({lat:g,lng:j});f.resolve([a,"success"])}else d[1]?i.sendGeocodeRequest(d[1],
b,true).always(function(a){f.resolve(a)}):f.resolve([a,"success"])}else f.resolve([a,"success"]);else f.resolve([{},"error"])},error:function(a){f.resolve([a,"error"])}});return f},switchToTab:function(a,b,c,d){"string"==typeof a&&("t-"==a.substr(0,2)?a="#"+a:"#"!=a[0]&&(a="#t-"+a));a=$(a);if(!(0>=a.size()||a.hasClass("selected"))){if(!d){var f=a.attr("id");if(!f||"t-"!=f.substr(0,2))return;d=$("#tc-"+f.substr(2))}c&&(f=a.parent().children(".selected"),0<f.size()&&f.each(function(a,b){c.call(b)}));
var i=function(){a.parent().find("li.selected").removeClass("selected");a.removeClass("hidden").css("display","").addClass("selected");d.siblings(".tab-content").addClass("hidden");d.removeClass("hidden");b&&b.call(a[0]);$("#c-info-tabs").trigger("after_switch_tab",[a])};$("#c-info-tabs").trigger("before_switch_tab",[a]);$.effects&&$.effects.slideDIB&&!a.is(":visible")?($.wa.controller.loadTabSlidingAnimation(),a.hide().removeClass("hidden").show("slideDIB",{direction:"down"},300,function(){i()})):
i()}},initCheckboxList:function(a){var a=$(a),b=function(a,b){var d=$(b||this);d.is(":checked")?d.parent().addClass("highlighted"):d.parent().removeClass("highlighted")};a.find('input[type="checkbox"]').click(b).each(b);return a},load:function(a,b,c,d,f){var i=Math.random(),h=this;h.random=i;$.get(b,c,function(g){h.random==i&&(d&&d.call(h),$(window).trigger("wa_before_load",[a,b,c,g]),$(a).html(g),$(window).trigger("wa_after_load",[a,b,c,g]),f&&f.call(h))})}},d);$.wa.fieldTypesFactory(k);return k};
$.wa.contactEditor=$.wa.contactEditorFactory();
